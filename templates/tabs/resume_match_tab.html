<div class="flex flex-col gap-6 w-full min-h-[600px] md:flex-row">
    <!-- Left: Resume Match Upload Area -->
    <div class="flex flex-col gap-4 flex-none w-full md:w-1/2">
        <div class="bg-white/60 backdrop-blur-sm border border-blue-200/60 rounded-xl p-4 md:p-6 shadow-sm animate-fade-in mt-2 hover:shadow-xl transition-all duration-300 group">
            <!-- Job Description Upload -->
            <div class="border border-blue-100 rounded-lg bg-blue-50/60 p-3 mb-3 resume-section-hover resume-jobdesc-section">
                <div class="flex items-center mb-1">
                    <i data-lucide="file-text" class="w-5 h-5 text-blue-400 mr-2"></i>
                    <span class="text-base md:text-lg font-bold text-gray-800">Job Description</span>
                </div>
                <div class="text-xs md:text-sm text-blue-400 mb-2">Upload your job requirements or paste description</div>
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 mb-1">
                    <label class="custom-file-upload py-1 px-2 text-xs md:text-sm w-full sm:w-auto">
                        <i data-lucide="file-text"></i>
                        <span>Choose File</span>
                        <input type="file" id="jobDocxUpload" accept=".docx" class="file-upload-input w-full" data-file-name-id="jobDocxUploadName" onchange="updateFileNameDisplay(this)">
                    </label>
                    <span class="file-name text-xs md:text-sm" id="jobDocxUploadName">No file chosen</span>
                </div>
                <select id="savedDescriptions" class="w-full mb-1 p-1 border border-gray-300 rounded text-xs hidden"></select>
                <textarea id="job_description" name="job_description" class="modern-textarea w-full p-2 border border-gray-300 rounded-md shadow-sm text-xs md:text-sm" rows="3" placeholder="Or paste job description here..."></textarea>
                <p id="job_description_error" class="text-red-500 text-xs mt-1 hidden animate-shake">Job Description is required when no job requirement file is selected.</p>
            </div>
            <!-- Resume Upload -->
            <div class="border border-teal-200 rounded-lg bg-teal-50/60 p-3 mb-3 resume-section-hover resume-upload-section">
                <div class="flex items-center mb-1">
                    <i data-lucide="upload" class="w-5 h-5 text-gray-500 mr-2"></i>
                    <span class="text-base md:text-lg font-bold text-gray-800">Upload Resume</span>
                </div>
                <div class="text-xs md:text-sm text-gray-500 mb-2">Upload candidate resumes for analysis (optional if job requirement is selected)</div>
                <div id="resume-inputs-container" class="max-h-32 overflow-y-auto mb-1">
                    <div id="resume-inputs">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center mb-1 resume-input-row gap-2">
                            <label class="custom-file-upload py-1 px-2 text-xs md:text-sm w-full sm:w-auto">
                                <i data-lucide="file-text"></i>
                                <span>Choose File</span>
                                <input type="file" name="resume" accept=".pdf,.docx" class="file-upload-input resume-file w-full" data-file-name-id="resumeFileName0" onchange="updateFileNameDisplay(this)">
                            </label>
                            <span class="file-name text-xs md:text-sm" id="resumeFileName0">No file chosen</span>
                            <button type="button" class="ml-2 remove-resume-btn hidden" tabindex="-1"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button>
                        </div>
                    </div>
                </div>
                <button type="button" id="add-resume-btn" class="w-full sm:w-fit flex items-center justify-center gap-1 py-1 px-2 my-2 border border-blue-100 rounded bg-white text-blue-600 hover:bg-blue-50 hover:text-blue-800 font-semibold text-xs md:text-sm transition-all duration-200 min-w-0" style="font-size:11px;">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i>
                    Add another resume
                </button>
                <p id="resume_error" class="text-red-500 text-xs mt-1 hidden animate-shake">At least one resume file is required when no job requirement is selected.</p>
            </div>
            <!-- Job Requirement Dropdown (now below resume upload) -->
            <div class="border border-purple-100 rounded-lg bg-purple-50/40 p-3 mb-1">
                <label for="job-requirement-dropdown" class="font-semibold text-gray-700 mb-1 text-xs md:text-sm">Select Job Requirement (Admin Uploaded)</label>
                <select id="job-requirement-dropdown" class="w-full p-1 border border-gray-300 rounded text-xs md:text-sm">
                    <option value="">-- Select a job requirement --</option>
                </select>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 text-xs md:text-sm mt-3" id="analyze-resume-btn">Analyze</button>
        </div>
    </div>
    <!-- Right: Resume Match Analysis Result and Technical Proficiency Analysis -->
    <div class="flex-1 flex flex-col gap-6 h-full w-full">
        <!-- Resume Match Analysis Results -->
        <div class="w-full pl-0 mt-0 flex flex-col">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 header-gradient m-0">Analysis Results</h2>
                <div id="unified-action-btns" class="flex flex-col sm:flex-row gap-4 hidden">
                    <button id="unified-save-btn" type="button" class="pill-btn pill-btn-green" title="Save all available analyses">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                        </svg>
                        <span class="pill-btn-text">Save</span>
                    </button>
                    <button id="unified-shortlist-btn" type="button" class="pill-btn pill-btn-orange" title="Shortlist the resume">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <polygon points="12 17.27 18.18 21 16.54 13.97 22 9.24 14.81 8.63 12 2 9.19 8.63 2 9.24 7.46 13.97 5.82 21 12 17.27"/>
                        </svg>
                        <span class="pill-btn-text">Shortlist</span>
                    </button>
                </div>
            </div>
            <!-- Loader under Analysis Results -->
            <div id="loader-resume" class="text-center p-4 md:p-8 hidden flex-1 flex items-center justify-center">
                <div role="status" class="flex flex-col items-center justify-center">
                    <svg aria-hidden="true" class="inline w-10 h-10 text-blue-400 animate-spin drop-shadow-lg" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="50" cy="50" r="45" stroke="#3B82F6" stroke-width="10" fill="none" opacity="0.2"/>
                        <path d="M50 15a35 35 0 1 1-24.75 10.25" stroke="#2563EB" stroke-width="10" stroke-linecap="round" fill="none"/>
                    </svg>
                    <span class="sr-only">Loading...</span>
                </div>
                <p class="mt-4 text-blue-600 font-semibold animate-pulse">Analyzing... Please wait.</p>
            </div>
            <!-- Compact Technical Proficiency Actions (hidden by default) -->
            <div id="compact-tech-actions" class="flex flex-wrap gap-2 mb-4 hidden">
                <button type="button" id="compact-audio-btn" class="btn-compact" title="Upload Interview Audio"><i data-lucide="mic"></i></button>
                <input type="file" id="audio" name="audio" accept=".mp3,.mp4,.wav" style="display:none" onchange="document.getElementById('audioFileName').textContent = this.files[0]?.name || 'No file chosen'">
                <span class="file-name text-xs text-gray-600" id="audioFileName">No file chosen</span>
                <button type="button" id="compact-tech-resume-btn" class="btn-compact" title="Upload Resume"><i data-lucide="file-text"></i></button>
                <input type="file" id="tech_resume" name="tech_resume" accept=".pdf,.docx" style="display:none" onchange="document.getElementById('techResumeFileName').textContent = this.files[0]?.name || 'No file chosen'">
                <span class="file-name text-xs text-gray-600" id="techResumeFileName">No file chosen</span>
                <select id="techQuestionsDropdown" class="btn-compact-select" title="Select technical questions file">
                    <option value="">Select technical questions...</option>
                </select>
                <input type="hidden" id="tech_questions" name="tech_questions">
                <select id="compact-technology" class="btn-compact-select" title="Select Primary Technology">
                    <option value="">Tech</option>
                    <option value="General">General</option>
                    <option value="Python">Python</option>
                    <option value="Java">Java</option>
                    <option value="JavaScript">JavaScript</option>
                    <option value="Dotnet">Dotnet</option>
                    <option value="Machine Learning">Machine Learning</option>
                    <option value="DevOps">DevOps</option>
                </select>
                <button type="submit" id="analyze-technical-btn" class="btn-compact-analyze" title="Analyze Candidate"><i data-lucide="search"></i></button>
            </div>
            <div id="tech-errors-container" class="w-full text-left mb-2">
                <!-- Error messages will be injected here -->
            </div>
            <div id="results-resume" class="flex flex-col min-h-0 overflow-x-auto">
                <div id="meta_info_resume" class="mb-4 text-gray-700"></div>
                <div class="flex flex-col">
                    <div id="resume_result_card_resume" class="bg-white/80 backdrop-blur-sm border border-gray-200/60 rounded-xl p-4 md:p-6 shadow-lg flex flex-col min-h-0">
                        <div id="placeholder-resume" class="text-gray-400 text-center py-8 md:py-16 flex items-center justify-center">
                            <div class="text-center">
                                <i data-lucide="file-text" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                                <p class="text-lg font-medium">No analysis yet</p>
                                <p class="text-sm">Please upload files and click <b>Analyze</b> to get started.</p>
                            </div>
                        </div>
                        <div id="resume_result_resume" class="overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Technical Proficiency Analysis Results -->
        <div class="w-full pl-0 mt-0 flex flex-col">
            <h2 class="text-xl md:text-2xl font-bold mb-4 text-gray-800 header-gradient">Technical Proficiency Analysis Results</h2>
            <!-- Loader under Analysis Results -->
            <div id="loader-audio" class="text-center p-4 md:p-8 hidden flex items-center justify-center">
                <div role="status" class="flex flex-col items-center justify-center">
                    <svg aria-hidden="true" class="inline w-10 h-10 text-blue-400 animate-spin drop-shadow-lg" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="50" cy="50" r="45" stroke="#3B82F6" stroke-width="10" fill="none" opacity="0.2"/>
                        <path d="M50 15a35 35 0 1 1-24.75 10.25" stroke="#2563EB" stroke-width="10" stroke-linecap="round" fill="none"/>
                    </svg>
                    <span class="sr-only">Loading...</span>
                </div>
                <p class="mt-4 text-blue-600 font-semibold animate-pulse">Analyzing... Please wait.</p>
            </div>
            <div id="results-audio" class="flex flex-col min-h-0 overflow-x-auto">
                <div id="meta_info_audio" class="mb-4 text-gray-700"></div>
                <div class="flex flex-col">
                    <div id="audio_result_card_audio" class="bg-white/80 backdrop-blur-sm border border-gray-200/60 rounded-xl p-4 md:p-6 shadow-lg flex flex-col min-h-0">
                        <div id="placeholder-audio" class="text-gray-400 text-center py-8 md:py-16 flex items-center justify-center">
                            <div class="text-center">
                                <i data-lucide="mic" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
                                <p class="text-lg font-medium">No analysis yet</p>
                                <p class="text-sm">Please upload files and click <b>Analyze Candidate</b> to get started.</p>
                            </div>
                        </div>
                        <div id="audio_result_audio" class="overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Global state management for unified save/shortlist
window.analysisState = {
    resumeSaved: false,
    technicalSaved: false,
    resumeShortlisted: false,
    technicalShortlisted: false,
    resumeResult: null,
    technicalResult: null
};

function updateUnifiedButtons() {
    const saveBtn = document.getElementById('unified-save-btn');
    const shortlistBtn = document.getElementById('unified-shortlist-btn');
    
    if (!saveBtn || !shortlistBtn) return;
    
    // Check if we have technical results (this is the requirement)
    const hasTechnicalResult = window.analysisState.technicalResult !== null;
    
    // Also check if there are visible technical results in the DOM
    const audioResultDiv = document.getElementById('audio_result_audio');
    const hasVisibleAudioResults = audioResultDiv && audioResultDiv.innerHTML.trim() && 
                                  !audioResultDiv.innerHTML.includes('No analysis yet');
    
    // Only show buttons if we have technical analysis results
    if (!hasTechnicalResult && !hasVisibleAudioResults) {
        // No technical results yet, hide buttons
        document.getElementById('unified-action-btns').classList.add('hidden');
        return;
    }
    
    // Show buttons only after technical analysis
    document.getElementById('unified-action-btns').classList.remove('hidden');
    
    // Update save button
    if (window.analysisState.resumeSaved && window.analysisState.technicalSaved) {
        saveBtn.innerHTML = '<i data-lucide="save" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Saved';
        saveBtn.classList.remove('pill-btn-green', 'pill-btn-green:hover:not(:disabled)');
        saveBtn.classList.add('pill-btn-green', 'pill-btn-green:disabled');
        saveBtn.disabled = true;
    } else if (hasTechnicalResult) {
        saveBtn.innerHTML = '<i data-lucide="save" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Save';
        saveBtn.classList.remove('pill-btn-green:disabled', 'pill-btn-green:disabled');
        saveBtn.classList.add('pill-btn-green', 'pill-btn-green:hover:not(:disabled)');
        saveBtn.disabled = false;
    }
    
    // Update shortlist button
    if (window.analysisState.resumeShortlisted && window.analysisState.technicalShortlisted) {
        shortlistBtn.innerHTML = '<i data-lucide="star" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Shortlisted';
        shortlistBtn.classList.remove('pill-btn-orange', 'pill-btn-orange:hover:not(:disabled)');
        shortlistBtn.classList.add('pill-btn-orange', 'pill-btn-orange:disabled');
        shortlistBtn.disabled = true;
    } else if (hasTechnicalResult) {
        shortlistBtn.innerHTML = '<i data-lucide="star" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Shortlist Resume';
        shortlistBtn.classList.remove('pill-btn-orange:disabled', 'pill-btn-orange:disabled');
        shortlistBtn.classList.add('pill-btn-orange', 'pill-btn-orange:hover:not(:disabled)');
        shortlistBtn.disabled = false;
    }
    
    // Re-render icons
    if (window.lucide && window.lucide.createIcons) {
        lucide.createIcons();
    }
}

function resetAnalysisState() {
    window.analysisState = {
        resumeSaved: false,
        technicalSaved: false,
        resumeShortlisted: false,
        technicalShortlisted: false,
        resumeResult: null,
        technicalResult: null
    };
    updateUnifiedButtons();
}

function clearAnalysisState() {
    window.analysisState = {
        resumeSaved: false,
        technicalSaved: false,
        resumeShortlisted: false,
        technicalShortlisted: false,
        resumeResult: null,
        technicalResult: null
    };
    updateUnifiedButtons();
}

function updateFileNameDisplay(input) {
    const fileNameId = input.getAttribute('data-file-name-id');
    if (fileNameId) {
        const fileNameSpan = document.getElementById(fileNameId);
        if (fileNameSpan) {
            fileNameSpan.textContent = input.files[0]?.name || 'No file chosen';
        }
    }
}

// Fetch and populate job requirements dropdown
function populateJobRequirementDropdown() {
  fetch('/job-requirements')
    .then(response => response.json())
    .then(data => {
      const dropdown = document.getElementById('job-requirement-dropdown');
      if (data.status === 'success' && data.files.length > 0) {
        data.files.forEach(file => {
          const option = document.createElement('option');
          option.value = file.filename; // Use filename as value
          option.textContent = file.job_title || file.filename;
          dropdown.appendChild(option);
        });
      }
    })
    .catch(err => {
      // Optionally handle error
    });
}

// Fetch and populate technical questions dropdown from admin-uploaded files
function populateTechQuestionsDropdown() {
  fetch('/list_iqg_files')
    .then(response => response.json())
    .then(data => {
      const dropdown = document.getElementById('techQuestionsDropdown');
      dropdown.innerHTML = '<option value="">Select technical questions...</option>';
      if (data.files && data.files.length > 0) {
        data.files.forEach(file => {
          const option = document.createElement('option');
          option.value = file.id;
          option.textContent = file.original_filename || file.filename;
          dropdown.appendChild(option);
        });
      }
    })
    .catch(err => {
      // Optionally handle error
    });
}

// Add validation logic for the form
function validateResumeForm() {
    const jobDesc = document.getElementById('job_description').value.trim();
    const jobRequirementId = document.getElementById('job-requirement-dropdown').value;
    const resumeFiles = document.querySelectorAll('.resume-file');
    let hasResumeFiles = false;
    
    resumeFiles.forEach(input => {
        if (input.files && input.files.length > 0) {
            hasResumeFiles = true;
        }
    });
    
    // Clear previous errors
    document.getElementById('job_description_error').classList.add('hidden');
    document.getElementById('resume_error').classList.add('hidden');
    
    let isValid = true;
    
    // If no job requirement is selected, we need either job description or resume files
    if (!jobRequirementId) {
        if (!jobDesc && !hasResumeFiles) {
            document.getElementById('job_description_error').classList.remove('hidden');
            document.getElementById('resume_error').classList.remove('hidden');
            isValid = false;
        } else if (!jobDesc) {
            document.getElementById('job_description_error').classList.remove('hidden');
            isValid = false;
        } else if (!hasResumeFiles) {
            document.getElementById('resume_error').classList.remove('hidden');
            isValid = false;
        }
    }
    
    return isValid;
}

// Add event listeners for real-time validation
document.addEventListener('DOMContentLoaded', function() {
    populateJobRequirementDropdown();
    
    // Check if there are existing results and restore state
    function restoreAnalysisState() {
        const resumeResultDiv = document.getElementById('resume_result_resume');
        const audioResultDiv = document.getElementById('audio_result_audio');
        
        // Check if we have resume results
        if (resumeResultDiv && resumeResultDiv.innerHTML.trim() && 
            !resumeResultDiv.innerHTML.includes('No analysis yet')) {
            // We have resume results, restore state
            if (!window.analysisState.resumeResult) {
                window.analysisState.resumeResult = latestResumeResult || {};
            }
        }
        
        // Check if we have technical results
        if (audioResultDiv && audioResultDiv.innerHTML.trim() && 
            !audioResultDiv.innerHTML.includes('No analysis yet')) {
            // We have technical results, restore state
            if (!window.analysisState.technicalResult) {
                window.analysisState.technicalResult = latestTechnicalResult || {};
            }
        }
        
        // Update buttons only if we have technical results
        if (window.analysisState.technicalResult) {
            updateUnifiedButtons();
        }
    }
    
    // Restore state on page load
    restoreAnalysisState();
    
    // Add validation on dropdown change
    document.getElementById('job-requirement-dropdown').addEventListener('change', function() {
        validateResumeForm();
    });
    
    // Add validation on job description change
    document.getElementById('job_description').addEventListener('input', function() {
        validateResumeForm();
    });
    
    // Add validation on resume file change
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('resume-file')) {
            validateResumeForm();
        }
    });

    // Synchronize first resume file between Resume Matcher and Technical Proficiency sections (one-time sync only)
    const resumeMatcherInput = document.querySelector('.resume-file');
    const techResumeInput = document.getElementById('tech_resume');
    const resumeMatcherFileName = document.getElementById('resumeFileName0');
    const techResumeFileName = document.getElementById('techResumeFileName');

    function setFileInput(input, file) {
        if (!file) return;
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        input.files = dataTransfer.files;
        input.dispatchEvent(new Event('change', { bubbles: true }));
    }

    // Only sync if the other input is empty
    resumeMatcherInput.addEventListener('change', function() {
        if (resumeMatcherInput.files && resumeMatcherInput.files.length > 0) {
            const file = resumeMatcherInput.files[0];
            if (!techResumeInput.files || techResumeInput.files.length === 0) {
                setFileInput(techResumeInput, file);
                techResumeFileName.textContent = file.name;
            }
        } else {
            // If cleared, clear the other as well only if it is also empty
            if (!techResumeInput.files || techResumeInput.files.length === 0) {
                techResumeInput.value = '';
                techResumeFileName.textContent = 'No file chosen';
            }
        }
    });

    techResumeInput.addEventListener('change', function() {
        if (techResumeInput.files && techResumeInput.files.length > 0) {
            const file = techResumeInput.files[0];
            if (!resumeMatcherInput.files || resumeMatcherInput.files.length === 0) {
                setFileInput(resumeMatcherInput, file);
                resumeMatcherFileName.textContent = file.name;
            }
        } else {
            // If cleared, clear the other as well only if it is also empty
            if (!resumeMatcherInput.files || resumeMatcherInput.files.length === 0) {
                resumeMatcherInput.value = '';
                resumeMatcherFileName.textContent = 'No file chosen';
            }
        }
    });

    populateTechQuestionsDropdown();
    // Set hidden input value on dropdown change
    const techQuestionsDropdown = document.getElementById('techQuestionsDropdown');
    if (techQuestionsDropdown) {
      techQuestionsDropdown.addEventListener('change', function() {
        const selectedId = this.value;
        if (!selectedId) {
          document.getElementById('tech_questions').value = '';
          return;
        }
        // Fetch the file content from the backend
        fetch(`/get_iqg_file/${selectedId}`)
          .then(response => response.json())
          .then(data => {
            document.getElementById('tech_questions').value = data.content || '';
          })
          .catch(() => {
            document.getElementById('tech_questions').value = '';
            alert('Failed to load technical questions file.');
          });
      });
    }

    // Unified Save Button Event Listener
    // This button always saves ALL available analyses (resume + technical) when clicked
    const unifiedSaveBtn = document.getElementById('unified-save-btn');
    if (unifiedSaveBtn) {
        unifiedSaveBtn.addEventListener('click', async function() {
            const hasResumeResult = window.analysisState.resumeResult !== null;
            const hasTechnicalResult = window.analysisState.technicalResult !== null;
            
            // Only proceed if we have technical results
            if (!hasTechnicalResult) return;
            
            try {
                unifiedSaveBtn.disabled = true;
                unifiedSaveBtn.innerHTML = '<i data-lucide="save" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Saving...';
                
                // Always prepare data for both analyses if available
                let resumeHTML = '';
                let audioHTML = '';
                let metaInfo = '';
                let technology = '';
                let audioFileName = '';
                
                // Always include resume data if available
                if (hasResumeResult) {
                    const resumeResultDiv = document.getElementById('resume_result_resume');
                    const blocks = resumeResultDiv.querySelectorAll('div.mb-4');
                    if (blocks.length > 0) {
                        resumeHTML = Array.from(blocks).map(b => b.outerHTML).join('');
                    } else {
                        resumeHTML = resumeResultDiv.innerHTML;
                    }
                }
                
                // Always include technical data if available
                if (hasTechnicalResult) {
                    const audioResultDiv = document.getElementById('audio_result_audio');
                    audioHTML = audioResultDiv.innerHTML;
                    
                    const techInput = document.getElementById('technology') || document.getElementById('compact-technology');
                    if (techInput) technology = techInput.value;
                    
                    const audioInput = document.getElementById('audio');
                    if (audioInput && audioInput.files && audioInput.files.length > 0) {
                        audioFileName = audioInput.files[0].name;
                    }
                }
                
                const timestamp = new Date().toLocaleString();
                const data = {
                    resumeHTML,
                    audioHTML,
                    metaInfo,
                    timestamp,
                    technology,
                    audioFileName,
                    rawData: {
                        resume: window.analysisState.resumeResult,
                        technical: window.analysisState.technicalResult
                    }
                };
                
                // Check if we have a saved analysis ID
                let savedId = window.analysisState.savedAnalysisId;
                let response, result;
                if (savedId) {
                    // Update existing analysis
                    response = await fetch(`/update_analysis/${savedId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    result = await response.json();
                } else {
                    // Create new analysis
                    response = await fetch('/save_analysis', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    result = await response.json();
                }
                if (result.status === 'success') {
                    // Mark both as saved (even if only one was available)
                    window.analysisState.resumeSaved = true;
                    window.analysisState.technicalSaved = true;
                    window.analysisState.savedAnalysisId = result.id;
                    updateUnifiedButtons();
                    
                    // Show appropriate success message
                    if (hasResumeResult && hasTechnicalResult) {
                        showToast('Both analyses saved successfully!', 'success');
                    } else if (hasResumeResult) {
                        showToast('Resume analysis saved successfully!', 'success');
                    } else if (hasTechnicalResult) {
                        showToast('Technical analysis saved successfully!', 'success');
                    }
                    
                    if (typeof renderUserRecentActivity === 'function') renderUserRecentActivity();
                } else {
                    unifiedSaveBtn.disabled = false;
                    unifiedSaveBtn.innerHTML = '<i data-lucide="save" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Save';
                    showToast('Failed to save analysis.', 'error');
                }
            } catch (err) {
                unifiedSaveBtn.disabled = false;
                unifiedSaveBtn.innerHTML = '<i data-lucide="save" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Save';
                showToast('Error saving analysis.', 'error');
            }
        });
    }

    // Unified Shortlist Button Event Listener
    const unifiedShortlistBtn = document.getElementById('unified-shortlist-btn');
    if (unifiedShortlistBtn) {
        unifiedShortlistBtn.addEventListener('click', async function() {
            const hasResumeResult = window.analysisState.resumeResult !== null;
            const hasTechnicalResult = window.analysisState.technicalResult !== null;
            
            // Only proceed if we have technical results
            if (!hasTechnicalResult) return;
            
            try {
                unifiedShortlistBtn.disabled = true;
                unifiedShortlistBtn.innerHTML = '<i data-lucide="star" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Shortlisting...';
                
                let formData = new FormData();
                let timestamp = new Date().toLocaleString();
                let found = false;
                let matchPercent = 0;
                
                // Get resume file for shortlisting
                const resumeInputs = document.querySelectorAll('.resume-file');
                resumeInputs.forEach(input => {
                    if (input.files && input.files.length > 0 && !found) {
                        formData.append('shortlist_resume', input.files[0]);
                        found = true;
                    }
                });
                
                // Calculate match percentage
                if (hasResumeResult && window.analysisState.resumeResult && Array.isArray(window.analysisState.resumeResult.resumes) && window.analysisState.resumeResult.resumes.length > 0) {
                    matchPercent = window.analysisState.resumeResult.resumes[0].match_percentage || 0;
                } else if (hasTechnicalResult && window.analysisState.technicalResult && window.analysisState.technicalResult.technical_score !== undefined) {
                    matchPercent = window.analysisState.technicalResult.technical_score * 10;
                }
                
                formData.append('timestamp', timestamp);
                formData.append('match_percentage', matchPercent);
                
                const response = await fetch('/shortlist_resume', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    // Mark both as shortlisted
                    window.analysisState.resumeShortlisted = true;
                    window.analysisState.technicalShortlisted = true;
                    updateUnifiedButtons();
                    showToast('Resume shortlisted!', 'shortlist');
                    if (typeof renderUserRecentActivity === 'function') renderUserRecentActivity();
                    if (typeof refreshUserDashboardStats === 'function') refreshUserDashboardStats();
                    if (typeof renderSavedAnalyses === 'function') renderSavedAnalyses();
                    if (typeof renderShortlistedResumes === 'function') renderShortlistedResumes();
                } else {
                    unifiedShortlistBtn.disabled = false;
                    unifiedShortlistBtn.innerHTML = '<i data-lucide="star" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Shortlist';
                }
            } catch (err) {
                unifiedShortlistBtn.disabled = false;
                unifiedShortlistBtn.innerHTML = '<i data-lucide="star" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Shortlist';
            }
        });
    }
});

function handleTechQuestionsUpload(input) {
  const span = document.getElementById('techQuestionsUploadName');
  if (input.files && input.files.length > 0) {
    span.textContent = input.files[0].name;
    const file = input.files[0];
    if (file.name.endsWith('.docx')) {
      const reader = new FileReader();
      reader.onload = function(event) {
        mammoth.extractRawText({arrayBuffer: event.target.result})
          .then(function(result) {
            document.getElementById('tech_questions').value = result.value;
          })
          .catch(function(err) {
            alert('Could not read the Word file.');
          });
      };
      reader.readAsArrayBuffer(file);
    } else if (file.name.endsWith('.txt')) {
      const reader = new FileReader();
      reader.onload = function(event) {
        document.getElementById('tech_questions').value = event.target.result;
      };
      reader.readAsText(file);
    } else {
      alert('Only .docx or .txt files are supported.');
      input.value = '';
      span.textContent = 'No file chosen';
    }
  } else {
    span.textContent = 'No file chosen';
    document.getElementById('tech_questions').value = '';
  }
}

// Show/hide compact tech actions with Save/Shortlist
function toggleCompactTechActions(show) {
    const compact = document.getElementById('compact-tech-actions');
    if (compact) {
        if (show) compact.classList.remove('hidden');
        else compact.classList.add('hidden');
    }
}

// Compact button handlers
function triggerInput(id) {
    const input = document.getElementById(id);
    if (input) input.click();
}
document.getElementById('compact-audio-btn').onclick = () => triggerInput('audio');
document.getElementById('compact-tech-resume-btn').onclick = () => triggerInput('tech_resume');
document.getElementById('compact-technology').onchange = function() {
    const techInput = document.getElementById('technology') || document.getElementById('compact-technology');
    if (techInput && techInput !== this) {
        techInput.value = this.value;
        techInput.dispatchEvent(new Event('change', { bubbles: true }));
    }
};

function validateTechnicalForm() {
    let isValid = true;
    let errors = [];
    // Audio
    const audioInput = document.getElementById('audio');
    if (!audioInput.files || audioInput.files.length === 0) {
        errors.push('Audio file is required.');
        isValid = false;
    }
    // Resume
    const techResumeInput = document.getElementById('tech_resume');
    if (!techResumeInput.files || techResumeInput.files.length === 0) {
        errors.push('Resume file is required.');
        isValid = false;
    }
    // Technical Questions
    const techQuestionsInput = document.getElementById('tech_questions');
    if (!techQuestionsInput.value.trim()) {
        errors.push('Technical questions are required.');
        isValid = false;
    }
    // Technology
    const techDropdown = document.getElementById('compact-technology');
    if (!techDropdown.value) {
        errors.push('Primary technology is required.');
        isValid = false;
    }
    // Show errors
    const errorContainer = document.getElementById('tech-errors-container');
    if (!isValid) {
        errorContainer.innerHTML = errors.map(e => `<span class='text-red-500 text-xs mr-4'>${e}</span>`).join('<br>');
    } else {
        errorContainer.innerHTML = '';
    }
    return isValid;
}

// --- Fix for Analyze Button Icon and Error Handling ---
const techQuestionsDropdown = document.getElementById('techQuestionsDropdown');
const analyzeTechnicalBtn = document.getElementById('analyze-technical-btn');
const techQuestionsInput = document.getElementById('tech_questions');
const techDropdown = document.getElementById('compact-technology');
const errorContainer = document.getElementById('tech-errors-container');

if (techQuestionsDropdown && analyzeTechnicalBtn && techQuestionsInput) {
    techQuestionsDropdown.addEventListener('change', function() {
        if (this.value) {
            analyzeTechnicalBtn.disabled = true;
            analyzeTechnicalBtn.innerHTML = '<i data-lucide="loader" class="animate-spin"></i>';
            // Fetch the file content from the backend
            fetch(`/get_iqg_file/${this.value}`)
                .then(response => response.json())
                .then(data => {
                    techQuestionsInput.value = data.content || '';
                    // Enable button and restore icon
                    analyzeTechnicalBtn.disabled = false;
                    analyzeTechnicalBtn.innerHTML = '<i data-lucide="search"></i>';
                    if (window.lucide && window.lucide.createIcons) lucide.createIcons();
                    // Hide error if present
                    if (errorContainer) {
                        errorContainer.innerHTML = errorContainer.innerHTML.replace(/Technical questions are required\./g, '');
                        // Remove empty <br> if present
                        errorContainer.innerHTML = errorContainer.innerHTML.replace(/<br>/g, '');
                    }
                })
                .catch(() => {
                    techQuestionsInput.value = '';
                    analyzeTechnicalBtn.disabled = false;
                    analyzeTechnicalBtn.innerHTML = '<i data-lucide="search"></i>';
                    if (window.lucide && window.lucide.createIcons) lucide.createIcons();
                    alert('Failed to load technical questions file.');
                });
        } else {
            techQuestionsInput.value = '';
        }
    });
}

// Hide error when technology is selected
if (techDropdown && errorContainer) {
    techDropdown.addEventListener('change', function() {
        if (this.value) {
            errorContainer.innerHTML = errorContainer.innerHTML.replace(/Primary technology is required\./g, '');
            // Remove empty <br> if present
            errorContainer.innerHTML = errorContainer.innerHTML.replace(/<br>/g, '');
        }
    });
}
if (analyzeTechnicalBtn) {
    analyzeTechnicalBtn.addEventListener('click', function(e) {
        if (!validateTechnicalForm()) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        }
    });
}

// Export functions for use in main index.html
window.resetAnalysisState = resetAnalysisState;
window.clearAnalysisState = clearAnalysisState;
window.updateUnifiedButtons = updateUnifiedButtons;
</script>

<style>
/* Custom animations */
@keyframes fade-in {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slide-in-left {
    from { 
        opacity: 0; 
        transform: translateX(-50px); 
    }
    to { 
        opacity: 1; 
        transform: translateX(0); 
    }
}

@keyframes slide-in-right {
    from { 
        opacity: 0; 
        transform: translateX(50px); 
    }
    to { 
        opacity: 1; 
        transform: translateX(0); 
    }
}

@keyframes slide-in-up {
    from { 
        opacity: 0; 
        transform: translateY(20px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}



@keyframes pulse-slow {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

@keyframes spin-slow {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
}

/* Animation classes */
.animate-fade-in {
    animation: fade-in 0.6s ease-out;
}

.animate-slide-in-left {
    animation: slide-in-left 0.6s ease-out;
}

.animate-slide-in-right {
    animation: slide-in-right 0.6s ease-out;
}

.animate-slide-in-up {
    animation: slide-in-up 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.animate-fade-in-delay {
    animation: fade-in 0.8s ease-out 0.2s both;
}



.animate-pulse-slow {
    animation: pulse-slow 3s infinite;
}

.animate-spin-slow {
    animation: spin-slow 3s linear infinite;
}

.animate-shake {
    animation: shake 0.5s ease-in-out;
}

/* Enhanced hover effects */
.custom-file-upload {
    position: relative;
    overflow: hidden;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: #f3f4f6; /* light gray */
    border: 2px solid #d1d5db; /* gray-300 */
    border-radius: 0.5rem;
    font-weight: 500;
    color: #374151; /* gray-700 */
    cursor: pointer;
    box-shadow: 0 1px 2px rgba(0,0,0,0.03);
    transition: background 0.2s, border 0.2s, color 0.2s, box-shadow 0.2s;
}

.custom-file-upload:hover, .custom-file-upload:focus {
    background: #e0e7ff; /* blue-100 */
    border-color: #2563eb; /* blue-600 */
    color: #1e3a8a; /* blue-900 */
    box-shadow: 0 2px 8px rgba(37,99,235,0.08);
}

.custom-file-upload input[type="file"] {
    display: none;
}

/* Smooth transitions for all interactive elements */
* {
    transition-property: all;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
}

/* Enhanced focus states */
textarea:focus, select:focus {
    transform: scale(1.02);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Loading state for submit button */
button[type="submit"]:active {
    animation: pulse-slow 0.3s ease-in-out;
}

/* File upload success animation */
.file-name:not(:empty) {
    animation: slide-in-up 0.3s ease-out;
}

/* Responsive animations */
@media (max-width: 768px) {
    .animate-slide-in-left,
    .animate-slide-in-right {
        animation: slide-in-up 0.6s ease-out;
    }
}

.resume-section-hover {
    transition: box-shadow 0.2s, border-color 0.2s, background 0.2s;
}
.resume-jobdesc-section {
    background: #eff6ff !important; /* blue-50 */
    border-color: #bfdbfe !important; /* blue-100 */
}
.resume-jobdesc-section:hover {
    box-shadow: 0 4px 16px 0 rgba(59,130,246,0.10);
    border-color: #2563eb !important;
    z-index: 1;
}
.resume-upload-section {
    background: #f0fdfa !important; /* teal-50 */
    border-color: #99f6e4 !important; /* teal-200 */
}
.resume-upload-section:hover {
    box-shadow: 0 4px 16px 0 rgba(20,184,166,0.10);
    border-color: #14b8a6 !important; /* teal-500 */
    z-index: 1;
}

@keyframes fade-in-up-tab {
    from {
        opacity: 0;
        transform: translateY(40px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
.resume-tab-animate {
    animation: fade-in-up-tab 0.7s cubic-bezier(0.4, 0, 0.2, 1);
}
.resume-tab-animate > .flex.flex-col.md\:flex-row {
    opacity: 0;
    animation: fade-in-up-tab 0.7s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}
.resume-tab-animate > .flex.flex-col.md\:flex-row:nth-child(2) {
    animation-delay: 0.15s;
}
.resume-tab-animate > .flex.flex-col.md\:flex-row:nth-child(3) {
    animation-delay: 0.3s;
}

/* Enhanced analysis results styling */
#resume_result_card_resume,
#audio_result_card_audio {
    transition: all 0.3s ease-in-out;
    border: 1px solid rgba(229, 231, 235, 0.6);
}

#resume_result_card_resume:hover,
#audio_result_card_audio:hover {
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    transform: translateY(-2px);
}

/* Improved placeholder styling */
#placeholder-resume,
#placeholder-audio {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-radius: 0.75rem;
    border: 2px dashed #cbd5e1;
}

/* Better scrollbar styling for results */
#resume_result_resume::-webkit-scrollbar,
#audio_result_audio::-webkit-scrollbar {
    width: 6px;
}

#resume_result_resume::-webkit-scrollbar-track,
#audio_result_audio::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 3px;
}

#resume_result_resume::-webkit-scrollbar-thumb,
#audio_result_audio::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

#resume_result_resume::-webkit-scrollbar-thumb:hover,
#audio_result_audio::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* Ensure proper height distribution */
.flex-1 {
    flex: 1 1 0%;
}

.min-h-0 {
    min-height: 0;
}

.btn-compact {
    padding: 0.25rem 0.5rem;
    font-size: 0.85rem;
    border-radius: 0.375rem;
    border: 1px solid #d1d5db;
    background: #f3f4f6;
    color: #374151;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    transition: background 0.2s, border 0.2s, color 0.2s;
    cursor: pointer;
    min-width: 32px;
    min-height: 32px;
}
.btn-compact:hover, .btn-compact:focus {
    background: #e0e7ff;
    border-color: #2563eb;
    color: #1e3a8a;
}
.btn-compact-select {
    padding: 0.25rem 0.5rem;
    font-size: 0.85rem;
    border-radius: 0.375rem;
    border: 1px solid #d1d5db;
    background: #f3f4f6;
    color: #374151;
    min-width: 80px;
    min-height: 32px;
}
.btn-compact-analyze {
    padding: 0.25rem 0.75rem;
    font-size: 0.85rem;
    border-radius: 0.375rem;
    border: 1px solid #2563eb;
    background: #2563eb;
    color: #fff;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    cursor: pointer;
    min-width: 32px;
    min-height: 32px;
}
.btn-compact-analyze:hover, .btn-compact-analyze:focus {
    background: #1e40af;
    border-color: #1e40af;
}
/* Saved badge */
#saved-badge {
  background: #d1fae5;
  color: #047857;
  border: 1px solid #a7f3d0;
  font-weight: 600;
  transition: background 0.2s, color 0.2s;
}
#saved-badge svg {
  color: #047857;
}
/* Shortlisted badge */
#shortlisted-badge {
  background: #ffedd5;
  color: #b45309;
  border: 1px solid #fdba74;
  font-weight: 600;
  transition: background 0.2s, color 0.2s;
}
#shortlisted-badge svg {
  color: #b45309;
}
.pill-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  border-radius: 9999px;
  font-size: 0.85rem;
  font-weight: 600;
  padding: 0.5rem 1.1rem;
  border: 1px solid transparent;
  transition: background 0.2s, color 0.2s, border 0.2s;
  cursor: pointer;
  outline: none;
}
.pill-btn svg {
  width: 1.1em;
  height: 1.1em;
  margin-right: 0.3em;
}
.pill-btn-green {
  background: #d1fae5;
  color: #047857;
  border: 1px solid #a7f3d0;
}
.pill-btn-green:hover:not(:disabled) {
  background: #bbf7d0;
  color: #065f46;
  border-color: #34d399;
}
.pill-btn-green:disabled, .pill-btn-green[disabled] {
  background: #d1fae5;
  color: #047857;
  border: 1px solid #a7f3d0;
  cursor: default;
  opacity: 1;
}
.pill-btn-orange {
  background: #ffedd5;
  color: #b45309;
  border: 1px solid #fdba74;
}
.pill-btn-orange:hover:not(:disabled) {
  background: #fed7aa;
  color: #92400e;
  border-color: #fb923c;
}
.pill-btn-orange:disabled, .pill-btn-orange[disabled] {
  background: #ffedd5;
  color: #b45309;
  border: 1px solid #fdba74;
  cursor: default;
  opacity: 1;
}
.pill-btn-text {
  vertical-align: middle;
}
</style> 
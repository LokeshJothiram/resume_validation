<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Talent Acquisition Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="icon" type="image/jpeg" href="{{ url_for('static', filename='tringapps_inc_logo.jpeg') }}">
    <style>
      /* Style for disabled tab buttons */
      button.tab-btn:disabled {
        color: #9ca3af !important; /* Tailwind gray-400 */
        border-color: transparent !important;
        background: none !important;
        opacity: 0.5;
        cursor: not-allowed !important;
        pointer-events: auto;
      }
      /* Gradient for active and hover tabs */
      .tab-btn.active-gradient {
        background: linear-gradient(90deg, #3b82f6 0%, #a855f7 100%) !important;
        color: #fff !important;
        font-weight: bold;
      }
      .tab-btn:hover:not(:disabled):not(.active-gradient) {
        background: linear-gradient(90deg, #dbeafe 0%, #f3e8ff 100%) !important;
        color: #3b82f6 !important;
      }
      .tab-btn:not(.active-gradient) {
        color: #374151 !important; /* Tailwind gray-700 */
      }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Wrap the header in a fixed div -->
    <div id="fixed-header" class="fixed top-0 left-0 w-full z-50 bg-white shadow" style="height: 64px;">
      <!-- Move your header content here (from the original header location) -->
      <!-- Header: Gradient Title (left), Logout (right) -->
      <div class="flex items-center justify-between w-full py-2 px-6">
        <!-- Gradient Title Left -->
        <span class="header-gradient font-bold text-2xl sm:text-2xl">AI Talent Assistant</span>
        <div class="flex items-center gap-4">
          <!-- Search and Icons (static, as per image) -->
          <div class="flex items-center gap-3">
            <div class="flex items-center bg-gray-100 rounded-full px-4 py-2 transition" style="min-width: 260px;">
              <input type="text" placeholder="Enter your search request..." class="bg-transparent outline-none border-none text-gray-500 w-full placeholder-gray-400 text-base px-1 focus:ring-0 focus:outline-none" style="min-width: 160px;" />
              <i data-lucide="search" class="w-5 h-5 text-gray-400 ml-2"></i>
            </div>
            <button class="bg-white rounded-full p-2 shadow border border-gray-200"><i data-lucide="map-pin" class="w-5 h-5 text-gray-400"></i></button>
            <button class="bg-white rounded-full p-2 shadow border border-gray-200"><i data-lucide="bell" class="w-5 h-5 text-gray-400"></i></button>
            <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="User" class="w-9 h-9 rounded-full object-cover border border-gray-200" />
          </div>
          <!-- Logout Right -->
          <form action="{{ url_for('logout') }}" method="post">
            <button type="submit" id="logout" class="logout-btn flex items-center px-4 py-2 border border-gray-300 rounded-lg font-mono font-semibold bg-white hover:bg-gray-100 transition">
              <i data-lucide="log-out" class="inline w-4 h-4 mr-2 align-text-bottom"></i> Logout
            </button>
          </form>
        </div>
      </div>
    </div>
    <div class="flex w-full">
      <!-- Sidebar: fixed -->
      <div id="fixed-sidebar" class="fixed top-16 left-0 w-56 h-full bg-white border-r pt-4 z-40">
        <div class="flex flex-col gap-1 pl-0 pr-0">
          {% if session.role == 'admin' %}
          <button id="tab-job-upload" type="button" class="tab-btn w-full text-left px-3 py-2 text-sm font-medium text-gray-600 bg-white focus:outline-none hover:bg-blue-50 rounded-lg whitespace-nowrap">
              <i data-lucide="upload" class="inline w-4 h-4 mr-1 align-text-bottom"></i> Job Description Upload
          </button>
          {% else %}
          <button id="tab-resume" type="button" class="tab-btn w-full text-left px-3 py-2 text-sm font-medium text-gray-600 bg-white focus:outline-none hover:bg-blue-50 rounded-lg">
            <span class="flex items-start">
              <i data-lucide="file-search" class="inline w-5 h-5 mt-1 mr-2 align-text-bottom"></i>
              <span class="flex flex-col items-start">
                <span>Resume Match</span>
                <span class="text-xs text-gray-400 font-normal leading-tight">AI-powered resume matching</span>
              </span>
            </span>
          </button>
          <button id="tab-audio" type="button" class="tab-btn w-full text-left px-3 py-2 text-sm font-medium text-gray-600 bg-white focus:outline-none hover:bg-blue-50 rounded-lg">
            <span class="flex items-start">
              <i data-lucide="mic" class="inline w-5 h-5 mt-1 mr-2 align-text-bottom"></i>
              <span class="flex flex-col items-start">
                <span>Technical Proficiency</span>
                <span class="text-xs text-gray-400 font-normal leading-tight">Skill assessment tools</span>
              </span>
            </span>
          </button>
          <button id="tab-question-gen" type="button" class="tab-btn w-full text-left px-3 py-2 text-sm font-medium text-gray-600 bg-white focus:outline-none hover:bg-blue-50 rounded-lg">
            <span class="flex items-start">
              <i data-lucide="help-circle" class="inline w-5 h-5 mt-1 mr-2 align-text-bottom"></i>
              <span class="flex flex-col items-start">
                <span>Interview Question Generator</span>
                <span class="text-xs text-gray-400 font-normal leading-tight">Question builder</span>
              </span>
            </span>
          </button>
          <button id="tab-saved" type="button" class="tab-btn w-full text-left px-3 py-2 text-sm font-medium text-gray-600 bg-white focus:outline-none hover:bg-blue-50 rounded-lg">
            <span class="flex items-start">
              <i data-lucide="bookmark" class="inline w-5 h-5 mt-1 mr-2 align-text-bottom"></i>
              <span class="flex flex-col items-start">
                <span>Saved Analyses</span>
                <span class="text-xs text-gray-400 font-normal leading-tight">Previous assessments</span>
              </span>
            </span>
          </button>
          <button id="tab-shortlisted" type="button" class="tab-btn w-full text-left px-3 py-2 text-sm font-medium text-gray-600 bg-white focus:outline-none hover:bg-blue-50 rounded-lg">
            <span class="flex items-start">
              <i data-lucide="users" class="inline w-5 h-5 mt-1 mr-2 align-text-bottom"></i>
              <span class="flex flex-col items-start">
                <span>Shortlisted Resumes</span>
                <span class="text-xs text-gray-400 font-normal leading-tight">Candidate pipeline</span>
              </span>
            </span>
          </button>
          {% endif %}
        </div>
      </div>
      <!-- Main Content: scrollable -->
      <div class="ml-56 mt-16 h-[calc(100vh-64px)] overflow-y-auto w-full">
        <!-- Main Content: full width, no centering, no top margin -->
        <div class="w-full p-0">
            <div id="form-card" class="p-6 sm:p-8 rounded-lg transition-all duration-300 w-full">
                    <form id="talentForm" enctype="multipart/form-data" novalidate>
                        <!-- Resume Match Tab -->
                        <div id="resume-tab-content">
                        <div class="flex flex-col items-start w-full">
                            <div class="w-full pr-0 self-start">
                            {% include 'tabs/resume_match_tab.html' %}
                            </div>
                            <div class="w-full pl-0 mt-8">
                                <h2 class="text-2xl font-bold mb-4 text-gray-800">Analysis Results</h2>
                                <!-- Loader under Analysis Results -->
                                <div id="loader-resume" class="text-center p-8 hidden">
                                    <div role="status" class="flex flex-col items-center justify-center">
                                        <svg aria-hidden="true" class="inline w-10 h-10 text-blue-400 animate-spin drop-shadow-lg" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <circle cx="50" cy="50" r="45" stroke="#3B82F6" stroke-width="10" fill="none" opacity="0.2"/>
                                            <path d="M50 15a35 35 0 1 1-24.75 10.25" stroke="#2563EB" stroke-width="10" stroke-linecap="round" fill="none"/>
                                        </svg>
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                    <p class="mt-4 text-blue-600 font-semibold animate-pulse">Analyzing... Please wait.</p>
                                </div>
                                <!-- Save and Shortlist buttons -->
                                <div id="action-btns-resume" class="flex gap-4 mb-4 hidden">
                                    <button id="save-analysis-btn-resume" type="button" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 flex items-center">
                                        <i data-lucide="save" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Save
                                    </button>
                                    <button id="shortlist-btn-resume" type="button" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 flex items-center">
                                        <i data-lucide="star" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Shortlist
                                    </button>
                                </div>
                                <div id="results-resume" class="p-0">
                                     <div id="meta_info_resume" class="mb-4 text-gray-700"></div>
                                     <div class="space-y-6">
                                        <div id="resume_result_card_resume" class="bg-white p-4 rounded-lg shadow-md">
                                            <div id="placeholder-resume" class="text-gray-400 text-center py-12">No analysis yet. Please upload files and click <b>Analyze Candidate</b>.</div>
                                            <div id="resume_result_resume"></div>
                                        </div>
                                     </div>
                                 </div>
                            </div>
                        </div>
                        </div>
                        <!-- Technical Proficiency Tab -->
                        <div id="audio-tab-content" class="hidden">
                        <div class="flex flex-col items-start w-full">
                            <div class="w-full pr-0 self-start">
                            {% include 'tabs/technical_proficiency_tab.html' %}
                            </div>
                            <div class="w-full pl-0 mt-8">
                                <h2 class="text-2xl font-bold mb-4 text-gray-800">Analysis Results</h2>
                                <!-- Loader under Analysis Results -->
                                <div id="loader-audio" class="text-center p-8 hidden">
                                    <div role="status" class="flex flex-col items-center justify-center">
                                        <svg aria-hidden="true" class="inline w-10 h-10 text-blue-400 animate-spin drop-shadow-lg" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <circle cx="50" cy="50" r="45" stroke="#3B82F6" stroke-width="10" fill="none" opacity="0.2"/>
                                            <path d="M50 15a35 35 0 1 1-24.75 10.25" stroke="#2563EB" stroke-width="10" stroke-linecap="round" fill="none"/>
                                        </svg>
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                    <p class="mt-4 text-blue-600 font-semibold animate-pulse">Analyzing... Please wait.</p>
                                </div>
                                <!-- Save and Shortlist buttons -->
                                <div id="action-btns-audio" class="flex gap-4 mb-4 hidden">
                                    <button id="save-analysis-btn-audio" type="button" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 flex items-center">
                                        <i data-lucide="save" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Save
                                    </button>
                                    <button id="shortlist-btn-audio" type="button" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 flex items-center">
                                        <i data-lucide="star" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Shortlist
                                    </button>
                                </div>
                                <div id="results-audio" class="p-0">
                                     <div id="meta_info_audio" class="mb-4 text-gray-700"></div>
                                     <div class="space-y-6">
                                        <div id="audio_result_card_audio" class="bg-white p-4 rounded-lg shadow-md">
                                            <div id="placeholder-audio" class="text-gray-400 text-center py-12">No analysis yet. Please upload files and click <b>Analyze Candidate</b>.</div>
                                            <div id="audio_result_audio"></div>
                                        </div>
                                     </div>
                                 </div>
                            </div>
                        </div>
                        </div>
                        <!-- Interview Question Generator Tab -->
                    <div id="question-gen-tab-content" class="hidden w-full text-left">
                            {% include 'tabs/interview_question_generator_tab.html' %}
                        </div>
                        <!-- Saved Analyses Tab -->
                    <div id="saved-tab-content" class="hidden w-full text-left">
                            {% include 'tabs/saved_analyses_tab.html' %}
                        </div>
                        <!-- Shortlisted Resumes Tab -->
                    <div id="shortlisted-tab-content" class="hidden w-full text-left">
                            {% include 'tabs/shortlisted_resumes_tab.html' %}
                        </div>
                    </form>
            </div>

            <!-- Results Modal -->
            <div id="results-overlay" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-full overflow-y-auto relative">
                    <button id="back-button" class="absolute top-4 left-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i data-lucide="arrow-left" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Back
                    </button>
                    <button id="save-analysis-btn" class="absolute top-4 right-36 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 flex items-center hidden">
                        <i data-lucide="save" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Save
                    </button>
                    <button id="shortlist-btn" class="absolute top-4 right-3 bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 flex items-center">
                        <i data-lucide="star" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Shortlist
                    </button>
                    <!-- Loader -->
                    <div id="loader" class="text-center p-12">
                        <div role="status" class="flex flex-col items-center justify-center">
                            <svg aria-hidden="true" class="inline w-10 h-10 text-blue-400 animate-spin drop-shadow-lg" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="50" cy="50" r="45" stroke="#3B82F6" stroke-width="10" fill="none" opacity="0.2"/>
                                <path d="M50 15a35 35 0 1 1-24.75 10.25" stroke="#2563EB" stroke-width="10" stroke-linecap="round" fill="none"/>
                            </svg>
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-4 text-blue-600 font-semibold animate-pulse">Analyzing... Please wait.</p>
                    </div>

                    <!-- Results -->
                    <div id="results" class="p-6 sm:p-8 hidden">
                        <h2 class="text-3xl font-bold mb-6 text-center text-gray-800">Analysis Results</h2>
                        <div id="meta_info" class="mb-6 text-center text-gray-700"></div>
                        <div class="space-y-6">
                            <div id="resume_result_card" class="bg-white p-6 rounded-lg shadow-md">
                                <!-- <h3 class="text-xl font-semibold text-gray-800 mb-4">Resume Analysis</h3> -->
                                <div id="resume_result"></div>
                            </div>
                            <div id="audio_result_card" class="bg-white p-6 rounded-lg shadow-md">
                                <!-- <h3 class="text-xl font-semibold text-gray-800 mb-4">Audio Analysis</h3> -->
                                <div id="audio_result"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 bg-green-600 text-white px-6 py-3 rounded shadow-lg text-center text-sm font-semibold opacity-0 pointer-events-none transition-opacity duration-500 flex items-center gap-2" style="pointer-events: none;"></div>

        <!-- Custom Delete Confirmation Modal -->
        <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden" style="z-index: 1000;">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full text-center">
                <div class="text-lg font-semibold mb-4">Delete this saved analysis?</div>
                <div class="flex justify-center gap-4 mt-6">
                    <button id="delete-modal-confirm" class="bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700 font-semibold">Delete</button>
                    <button id="delete-modal-cancel" class="bg-gray-200 text-gray-700 px-6 py-2 rounded hover:bg-gray-300 font-semibold">Cancel</button>
                </div>
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.7.0/mammoth.browser.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            // Tab navigation button IDs (define once, globally)
            const tabIds = ['tab-resume', 'tab-audio', 'tab-question-gen', 'tab-saved', 'tab-shortlisted'];

            // Define tab and content variables
            const tabResume = document.getElementById('tab-resume');
            const tabAudio = document.getElementById('tab-audio');
            const tabQuestionGen = document.getElementById('tab-question-gen');
            const tabSaved = document.getElementById('tab-saved');
            const tabShortlisted = document.getElementById('tab-shortlisted');
            const resumeTabContent = document.getElementById('resume-tab-content');
            const audioTabContent = document.getElementById('audio-tab-content');
            const questionGenTabContent = document.getElementById('question-gen-tab-content');
            const savedTabContent = document.getElementById('saved-tab-content');
            const shortlistedTabContent = document.getElementById('shortlisted-tab-content');

            let activeTab = 'resume';

            function setActiveTab(tab) {
                // Remove active classes from all
                tabIds.forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) {
                        btn.classList.remove('active-gradient', 'text-blue-700', 'border-blue-600', 'bg-blue-50', 'font-semibold');
                        btn.classList.add('text-gray-600', 'border-transparent', 'bg-white', 'font-medium');
                    }
                });
                // Add active classes to selected
                const activeBtn = document.getElementById(`tab-${tab}`);
                if (activeBtn) {
                    activeBtn.classList.remove('text-gray-600', 'border-transparent', 'bg-white', 'font-medium');
                    activeBtn.classList.add('active-gradient');
                }
            }

            // Initial active tab
            setActiveTab('resume');

            // Wait for DOMContentLoaded to ensure all elements are available
            document.addEventListener('DOMContentLoaded', function() {
                if (window.lucide && window.lucide.createIcons) {
                    lucide.createIcons();
                }
            });

            const techResumeInput = document.getElementById('tech_resume');
            let latestAnalysisResult = null;

            if (tabResume) {
                tabResume.addEventListener('click', () => {
                    setActiveTab('resume');
                    if (tabResume) { tabResume.classList.add('text-blue-700', 'border-blue-600'); tabResume.classList.remove('text-gray-500'); }
                    if (tabAudio) { tabAudio.classList.remove('text-blue-700', 'border-blue-600'); tabAudio.classList.add('text-gray-500'); }
                    if (tabQuestionGen) { tabQuestionGen.classList.remove('text-blue-700', 'border-blue-600'); tabQuestionGen.classList.add('text-gray-500'); }
                    if (tabSaved) { tabSaved.classList.remove('text-blue-700', 'border-blue-600'); tabSaved.classList.add('text-gray-500'); }
                    if (tabShortlisted) { tabShortlisted.classList.remove('text-blue-700', 'border-blue-600'); tabShortlisted.classList.add('text-gray-500'); }
                    if (resumeTabContent) resumeTabContent.classList.remove('hidden');
                    if (audioTabContent) audioTabContent.classList.add('hidden');
                    if (questionGenTabContent) questionGenTabContent.classList.add('hidden');
                    if (savedTabContent) savedTabContent.classList.add('hidden');
                    if (shortlistedTabContent) shortlistedTabContent.classList.add('hidden');
                    activeTab = 'resume';
                    const analyzeBtn = document.getElementById('analyze-btn-container');
                    if (analyzeBtn) analyzeBtn.classList.remove('hidden');
                    if (techResumeInput) techResumeInput.required = false;
                });
            }
            if (tabAudio) {
                tabAudio.addEventListener('click', () => {
                    setActiveTab('audio');
                    if (tabAudio) { tabAudio.classList.add('text-blue-700', 'border-blue-600'); tabAudio.classList.remove('text-gray-500'); }
                    if (tabResume) { tabResume.classList.remove('text-blue-700', 'border-blue-600'); tabResume.classList.add('text-gray-500'); }
                    if (tabQuestionGen) { tabQuestionGen.classList.remove('text-blue-700', 'border-blue-600'); tabQuestionGen.classList.add('text-gray-500'); }
                    if (tabSaved) { tabSaved.classList.remove('text-blue-700', 'border-blue-600'); tabSaved.classList.add('text-gray-500'); }
                    if (tabShortlisted) { tabShortlisted.classList.remove('text-blue-700', 'border-blue-600'); tabShortlisted.classList.add('text-gray-500'); }
                    if (audioTabContent) audioTabContent.classList.remove('hidden');
                    if (resumeTabContent) resumeTabContent.classList.add('hidden');
                    if (questionGenTabContent) questionGenTabContent.classList.add('hidden');
                    if (savedTabContent) savedTabContent.classList.add('hidden');
                    if (shortlistedTabContent) shortlistedTabContent.classList.add('hidden');
                    activeTab = 'audio';
                    const analyzeBtn = document.getElementById('analyze-btn-container');
                    if (analyzeBtn) analyzeBtn.classList.remove('hidden');
                    if (techResumeInput) techResumeInput.required = true;
                });
            }
            if (tabQuestionGen) {
                tabQuestionGen.addEventListener('click', () => {
                    setActiveTab('question-gen');
                    if (tabQuestionGen) { tabQuestionGen.classList.add('text-blue-700', 'border-blue-600'); tabQuestionGen.classList.remove('text-gray-500'); }
                    if (tabResume) { tabResume.classList.remove('text-blue-700', 'border-blue-600'); tabResume.classList.add('text-gray-500'); }
                    if (tabAudio) { tabAudio.classList.remove('text-blue-700', 'border-blue-600'); tabAudio.classList.add('text-gray-500'); }
                    if (tabSaved) { tabSaved.classList.remove('text-blue-700', 'border-blue-600'); tabSaved.classList.add('text-gray-500'); }
                    if (tabShortlisted) { tabShortlisted.classList.remove('text-blue-700', 'border-blue-600'); tabShortlisted.classList.add('text-gray-500'); }
                    if (questionGenTabContent) questionGenTabContent.classList.remove('hidden');
                    if (resumeTabContent) resumeTabContent.classList.add('hidden');
                    if (audioTabContent) audioTabContent.classList.add('hidden');
                    if (savedTabContent) savedTabContent.classList.add('hidden');
                    if (shortlistedTabContent) shortlistedTabContent.classList.add('hidden');
                    if (typeof renderSavedAnalyses === 'function') renderSavedAnalyses();
                    activeTab = 'question-gen';
                    const analyzeBtn = document.getElementById('analyze-btn-container');
                    if (analyzeBtn) analyzeBtn.classList.add('hidden');
                    const resultsOverlay = document.getElementById('results-overlay');
                    if (resultsOverlay) {
                        resultsOverlay.classList.add('hidden');
                        resultsOverlay.style.display = 'none';
                        resultsOverlay.style.visibility = 'hidden';
                    }
                    wasResultsOverlayOpen = false;
                    // Also hide the delete modal when switching to Saved Analyses tab
                    const deleteModal = document.getElementById('delete-modal');
                    if (deleteModal) deleteModal.classList.add('hidden');
                    if (techResumeInput) techResumeInput.required = false;
                });
            }
            if (tabSaved) {
                tabSaved.addEventListener('click', () => {
                    setActiveTab('saved');
                    if (tabSaved) { tabSaved.classList.add('text-blue-700', 'border-blue-600'); tabSaved.classList.remove('text-gray-500'); }
                    if (tabResume) { tabResume.classList.remove('text-blue-700', 'border-blue-600'); tabResume.classList.add('text-gray-500'); }
                    if (tabAudio) { tabAudio.classList.remove('text-blue-700', 'border-blue-600'); tabAudio.classList.add('text-gray-500'); }
                    if (tabQuestionGen) { tabQuestionGen.classList.remove('text-blue-700', 'border-blue-600'); tabQuestionGen.classList.add('text-gray-500'); }
                    if (tabShortlisted) { tabShortlisted.classList.remove('text-blue-700', 'border-blue-600'); tabShortlisted.classList.add('text-gray-500'); }
                    if (savedTabContent) savedTabContent.classList.remove('hidden');
                    if (resumeTabContent) resumeTabContent.classList.add('hidden');
                    if (audioTabContent) audioTabContent.classList.add('hidden');
                    if (questionGenTabContent) questionGenTabContent.classList.add('hidden');
                    if (shortlistedTabContent) shortlistedTabContent.classList.add('hidden');
                    if (typeof renderSavedAnalyses === 'function') renderSavedAnalyses();
                    activeTab = 'saved';
                    const analyzeBtn = document.getElementById('analyze-btn-container');
                    if (analyzeBtn) analyzeBtn.classList.add('hidden');
                    const resultsOverlay = document.getElementById('results-overlay');
                    if (resultsOverlay) {
                        resultsOverlay.classList.add('hidden');
                        resultsOverlay.style.display = 'none';
                        resultsOverlay.style.visibility = 'hidden';
                    }
                    wasResultsOverlayOpen = false;
                    // Also hide the delete modal when switching to Saved Analyses tab
                    const deleteModal = document.getElementById('delete-modal');
                    if (deleteModal) deleteModal.classList.add('hidden');
                    if (techResumeInput) techResumeInput.required = false;
                });
            }
            if (tabShortlisted) {
                tabShortlisted.addEventListener('click', () => {
                    setActiveTab('shortlisted');
                    if (tabShortlisted) { tabShortlisted.classList.add('text-blue-700', 'border-blue-600'); tabShortlisted.classList.remove('text-gray-500'); }
                    if (tabResume) { tabResume.classList.remove('text-blue-700', 'border-blue-600'); tabResume.classList.add('text-gray-500'); }
                    if (tabAudio) { tabAudio.classList.remove('text-blue-700', 'border-blue-600'); tabAudio.classList.add('text-gray-500'); }
                    if (tabQuestionGen) { tabQuestionGen.classList.remove('text-blue-700', 'border-blue-600'); tabQuestionGen.classList.add('text-gray-500'); }
                    if (tabSaved) { tabSaved.classList.remove('text-blue-700', 'border-blue-600'); tabSaved.classList.add('text-gray-500'); }
                    if (shortlistedTabContent) shortlistedTabContent.classList.remove('hidden');
                    if (resumeTabContent) resumeTabContent.classList.add('hidden');
                    if (audioTabContent) audioTabContent.classList.add('hidden');
                    if (questionGenTabContent) questionGenTabContent.classList.add('hidden');
                    if (savedTabContent) savedTabContent.classList.add('hidden');
                    if (typeof renderShortlistedResumes === 'function') renderShortlistedResumes();
                    activeTab = 'shortlisted';
                    const analyzeBtn = document.getElementById('analyze-btn-container');
                    if (analyzeBtn) analyzeBtn.classList.add('hidden');
                    const resultsOverlay = document.getElementById('results-overlay');
                    if (resultsOverlay) {
                        resultsOverlay.classList.add('hidden');
                        resultsOverlay.style.display = 'none';
                        resultsOverlay.style.visibility = 'hidden';
                    }
                    wasResultsOverlayOpen = false;
                    // Also hide the delete modal when switching to Saved Analyses tab
                    const deleteModal = document.getElementById('delete-modal');
                    if (deleteModal) deleteModal.classList.add('hidden');
                    if (techResumeInput) techResumeInput.required = false;
                });
            }

            document.getElementById('talentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                let valid = true;

                // Resume tab
                const jobDesc = document.getElementById('job_description').value.trim();
                const resumeInputs = document.querySelectorAll('.resume-file');
                let resumeFiles = [];
                resumeInputs.forEach(input => {
                    if (input.files && input.files.length > 0) {
                        resumeFiles.push(input.files[0]);
                    }
                });
                // Technical tab
                const audioFile = document.getElementById('audio').files[0];
                const technology = document.getElementById('technology').value;

                // Hide/show errors based on validity
                if (activeTab === 'resume') {
                    if (!jobDesc) {
                        const el = document.getElementById('job_description_error');
                        if (el) el.classList.remove('hidden');
                        valid = false;
                    } else {
                        const el = document.getElementById('job_description_error');
                        if (el) el.classList.add('hidden');
                    }
                    if (resumeFiles.length === 0) {
                        const el = document.getElementById('resume_error');
                        if (el) el.classList.remove('hidden');
                        valid = false;
                    } else {
                        const el = document.getElementById('resume_error');
                        if (el) el.classList.add('hidden');
                    }
                } else if (activeTab === 'audio') {
                    if (!audioFile) {
                        const el = document.getElementById('audio_error');
                        if (el) el.classList.remove('hidden');
                        valid = false;
                    } else {
                        const el = document.getElementById('audio_error');
                        if (el) el.classList.add('hidden');
                    }
                    if (!technology) {
                        const el = document.getElementById('technology_error');
                        if (el) el.classList.remove('hidden');
                        valid = false;
                    } else {
                        const el = document.getElementById('technology_error');
                        if (el) el.classList.add('hidden');
                    }
                    // Custom validation for tech_resume
                    if (!techResumeInput.files || techResumeInput.files.length === 0) {
                        const el = document.getElementById('tech_resume_error');
                        if (el) el.classList.remove('hidden');
                        valid = false;
                    } else {
                        const el = document.getElementById('tech_resume_error');
                        if (el) el.classList.add('hidden');
                    }
                }
                if (!valid) return;
                const form = document.getElementById('talentForm');
                const formData = new FormData();
                // Add all form fields except resume
                Array.from(form.elements).forEach(el => {
                    if (el.name && el.type !== 'file' && el.type !== 'submit') {
                        formData.append(el.name, el.value);
                    }
                });
                // Add all selected resume files
                if (activeTab === 'resume' && resumeFiles.length > 0) {
                    for (let i = 0; i < resumeFiles.length; i++) {
                        formData.append('resume', resumeFiles[i]);
                    }
                } else if (activeTab === 'audio') {
                    if (audioFile) formData.append('audio', audioFile);
                }

                // Use unique IDs for each tab
                let loaderId, resultsId, actionBtnsId, saveBtnId, shortlistBtnId, metaInfoId, resultCardId, resultDivId;
                if (activeTab === 'resume') {
                    loaderId = 'loader-resume';
                    resultsId = 'results-resume';
                    actionBtnsId = 'action-btns-resume';
                    saveBtnId = 'save-analysis-btn-resume';
                    shortlistBtnId = 'shortlist-btn-resume';
                    metaInfoId = 'meta_info_resume';
                    resultCardId = 'resume_result_card_resume';
                    resultDivId = 'resume_result_resume';
                } else if (activeTab === 'audio') {
                    loaderId = 'loader-audio';
                    resultsId = 'results-audio';
                    actionBtnsId = 'action-btns-audio';
                    saveBtnId = 'save-analysis-btn-audio';
                    shortlistBtnId = 'shortlist-btn-audio';
                    metaInfoId = 'meta_info_audio';
                    resultCardId = 'audio_result_card_audio';
                    resultDivId = 'audio_result_audio';
                }

                // Disable all tab buttons while loading, except the active tab
                tabIds.forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn && id !== `tab-${activeTab}`) btn.disabled = true;
                });

                // Show loader, hide results and buttons in right column
                if (loaderId && resultsId && actionBtnsId) {
                    let loaderElem = document.getElementById(loaderId);
                    if (loaderElem) loaderElem.classList.remove('hidden');
                    const resultsElem = document.getElementById(resultsId);
                    if (resultsElem) resultsElem.classList.add('hidden');
                    const actionBtnsElem = document.getElementById(actionBtnsId);
                    if (actionBtnsElem) actionBtnsElem.classList.add('hidden');
                    // Hide placeholder when analyzing
                    if (activeTab === 'resume') {
                        const ph = document.getElementById('placeholder-resume');
                        if (ph) ph.classList.add('hidden');
                    } else if (activeTab === 'audio') {
                        const ph = document.getElementById('placeholder-audio');
                        if (ph) ph.classList.add('hidden');
                    }
                }

                // Reset Save/Shortlist button state
                if (saveBtnId && shortlistBtnId) {
                    const saveBtn = document.getElementById(saveBtnId);
                    const shortlistBtn = document.getElementById(shortlistBtnId);
                    if (saveBtn && shortlistBtn) {
                        saveBtn.innerHTML = '<i data-lucide="save" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Save';
                        saveBtn.classList.remove('bg-green-700', 'cursor-default');
                        saveBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                        saveBtn.disabled = false;
                        shortlistBtn.innerHTML = '<i data-lucide="star" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Shortlist';
                        shortlistBtn.classList.remove('bg-yellow-600', 'cursor-default');
                        shortlistBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                        shortlistBtn.disabled = false;
                        lucide.createIcons();
                    }
                }

                // CHANGED: Dynamically select endpoint based on active tab
                const endpoint = (activeTab === 'audio') ? '/process_audio' : '/process';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                latestAnalysisResult = result; // Store the latest result

                // Hide loader, show results and buttons in right column
                if (loaderId && resultsId && actionBtnsId) {
                    loaderElem = document.getElementById(loaderId);
                    if (loaderElem) loaderElem.classList.add('hidden');
                    const resultsElem = document.getElementById(resultsId);
                    if (resultsElem) resultsElem.classList.remove('hidden');
                    const actionBtnsElem = document.getElementById(actionBtnsId);
                    if (actionBtnsElem) actionBtnsElem.classList.remove('hidden');
                }

                // Render results in the correct tab's containers
                const metaInfoDiv = document.getElementById(metaInfoId);
                const resultCardDiv = document.getElementById(resultCardId);
                const resultDiv = document.getElementById(resultDivId);
                // Clear previous results
                if (metaInfoDiv) metaInfoDiv.innerHTML = '';
                if (resultDiv) resultDiv.innerHTML = '';
                if (resultCardDiv) resultCardDiv.classList.add('hidden');
                // If no results, show placeholder again
                if (activeTab === 'resume' && (!result || (!result.resumes && !result.resume_error))) {
                    const ph = document.getElementById('placeholder-resume');
                    if (ph) ph.classList.remove('hidden');
                } else if (activeTab === 'audio' && (!result || (!result.transcription && !result.audio_error))) {
                    const ph = document.getElementById('placeholder-audio');
                    if (ph) ph.classList.remove('hidden');
                }
                
                // Show selected technology and audio file name only for audio tab
                if (activeTab === 'audio') {
                    const selectedTechInput = document.getElementById('technology');
                    const selectedTech = selectedTechInput ? selectedTechInput.value : '';
                    const audioInput = document.getElementById('audio');
                    let audioFileName = '';
                    if (audioInput && audioInput.files && audioInput.files.length > 0) {
                        audioFileName = audioInput.files[0].name;
                    }
                    if (metaInfoDiv) {
                        metaInfoDiv.innerHTML = `<p><strong>Selected Technology:</strong> ${selectedTech || 'N/A'}</p>` +
                            (audioFileName ? `<p><strong>Audio File:</strong> ${audioFileName}</p>` : '');
                    }
                } else {
                    if (metaInfoDiv) metaInfoDiv.innerHTML = '';
                }
                
                if (activeTab === 'resume') {
                if (Array.isArray(result.resumes) && result.resumes.length > 0) {
                        resultCardDiv.classList.remove('hidden');
                    // Sort resumes by match percentage in descending order
                    result.resumes.sort((a, b) => {
                        const scoreA = a.match_percentage || -1;
                        const scoreB = b.match_percentage || -1;
                        return scoreB - scoreA;
                    });
                    let allResumesHTML = result.resumes.map((r, idx) => {
                        if (r.error) {
                            return `<div class='mb-4 p-4 border border-red-300 rounded bg-red-50'><strong>${r.filename}</strong>: <span class='text-red-600'>${r.error}</span></div>`;
                        } else {
                            const skillCoverage = r.total_skills > 0 ? Math.round((r.skills_matched / r.total_skills) * 100) : 0;
                            return `<div class='mb-4 p-4 border border-blue-100 rounded'>
                                <p><strong>${r.filename}</strong></p>
                                <div class="flex flex-row gap-6 my-4 items-center justify-center">
                                    <div class="flex flex-col items-center">
                                        <canvas id="donutMatch${idx}" width="80" height="80"></canvas>
                                        <div class="mt-2 text-center text-xs font-semibold">Match %</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <canvas id="donutSkills${idx}" width="80" height="80"></canvas>
                                        <div class="mt-2 text-center text-xs font-semibold">Skill Coverage</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <canvas id="donutExp${idx}" width="80" height="80"></canvas>
                                        <div class="mt-2 text-center text-xs font-semibold">Exp. Match</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <canvas id="donutEdu${idx}" width="80" height="80"></canvas>
                                        <div class="mt-2 text-center text-xs font-semibold">Education Match</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <canvas id="donutCert${idx}" width="80" height="80"></canvas>
                                        <div class="mt-2 text-center text-xs font-semibold">Certifications</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <canvas id="donutRole${idx}" width="80" height="80"></canvas>
                                        <div class="mt-2 text-center text-xs font-semibold">Role Match</div>
                                    </div>
                                </div>
                                <p><strong>Resume Match:</strong> <span class=\"font-bold text-blue-600\">${r.match_percentage}%</span></p>
                                <p><strong>Explanation:</strong> ${r.explanation}</p>
                            </div>`;
                        }
                    }).join('');
                        resultDiv.innerHTML = allResumesHTML;
                    // Robust donut rendering: wait for all canvases to exist
                    function renderAllDonutsWhenReady(resumes) {
                        let tries = 0;
                        function tryRender() {
                            let allReady = resumes.every((r, idx) => document.getElementById(`donutMatch${idx}`));
                            if (allReady || tries > 20) {
                                resumes.forEach((r, idx) => {
                                    if (!r.error) {
                                        const skillCoverage = r.total_skills > 0 ? Math.round((r.skills_matched / r.total_skills) * 100) : 0;
                                        renderDonut(`donutMatch${idx}`, r.match_percentage || 0, '#2563eb');
                                        renderDonut(`donutSkills${idx}`, skillCoverage, '#22c55e');
                                        renderDonut(`donutExp${idx}`, r.experience_match || 0, '#f59e42');
                                        renderDonut(`donutEdu${idx}`, r.education_match || 0, '#a855f7');
                                        renderDonut(`donutCert${idx}`, r.certifications_match || 0, '#0ea5e9');
                                        renderDonut(`donutRole${idx}`, r.role_match || 0, '#f43f5e');
                                    }
                                });
                            } else {
                                tries++;
                                setTimeout(tryRender, 100);
                            }
                        }
                        tryRender();
                    }
                    renderAllDonutsWhenReady(result.resumes);
                } else if (result.resume_error) {
                        resultCardDiv.classList.remove('hidden');
                        resultDiv.innerHTML = `<p class="text-red-500"><strong>Error:</strong> ${result.resume_error}</p>`;
                }
                } else if (activeTab === 'audio') {
                if (result.transcription || result.audio_error) {
                        resultCardDiv.classList.remove('hidden');
                    if (result.transcription) {
                            resultDiv.innerHTML = `
                            <div class="space-y-4">
                                <!-- Top row: Technical Score and Explanation -->
                            <div class="flex flex-col sm:flex-row gap-6">
                                <div class="flex-1">
                                    <p class="text-2xl font-bold text-blue-700 mb-2">Technical Score: ${result.technical_score}/10</p>
                                    <p class="mb-4 text-gray-700"><strong>Technical Explanation:</strong> ${result.technical_explanation}</p>
                                        <div class="grid grid-cols-1 sm:grid-cols-6 md:grid-cols-6 gap-8 my-8" id="scoreDonuts">
                                            <div class="flex flex-col items-center">
                                                <canvas id="donutRelevance" width="120" height="120"></canvas>
                                                <div class="mt-2 text-center text-sm font-semibold">Relevance of Tech</div>
                                            </div>
                                            <div class="flex flex-col items-center">
                                                <canvas id="donutConfidence" width="120" height="120"></canvas>
                                                <div class="mt-2 text-center text-sm font-semibold">Confidence</div>
                                            </div>
                                            <div class="flex flex-col items-center">
                                                <canvas id="donutCommunication" width="120" height="120"></canvas>
                                                <div class="mt-2 text-center text-sm font-semibold">Communication</div>
                                            </div>
                                            <div class="flex flex-col items-center">
                                                <canvas id="donutClarity" width="120" height="120"></canvas>
                                                <div class="mt-2 text-center text-sm font-semibold">Clarity</div>
                                            </div>
                                            <div class="flex flex-col items-center">
                                                <canvas id="donutProblemSolving" width="120" height="120"></canvas>
                                                <div class="mt-2 text-center text-sm font-semibold">Problem-Solving</div>
                                            </div>
                                            <div class="flex flex-col items-center">
                                                <canvas id="donutTechnicalKnowledge" width="120" height="120"></canvas>
                                                <div class="mt-2 text-center text-sm font-semibold">Technical Knowledge</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Per-question grading -->
                            ${Array.isArray(result.question_grades) && result.question_grades.length > 0 ? `
                            <details class="mt-4">
                                <summary class="cursor-pointer text-lg font-semibold mb-2">Show Per-Question Grading</summary>
                                <div class="overflow-x-auto mt-2">
                                    <table class="min-w-full text-sm border border-gray-200 rounded">
                                        <thead>
                                            <tr class="bg-gray-100">
                                                <th class="px-3 py-2 border-b text-left">Question</th>
                                                <th class="px-3 py-2 border-b text-left">Candidate Answer</th>
                                                <th class="px-3 py-2 border-b text-left">Score</th>
                                                <th class="px-3 py-2 border-b text-left">Explanation</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${result.question_grades.map(q => `
                                            <tr>
                                                <td class="px-3 py-2 border-b align-top">${q.question}</td>
                                                <td class="px-3 py-2 border-b align-top">${q.answer}</td>
                                                <td class="px-3 py-2 border-b align-top font-bold text-blue-600">${q.score}/10</td>
                                                <td class="px-3 py-2 border-b align-top">${q.explanation}</td>
                                            </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </details>
                            ` : ''}
                            <!-- Conversation History -->
                                <details class="mt-2">
                                    <summary class="cursor-pointer text-sm text-gray-600">Show Conversation History</summary>
                                    <pre class="mt-2 text-sm text-gray-700 bg-gray-100 rounded p-2 overflow-x-auto" style="white-space: pre-wrap;">${result.separated_dialog ? result.separated_dialog : 'Not available.'}</pre>
                                </details>
                        </div>
                    `;
                    // Render the donut charts
                    setTimeout(() => {
                        function renderDonut(canvasId, value, color) {
                            window.donutCharts = window.donutCharts || {};
                            const canvas = document.getElementById(canvasId);
                            if (!canvas) return;
                            // Destroy previous chart if exists
                            if (window.donutCharts[canvasId]) {
                                window.donutCharts[canvasId].destroy();
                            }
                            window.donutCharts[canvasId] = new Chart(canvas.getContext('2d'), {
                                type: 'doughnut',
                                data: {
                                    datasets: [{
                                        data: [value, 100 - value],
                                        backgroundColor: [color, '#e5e7eb'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    cutout: '60%',
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: { enabled: false }
                                    }
                                },
                                plugins: [{
                                    id: 'centerText',
                                    afterDraw: chart => {
                                        const {ctx, chartArea: {width, height}} = chart;
                                        ctx.save();
                                        ctx.font = 'bold 1rem Inter, sans-serif';
                                        ctx.textAlign = 'center';
                                        ctx.textBaseline = 'middle';
                                        ctx.fillStyle = color;
                                        ctx.fillText(`${value}%`, width / 2, height / 2);
                                        ctx.restore();
                                    }
                                }]
                            });
                        }
                        renderDonut('donutRelevance', (result.relevance_score || 0) * 10, '#2563eb');
                        renderDonut('donutConfidence', (result.confidence_score || 0) * 10, '#3b82f6');
                        renderDonut('donutCommunication', (result.communication_score || 0) * 10, '#60a5fa');
                        renderDonut('donutClarity', (result.clarity_score || 0) * 10, '#93c5fd');
                        renderDonut('donutProblemSolving', (result.problem_solving_score || 0) * 10, '#38bdf8');
                        renderDonut('donutTechnicalKnowledge', (result.depth_score || 0) * 10, '#0ea5e9');
                    }, 100);
                } else if (result.audio_error) {
                        resultDiv.innerHTML = `<p class="text-red-500"><strong>Error:</strong> ${result.audio_error}</p>`;
                }
            }
            }

            // Save button event listener (remove previous, add new)
            if (saveBtnId) {
                const saveBtn = document.getElementById(saveBtnId);
                if (saveBtn) {
                    saveBtn.replaceWith(saveBtn.cloneNode(true));
                    const newSaveBtn = document.getElementById(saveBtnId);
                    newSaveBtn.addEventListener('click', async function() {
                        // Gather the latest analysis result from the correct resultDiv
                        let resumeHTML = '';
                        if (activeTab === 'resume') {
                            const blocks = resultDiv.querySelectorAll('div.mb-4');
                            if (blocks.length > 0) {
                                resumeHTML = Array.from(blocks).map(b => b.outerHTML).join('');
                            } else {
                                resumeHTML = resultDiv.innerHTML;
                            }
                        }
                        let audioHTML = '';
                        if (activeTab === 'audio') {
                            audioHTML = resultDiv.innerHTML;
                        }
                        const metaInfo = metaInfoDiv.innerHTML;
                        const timestamp = new Date().toLocaleString();
                        let technology = '';
                        let audioFileName = '';
                        if (activeTab === 'audio') {
                            const techInput = document.getElementById('technology');
                            if (techInput) technology = techInput.value;
                            const audioInput = document.getElementById('audio');
                            if (audioInput && audioInput.files && audioInput.files.length > 0) {
                                audioFileName = audioInput.files[0].name;
                            }
                        }
                        const data = { resumeHTML, audioHTML, metaInfo, timestamp, technology, audioFileName, rawData: latestAnalysisResult };
                        try {
                            newSaveBtn.disabled = true;
                            newSaveBtn.innerHTML = '<i data-lucide="save" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Saving...';
                            const response = await fetch('/save_analysis', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(data)
                            });
                            const result = await response.json();
                            if (result.status === 'success') {
                                newSaveBtn.innerHTML = '<i data-lucide="save" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Saved';
                                newSaveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                                newSaveBtn.classList.add('bg-green-700', 'cursor-default');
                                newSaveBtn.disabled = true;
                                lucide.createIcons();
                                showToast('Analysis saved successfully!', 'success');
                            } else {
                                newSaveBtn.innerHTML = '<i data-lucide="save" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Save';
                                newSaveBtn.disabled = false;
                                showToast('Failed to save analysis.', 'error');
                            }
                        } catch (err) {
                            newSaveBtn.innerHTML = '<i data-lucide="save" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Save';
                            newSaveBtn.disabled = false;
                            showToast('Error saving analysis.', 'error');
                        }
                    });
                }
            }

            // Shortlist button event listener (remove previous, add new)
            if (shortlistBtnId) {
                const shortlistBtn = document.getElementById(shortlistBtnId);
                if (shortlistBtn) {
                    shortlistBtn.replaceWith(shortlistBtn.cloneNode(true));
                    const newShortlistBtn = document.getElementById(shortlistBtnId);
                    newShortlistBtn.addEventListener('click', async function() {
                        let formData = new FormData();
                        let timestamp = new Date().toLocaleString();
                        let found = false;
                        let matchPercent = 0;
                        if (activeTab === 'audio') {
                            const techResumeInput = document.getElementById('tech_resume');
                            if (!techResumeInput.files || techResumeInput.files.length === 0) {
                                const el = document.getElementById('tech_resume_error');
                                if (el) el.classList.remove('hidden');
                                newShortlistBtn.disabled = false;
                                return;
                            }
                            formData.append('shortlist_resume', techResumeInput.files[0]);
                            found = true;
                            // Technical Proficiency: use technical_score * 10
                            if (latestAnalysisResult && latestAnalysisResult.technical_score !== undefined) {
                                matchPercent = latestAnalysisResult.technical_score * 10;
                            }
                        } else if (activeTab === 'resume') {
                            const resumeInputs = document.querySelectorAll('.resume-file');
                            resumeInputs.forEach(input => {
                                if (input.files && input.files.length > 0 && !found) {
                                    formData.append('shortlist_resume', input.files[0]);
                                    found = true;
                                }
                            });
                            // Resume Match: use first resume's match_percentage
                            if (latestAnalysisResult && Array.isArray(latestAnalysisResult.resumes) && latestAnalysisResult.resumes.length > 0) {
                                matchPercent = latestAnalysisResult.resumes[0].match_percentage || 0;
                            }
                        }
                        formData.append('timestamp', timestamp);
                        formData.append('match_percentage', matchPercent);
                        try {
                            newShortlistBtn.disabled = true;
                            newShortlistBtn.innerHTML = '<i data-lucide="star" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Shortlisting...';
                            const response = await fetch('/shortlist_resume', {
                                method: 'POST',
                                body: formData
                            });
                            const result = await response.json();
                            if (result.status === 'success') {
                                newShortlistBtn.innerHTML = '<i data-lucide="star" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Shortlisted';
                                newShortlistBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                                newShortlistBtn.classList.add('bg-yellow-600', 'cursor-default');
                                newShortlistBtn.disabled = true;
                                lucide.createIcons();
                                showToast('Resume shortlisted!', 'shortlist');
                            } else {
                                newShortlistBtn.innerHTML = '<i data-lucide="star" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Shortlist';
                                newShortlistBtn.disabled = false;
                            }
                        } catch (err) {
                            newShortlistBtn.innerHTML = '<i data-lucide="star" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Shortlist';
                            newShortlistBtn.disabled = false;
                        }
                    });
                }
            }

            // After results are rendered (after fetch and DOM update):
            // Hide loader, show results and buttons in right column
            if (loaderId && resultsId && actionBtnsId) {
                loaderElem = document.getElementById(loaderId);
                if (loaderElem) loaderElem.classList.add('hidden');
                const resultsElem = document.getElementById(resultsId);
                if (resultsElem) resultsElem.classList.remove('hidden');
                const actionBtnsElem = document.getElementById(actionBtnsId);
                if (actionBtnsElem) actionBtnsElem.classList.remove('hidden');
            }

            // Re-enable all tab buttons after loading
            tabIds.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = false;
            });
        });

        // Hide error when user starts typing or selects a file
        // Resume tab
        const jobDescInput = document.getElementById('job_description');
        jobDescInput.addEventListener('input', () => {
            if (jobDescInput.value.trim()) {
                const el = document.getElementById('job_description_error');
                if (el) el.classList.add('hidden');
            }
        });
        // Hide error when any resume input changes
        document.getElementById('resume-inputs').addEventListener('change', (e) => {
            if (e.target.classList.contains('resume-file')) {
                let hasFile = false;
                document.querySelectorAll('.resume-file').forEach(input => {
                    if (input.files && input.files.length > 0) hasFile = true;
                });
                if (hasFile) {
                    const el = document.getElementById('resume_error');
                    if (el) el.classList.add('hidden');
                }
            }
        });
        // Technical tab
        const audioInput = document.getElementById('audio');
        const techInput = document.getElementById('technology');
        audioInput.addEventListener('change', () => {
            if (audioInput.files && audioInput.files.length > 0) {
                const el = document.getElementById('audio_error');
                if (el) el.classList.add('hidden');
            }
        });
        techInput.addEventListener('change', () => {
            if (techInput.value) {
                const el = document.getElementById('technology_error');
                if (el) el.classList.add('hidden');
            }
        });
        if (techResumeInput) {
            techResumeInput.addEventListener('change', () => {
                if (techResumeInput.files && techResumeInput.files.length > 0) {
                    const el = document.getElementById('tech_resume_error');
                    if (el) el.classList.add('hidden');
                }
            });
        }

        // Job Description Save/Load Logic
        function updateSavedDescriptionsDropdown() {
            const dropdown = document.getElementById('savedDescriptions');
            const saved = JSON.parse(localStorage.getItem('jobDescriptions') || '[]');
            dropdown.innerHTML = '';
            if (saved.length > 0) {
                dropdown.classList.remove('hidden');
                dropdown.innerHTML = '<option value="">Select a saved job description...</option>' +
                    saved.map((desc, i) => `<option value="${i}">${desc.substring(0, 40).replace(/\n/g, ' ')}${desc.length > 40 ? '...' : ''}</option>`).join('');
            } else {
                dropdown.classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateSavedDescriptionsDropdown();
            document.getElementById('savedDescriptions').addEventListener('change', function() {
                const idx = this.value;
                if (idx !== '') {
                    const saved = JSON.parse(localStorage.getItem('jobDescriptions') || '[]');
                    document.getElementById('job_description').value = saved[idx];
                    const el = document.getElementById('job_description_error');
                    if (el) el.classList.add('hidden');
                }
            });
        });

        document.getElementById('jobDocxUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.name.endsWith('.docx')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    mammoth.extractRawText({arrayBuffer: event.target.result})
                        .then(function(result) {
                            const jdText = result.value;
                            document.getElementById('job_description').value = jdText;
                            const el = document.getElementById('job_description_error');
                            if (el) el.classList.add('hidden');
                        })
                        .catch(function(err) {
                            alert('Could not read the Word file.');
                        });
                };
                reader.readAsArrayBuffer(file);
            } else if (file) {
                alert('Only .docx files are supported.');
                e.target.value = '';
            }
        });

        document.getElementById('techQuestionsUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.name.endsWith('.docx')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    mammoth.extractRawText({arrayBuffer: event.target.result})
                        .then(function(result) {
                            document.getElementById('tech_questions').value = result.value;
                        })
                        .catch(function(err) {
                            alert('Could not read the Word file.');
                        });
                };
                reader.readAsArrayBuffer(file);
            } else if (file && file.name.endsWith('.txt')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('tech_questions').value = event.target.result;
                };
                reader.readAsText(file);
            } else if (file) {
                alert('Only .docx or .txt files are supported.');
                e.target.value = '';
            }
        });

        // Resume dynamic add/remove logic
        document.getElementById('add-resume-btn').addEventListener('click', function() {
            const container = document.getElementById('resume-inputs');
            const row = document.createElement('div');
            row.className = 'flex items-center mb-2 resume-input-row gap-2';
            const idx = container.querySelectorAll('.resume-input-row').length;
            row.innerHTML = `
              <label class="relative cursor-pointer bg-white border border-gray-300 rounded px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-blue-50 transition w-full" tabindex="0">
                Choose File
                <input type="file" name="resume" accept=".pdf,.docx" class="absolute left-0 top-0 w-full h-full opacity-0 cursor-pointer resume-file" onchange="document.getElementById('resumeFileName${idx}').textContent = this.files[0]?.name || 'No file chosen'">
              </label>
              <span class="text-sm text-gray-500" id="resumeFileName${idx}">No file chosen</span>
              <button type="button" class="ml-2 remove-resume-btn" tabindex="-1"><i data-lucide="trash-2" class="w-5 h-5 text-red-500"></i></button>
            `;
            container.appendChild(row);
            lucide.createIcons();
            updateRemoveButtons();
        });

        function updateRemoveButtons() {
            const rows = document.querySelectorAll('.resume-input-row');
            rows.forEach((row, idx) => {
                const btn = row.querySelector('.remove-resume-btn');
                if (btn) {
                    btn.classList.toggle('hidden', rows.length === 1);
                    btn.onclick = function() {
                        if (rows.length > 1) {
                            row.remove();
                            updateRemoveButtons();
                        }
                    };
                }
            });
        }
        updateRemoveButtons();

        console.log('Calling lucide.createIcons()');
        lucide.createIcons();

        // Render Saved Analyses
        async function renderSavedAnalyses() {
            // Always hide the results modal when viewing saved analyses
            const resultsOverlay = document.getElementById('results-overlay');
            resultsOverlay.classList.add('hidden');
            resultsOverlay.style.display = 'none';
            resultsOverlay.style.visibility = 'hidden';
            const list = document.getElementById('saved_analyses_list');
            list.innerHTML = '<div class="text-gray-400 text-center">Loading...</div>';
            let files = [];
            try {
                const resp = await fetch('/list_saved_analyses');
                files = await resp.json();
            } catch (e) {
                list.innerHTML = '<div class="text-red-500 text-center">Failed to load saved analyses.</div>';
                return;
            }
            if (!files.length) {
                list.innerHTML = '<div class="text-gray-500 text-center">No saved analyses yet.</div>';
                return;
            }
            list.innerHTML = '';
            for (const file of files) {
                // Fetch file content
                let data = null;
                try {
                    const resp = await fetch(`/get_saved_analysis/${file.id}`);
                    data = await resp.json();
                } catch (e) {
                    data = { metaInfo: '', resumeHTML: '<div class="text-red-500">Failed to load file.</div>', audioHTML: '' };
                }
                const div = document.createElement('div');
                div.className = 'bg-white p-6 rounded-lg shadow-md mb-4';
                div.setAttribute('data-card-id', file.id);
                // Resume summary extraction for saved analyses
                let resumeSummary = (data.resumeHTML || (file.data && file.data.resumeHTML)) || '';
                let audioSummary = (data.audioHTML || (file.data && file.data.audioHTML)) || '';
                // Make donut chart canvas IDs unique by including file.id
                resumeSummary = resumeSummary.replace(/id="donutMatch(\d+)"/g, `id="donutMatch_${file.id}_$1"`)
                                           .replace(/id="donutSkills(\d+)"/g, `id="donutSkills_${file.id}_$1"`)
                                           .replace(/id="donutExp(\d+)"/g, `id="donutExp_${file.id}_$1"`)
                                           .replace(/id="donutEdu(\d+)"/g, `id="donutEdu_${file.id}_$1"`)
                                           .replace(/id="donutCert(\d+)"/g, `id="donutCert_${file.id}_$1"`)
                                           .replace(/id="donutRole(\d+)"/g, `id="donutRole_${file.id}_$1"`);
                // Also for technical tab
                resumeSummary = resumeSummary.replace(/id="donutRelevance"/g, `id="donutRelevance_${file.id}"`)
                                           .replace(/id="donutConfidence"/g, `id="donutConfidence_${file.id}"`)
                                           .replace(/id="donutCommunication"/g, `id="donutCommunication_${file.id}"`)
                                           .replace(/id="donutClarity"/g, `id="donutClarity_${file.id}"`)
                                           .replace(/id="donutProblemSolving"/g, `id="donutProblemSolving_${file.id}"`)
                                           .replace(/id="donutTechnicalKnowledge"/g, `id="donutTechnicalKnowledge_${file.id}"`);
                audioSummary = audioSummary.replace(/id="donutRelevance"/g, `id="donutRelevance_${file.id}"`)
                                         .replace(/id="donutConfidence"/g, `id="donutConfidence_${file.id}"`)
                                         .replace(/id="donutCommunication"/g, `id="donutCommunication_${file.id}"`)
                                         .replace(/id="donutClarity"/g, `id="donutClarity_${file.id}"`)
                                         .replace(/id="donutProblemSolving"/g, `id="donutProblemSolving_${file.id}"`)
                                         .replace(/id="donutTechnicalKnowledge"/g, `id="donutTechnicalKnowledge_${file.id}"`);
                // Add technology and audio filename if present
                let metaInfoBlock = '';
                const meta = file.data || {};
                if ((meta.technology && meta.technology !== '') || (meta.audioFileName && meta.audioFileName !== '')) {
                    metaInfoBlock += '<div class="mb-4 text-sm text-gray-700">';
                    if (meta.technology && meta.technology !== '') {
                        metaInfoBlock += `<span class="block"><strong>Selected Technology:</strong> ${meta.technology}</span>`;
                    }
                    if (meta.audioFileName && meta.audioFileName !== '') {
                        metaInfoBlock += `<span class="block"><strong>Audio File:</strong> ${meta.audioFileName}</span>`;
                    }
                    metaInfoBlock += '</div>';
                }
                div.innerHTML = `
                    <div class=\"flex justify-between items-center mb-2\">\n                        <div class=\"text-xs text-gray-400\">Saved: ${file.timestamp}</div>\n                        <button type=\"button\" class=\"text-red-500 text-xs font-semibold\" onclick=\"event.stopPropagation(); deleteSavedAnalysis('${file.id}')\">Delete</button>\n                    </div>\n                    ${metaInfoBlock}\n                    ${resumeSummary}\n                    ${audioSummary}\n                `;
                list.appendChild(div);
                if (meta.rawData) {
                    reRenderDonuts(div, meta.rawData, file.id);
                }
            }
        }

        let pendingDeleteFilename = null;
        let wasResultsOverlayOpen = false;
        window.deleteSavedAnalysis = function(filename) {
            pendingDeleteFilename = filename;
            // Set modal title based on active tab
            const deleteModalTitle = document.querySelector('#delete-modal .text-lg');
            if (activeTab === 'shortlisted') {
                deleteModalTitle.textContent = 'Delete this shortlisted analysis?';
            } else {
                deleteModalTitle.textContent = 'Delete this saved analysis?';
            }
            document.getElementById('delete-modal').classList.remove('hidden');
            document.getElementById('analyze-btn-container').classList.add('hidden');

            const resultsOverlay = document.getElementById('results-overlay');

            if (activeTab === 'saved') {
                wasResultsOverlayOpen = false;
                resultsOverlay.classList.add('hidden');
                resultsOverlay.style.display = 'none';
                resultsOverlay.style.visibility = 'hidden';
                // Extra defensive: force hide overlay parent as well
                setTimeout(() => {
                    resultsOverlay.classList.add('hidden');
                    resultsOverlay.style.display = 'none';
                    resultsOverlay.style.visibility = 'hidden';
                }, 10);
                return;
            }

            wasResultsOverlayOpen = !resultsOverlay.classList.contains('hidden');
            resultsOverlay.classList.add('hidden');
            resultsOverlay.style.display = 'none';
            resultsOverlay.style.visibility = 'hidden';
        }

        document.getElementById('delete-modal-cancel').onclick = function() {
            document.getElementById('delete-modal').classList.add('hidden');
            pendingDeleteFilename = null;
            // Always hide results modal when closing delete modal
            const resultsOverlay = document.getElementById('results-overlay');
            resultsOverlay.classList.add('hidden');
            resultsOverlay.style.display = 'none';
            resultsOverlay.style.visibility = 'hidden';
            if (activeTab === 'resume' || activeTab === 'audio') {
                document.getElementById('analyze-btn-container').classList.remove('hidden');
            }
            // Restore results modal if it was open and not on saved tab
            if (activeTab === 'saved') {
                resultsOverlay.classList.add('hidden');
                resultsOverlay.style.display = 'none';
                resultsOverlay.style.visibility = 'hidden';
                wasResultsOverlayOpen = false;
                // Extra defensive: force hide overlay parent as well
                setTimeout(() => {
                    resultsOverlay.classList.add('hidden');
                    resultsOverlay.style.display = 'none';
                    resultsOverlay.style.visibility = 'hidden';
                }, 10);
            } else if (wasResultsOverlayOpen) {
                resultsOverlay.classList.remove('hidden');
                resultsOverlay.style.display = '';
                resultsOverlay.style.visibility = 'visible';
            }
            wasResultsOverlayOpen = false;
        };
        document.getElementById('delete-modal-confirm').onclick = async function() {
            if (!pendingDeleteFilename) return;
            document.getElementById('delete-modal').classList.add('hidden');
            // Always hide results modal when closing delete modal
            const resultsOverlay = document.getElementById('results-overlay');
            resultsOverlay.classList.add('hidden');
            resultsOverlay.style.display = 'none';
            resultsOverlay.style.visibility = 'hidden';
            if (activeTab === 'resume' || activeTab === 'audio') {
                document.getElementById('analyze-btn-container').classList.remove('hidden');
            }
            // Restore results modal if it was open and not on saved tab
            if (activeTab === 'saved') {
                resultsOverlay.classList.add('hidden');
                resultsOverlay.style.display = 'none';
                resultsOverlay.style.visibility = 'hidden';
                wasResultsOverlayOpen = false;
                // Extra defensive: force hide overlay parent as well
                setTimeout(() => {
                    resultsOverlay.classList.add('hidden');
                    resultsOverlay.style.display = 'none';
                    resultsOverlay.style.visibility = 'hidden';
                }, 10);
            } else if (wasResultsOverlayOpen) {
                resultsOverlay.classList.remove('hidden');
                resultsOverlay.style.display = '';
                resultsOverlay.style.visibility = 'visible';
            }
            wasResultsOverlayOpen = false;
            try {
                let deleteUrl = '';
                if (activeTab === 'shortlisted') {
                    deleteUrl = `/delete_shortlisted/${pendingDeleteFilename}`;
                } else {
                    deleteUrl = `/delete_saved_analysis/${pendingDeleteFilename}`;
                }
                await fetch(deleteUrl, { method: 'DELETE' });
                showToast('Deleted successfully.', 'success');
                // Remove the deleted item from the DOM instead of re-rendering everything
                const card = document.querySelector(`[data-card-id="${pendingDeleteFilename}"]`);
                if (card) card.remove();
                const list = (activeTab === 'shortlisted') ? document.getElementById('shortlisted-list') : document.getElementById('saved_analyses_list');
                if (list.children.length === 0) {
                    list.innerHTML = `<div class="text-gray-500 text-center">No ${activeTab === 'shortlisted' ? 'shortlisted resumes' : 'saved analyses'} yet.</div>`;
                }
            } catch (e) {
                showToast('Error deleting analysis.', 'error');
            }
            pendingDeleteFilename = null;
        };

        // --- Re-render donuts for saved analyses ---
        function reRenderDonuts(containerElement, rawData, fileId) {
            // For Technical Proficiency charts
            if (rawData.technical_score) {
                const techCanvasIds = ['donutRelevance', 'donutConfidence', 'donutCommunication', 'donutClarity', 'donutProblemSolving', 'donutTechnicalKnowledge'];
                const techScores = [
                    (rawData.relevance_score || 0) * 10,
                    (rawData.confidence_score || 0) * 10,
                    (rawData.communication_score || 0) * 10,
                    (rawData.clarity_score || 0) * 10,
                    (rawData.problem_solving_score || 0) * 10,
                    (rawData.depth_score || 0) * 10
                ];
                const techColors = ['#2563eb', '#3b82f6', '#60a5fa', '#93c5fd', '#38bdf8', '#0ea5e9'];
                
                techCanvasIds.forEach((id, i) => {
                    const canvas = containerElement.querySelector(`#${id}_${fileId}`);
                    if (canvas) {
                        renderDonut(`${id}_${fileId}`, techScores[i], techColors[i]);
                    }
                });
            }

            // For Resume Match charts
            if (Array.isArray(rawData.resumes)) {
                rawData.resumes.forEach((r, idx) => {
                    if (r.error) return;
                    
                    const resumeCanvasIds = [`donutMatch_${fileId}_${idx}`, `donutSkills_${fileId}_${idx}`, `donutExp_${fileId}_${idx}`, `donutEdu_${fileId}_${idx}`, `donutCert_${fileId}_${idx}`, `donutRole_${fileId}_${idx}`];
                    const skillCoverage = r.total_skills > 0 ? Math.round((r.skills_matched / r.total_skills) * 100) : 0;
                    const resumeScores = [
                        r.match_percentage || 0,
                        skillCoverage,
                        r.experience_match || 0,
                        r.education_match || 0,
                        r.certifications_match || 0,
                        r.role_match || 0
                    ];
                    const resumeColors = ['#2563eb', '#22c55e', '#f59e42', '#a855f7', '#0ea5e9', '#f43f5e'];

                    resumeCanvasIds.forEach((id, i) => {
                         const canvas = containerElement.querySelector(`#${id}`);
                         if(canvas) {
                            renderDonut(id, resumeScores[i], resumeColors[i]);
                         }
                    });
                });
            }
        }

        // Toast notification logic
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            let icon = '';
            toast.className = 'fixed top-6 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded shadow-lg text-center text-sm font-semibold opacity-0 pointer-events-none transition-opacity duration-500 flex items-center gap-2';
            if (type === 'success') {
                toast.classList.add('bg-green-600', 'text-white');
                icon = '<i data-lucide="check-circle" class="w-5 h-5 mr-1"></i>';
            } else if (type === 'error') {
                toast.classList.add('bg-red-600', 'text-white');
                if (message.toLowerCase().includes('deleted')) {
                    icon = '<i data-lucide="trash-2" class="w-5 h-5 mr-1"></i>';
                } else {
                    icon = '<i data-lucide="x-circle" class="w-5 h-5 mr-1"></i>';
                }
            } else if (type === 'shortlist' || type === 'warning') {
                toast.classList.add('bg-yellow-500', 'text-white');
                icon = '<i data-lucide="star" class="w-5 h-5 mr-1"></i>';
            } else {
                toast.classList.add('bg-gray-700', 'text-white');
                icon = '<i data-lucide="info" class="w-5 h-5 mr-1"></i>';
            }
            toast.innerHTML = icon + '<span>' + message + '</span>';
            setTimeout(() => { toast.style.opacity = '1'; lucide.createIcons(); }, 10);
            toast.style.opacity = '1';
            setTimeout(() => {
                toast.style.opacity = '0';
            }, 2000);
        }

        // --- Interview Question Generator Tab Logic ---
        function setTabNavigationEnabled(enabled) {
            const loader = document.getElementById('question-gen-loader');
            const loaderVisible = loader ? !loader.classList.contains('hidden') : false;
            console.log('setTabNavigationEnabled called with:', enabled, '| Loader visible:', loaderVisible);
            // Only allow disabling if loader is visible, otherwise always enable
            if (!enabled && !loaderVisible) {
                // Don't disable tabs if loader is not visible
                enabled = true;
            }
            const tabIds = ['tab-resume', 'tab-audio', 'tab-question-gen', 'tab-saved', 'tab-shortlisted'];
            tabIds.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    // Only disable if not the active tab
                    if (id !== `tab-${activeTab}`) {
                        btn.disabled = !enabled;
                        if (!enabled) {
                            btn.classList.add('opacity-50', 'pointer-events-none');
                        } else {
                            btn.classList.remove('opacity-50', 'pointer-events-none');
                        }
                    } else {
                        // Always keep the active tab enabled and styled
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'pointer-events-none');
                    }
                }
            });
        }
        document.getElementById('generate-questions-btn').addEventListener('click', async function() {
            // Validation for Interview Question Generator
            let valid = true;
            const jd = document.getElementById('question_gen_jd').value.trim();
            const numQuestions = parseInt(document.getElementById('num_questions').value, 10) || 5;
            const jdError = document.getElementById('question_gen_jd_error');
            const numQuestionsError = document.getElementById('num_questions_error');
            const level = document.querySelector('input[name="question_level"]:checked').value;
            if (!jd) {
                jdError.classList.remove('hidden');
                valid = false;
            } else {
                jdError.classList.add('hidden');
            }
            if (numQuestions < 1 || numQuestions > 20) {
                numQuestionsError.classList.remove('hidden');
                valid = false;
                numQuestionsError.classList.add('hidden');
            }
            if (!valid) return;
            const loader = document.getElementById('question-gen-loader');
            const resultDiv = document.getElementById('question-gen-result');
            const listPre = document.getElementById('question-gen-list');
            const loaderElem = document.getElementById('question-gen-loader');
            if (loaderElem) loaderElem.classList.remove('hidden');
            resultDiv.classList.add('hidden');
            listPre.textContent = '';
            setTabNavigationEnabled(false); // Disable tabs while loading
            try {
                const resp = await fetch('/generate_questions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ technology: '', job_description: jd, num_questions: numQuestions, level: level })
                });
                const data = await resp.json();
                const loaderElem = document.getElementById('question-gen-loader');
                if (loaderElem) loaderElem.classList.add('hidden');
                setTabNavigationEnabled(true); // Enable tabs after loading
                if (data.questions && Array.isArray(data.questions)) {
                    listPre.textContent = data.questions.map((q, i) => `${i+1}. ${q}`).join('\n');
                    resultDiv.classList.remove('hidden');
                } else {
                    showToast(data.error || 'Failed to generate questions.', 'error');
                }
            } catch (e) {
                const loaderElem = document.getElementById('question-gen-loader');
                if (loaderElem) loaderElem.classList.add('hidden');
                setTabNavigationEnabled(true); // Enable tabs after loading
                showToast('Error generating questions.', 'error');
            }
        });
        document.getElementById('copy-questions-btn').addEventListener('click', function() {
            const listPre = document.getElementById('question-gen-list');
            navigator.clipboard.writeText(listPre.textContent).then(() => {
                showToast('Questions copied!', 'success');
            });
        });
        document.getElementById('download-questions-btn').addEventListener('click', function() {
            const listPre = document.getElementById('question-gen-list');
            const blob = new Blob([listPre.textContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'interview_questions.txt';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
        });

        // Interview Question Generator JD .docx upload logic
        document.getElementById('question_gen_jd_upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.name.endsWith('.docx')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    mammoth.extractRawText({arrayBuffer: event.target.result})
                        .then(function(result) {
                            document.getElementById('question_gen_jd').value = result.value;
                            const el = document.getElementById('question_gen_jd_error');
                            if (el) el.classList.add('hidden');
                        })
                        .catch(function(err) {
                            alert('Could not read the Word file.');
                        });
                };
                reader.readAsArrayBuffer(file);
            } else if (file) {
                alert('Only .docx files are supported.');
                e.target.value = '';
            }
        });

        // Hide error when user starts typing or selects a file in Interview Question Generator
        /* document.getElementById('question_gen_technology').addEventListener('change', () => {
            if (document.getElementById('question_gen_technology').value) {
                document.getElementById('question_gen_technology_error').classList.add('hidden');
            }
        }); */
        document.getElementById('question_gen_jd').addEventListener('input', () => {
            if (document.getElementById('question_gen_jd').value.trim()) {
                const el = document.getElementById('question_gen_jd_error');
                if (el) el.classList.add('hidden');
            }
        });

        // Prevent Enter in num_questions from submitting the form
        document.getElementById('num_questions').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
            }
        });

        // Live validation for number of questions input
        const numQuestionsInput = document.getElementById('num_questions');
        const numQuestionsError = document.getElementById('num_questions_error');
        numQuestionsInput.addEventListener('input', function() {
            const value = parseInt(numQuestionsInput.value, 10);
            if (value < 1 || value > 20) {
                numQuestionsError.classList.remove('hidden');
            } else {
                numQuestionsError.classList.add('hidden');
            }
        });

        // Donut chart renderer for resume match
        function renderDonut(canvasId, value, color) {
            window.donutCharts = window.donutCharts || {};
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            // Destroy previous chart if exists
            if (window.donutCharts[canvasId]) {
                window.donutCharts[canvasId].destroy();
            }
            window.donutCharts[canvasId] = new Chart(canvas.getContext('2d'), {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [value, 100 - value],
                        backgroundColor: [color, '#e5e7eb'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '60%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                },
                plugins: [{
                    id: 'centerText',
                    afterDraw: chart => {
                        const {ctx, chartArea: {width, height}} = chart;
                        ctx.save();
                        ctx.font = 'bold 1rem Inter, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillStyle = color;
                        ctx.fillText(`${value}%`, width / 2, height / 2);
                        ctx.restore();
                    }
                }]
            });
        }

        // Fetch and display shortlisted resumes in the new tab
        async function renderShortlistedResumes() {
            const list = document.getElementById('shortlisted-list');
            list.innerHTML = '<div class="text-gray-400 text-center">Loading...</div>';
            let files = [];
            try {
                const resp = await fetch('/list_shortlisted');
                files = await resp.json();
            } catch (e) {
                list.innerHTML = '<div class="text-red-500 text-center">Failed to load shortlisted resumes.</div>';
                return;
            }
            if (!files.length) {
                list.innerHTML = '<div class="text-gray-500 text-center">No shortlisted resumes yet.</div>';
                return;
            }
            list.innerHTML = '';
            for (const file of files) {
                let data = null;
                try {
                    const resp = await fetch(`/get_shortlisted/${file.id}`);
                    data = await resp.json();
                } catch (e) {
                    data = { metaInfo: '', resumeHTML: '<div class="text-red-500">Failed to load file.</div>', audioHTML: '' };
                }
                // --- CARD LAYOUT ---
                // Fallbacks for missing data
                const initials = data.initials || (data.original_filename ? data.original_filename.split(' ').map(w => w[0]).join('').substring(0,2).toUpperCase() : 'NA');
                const name = data.name || data.original_filename || 'Candidate Name';
                const title = data.title || 'Job Title';
                const email = data.email || 'candidate@email.com';
                const phone = data.phone || '+1 (555) 123-4567';
                const location = data.location || 'San Francisco, CA';
                const skills = Array.isArray(data.skills) ? data.skills : ['JavaScript', 'SQL'];
                const matchPercent = data.match_percentage || 0;
                const resumeUrl = data.stored_filename ? `/shortlist/${data.stored_filename}` : '#';
                const card = document.createElement('div');
                card.className = "flex items-center bg-white rounded-xl shadow p-6 justify-between";
                card.setAttribute('data-card-id', file.id);
                card.innerHTML = `
      <div class="flex items-center gap-6">
        <div class="w-14 h-14 rounded-full flex items-center justify-center text-white font-bold text-xl" style="background: linear-gradient(135deg, #7f5af0 0%, #00c6fb 100%);">
          ${initials}
        </div>
        <div>
          <div class="font-bold text-lg text-gray-900">${name}</div>
          <div class="text-gray-500 text-sm mb-2">${title}</div>
          <div class="flex items-center text-gray-500 text-sm gap-4">
            <span><i data-lucide="mail" class="inline w-4 h-4 mr-1"></i> ${email}</span>
            <span><i data-lucide="phone" class="inline w-4 h-4 mr-1"></i> ${phone}</span>
            <span><i data-lucide="map-pin" class="inline w-4 h-4 mr-1"></i> ${location}</span>
          </div>
        </div>
      </div>
      <div class="flex flex-col items-start gap-2">
        <div class="text-xs text-gray-500 font-semibold">Key Skills</div>
        <div class="flex gap-2 flex-wrap">
          ${skills.map(skill => `<span class=\"bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-semibold\">${skill}</span>`).join('')}
        </div>
      </div>
      <div class="flex flex-col items-end gap-2">
        <div class="flex items-center gap-2 mb-2">
          <span class="flex items-center bg-yellow-50 text-yellow-600 px-3 py-1 rounded-full font-bold text-sm">
            <i data-lucide="star" class="inline w-4 h-4 mr-1"></i> ${matchPercent}%
          </span>
          <button class="delete-shortlist-btn ml-2" data-id="${file.id}" title="Delete">
            <i data-lucide="trash-2" class="inline w-5 h-5 text-red-500"></i>
          </button>
        </div>
        <div class="flex gap-2">
          <button class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded font-semibold">Schedule Interview</button>
          <a href="${resumeUrl}" target="_blank" class="bg-white border border-gray-300 text-gray-800 px-4 py-2 rounded font-semibold">View Full Resume</a>
        </div>
      </div>
    `;
                list.appendChild(card);
            }
            // Add delete icon event listeners
            list.querySelectorAll('.delete-shortlist-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const id = btn.getAttribute('data-id');
                    pendingDeleteFilename = id;
                    document.getElementById('delete-modal').classList.remove('hidden');
                });
            });
            // Re-render Lucide icons
            if (window.lucide && window.lucide.createIcons) {
                lucide.createIcons();
            }
        }

        // Clear localStorage on logout
        const logoutBtn = document.querySelector('a[href="/logout"], button#logout');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function() {
                localStorage.clear();
            });
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Talent Acquisition Assistant</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="icon" type="image/jpeg" href="{{ url_for('static', filename='tringapps_inc_logo.jpeg') }}">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      /* Style for disabled tab buttons */
      button.tab-btn:disabled {
        color: #9ca3af !important; /* Tailwind gray-400 */
        border-color: transparent !important;
        background: none !important;
        opacity: 0.5;
        cursor: not-allowed !important;
        pointer-events: auto;
      }
      /* Gradient for active and hover tabs */
      .tab-btn.active-gradient {
        background: linear-gradient(90deg, #3b82f6 0%, #a855f7 100%) !important;
        color: #fff !important;
        font-weight: bold;
      }
      .tab-btn:hover:not(:disabled):not(.active-gradient) {
        background: linear-gradient(90deg, #dbeafe 0%, #f3e8ff 100%) !important;
        color: #3b82f6 !important;
      }
      .tab-btn:not(.active-gradient) {
        color: #374151 !important; /* Tailwind gray-700 */
      }
      /* Sidebar tab font size smaller */
      .tab-btn, .tab-btn span, .tab-btn i {
        font-size: 13px !important;
      }
      .tab-btn .text-xs, .tab-btn .text-sm {
        font-size: 11px !important;
      }
      @media (max-width: 1024px) {
        .tab-btn, .tab-btn span, .tab-btn i {
          font-size: 11px !important;
          padding-left: 0.5rem !important;
          padding-right: 0.5rem !important;
        }
      }
      /* Add this CSS for scrollable select */
      .custom-scroll-select { max-height: 160px !important; overflow-y: auto !important; }
    </style>
</head>
<body class="bg-gray-50">
    <pre>{{ session | safe }}</pre>
    {% include 'partials/header.html' %}
    <div class="flex w-full">
      <!-- Sidebar removed -->
      <!-- Main Content: scrollable -->
      <div id="main-content" class="h-[calc(100vh-80px)] overflow-y-auto w-full">
        <!-- Main Content: full width, no centering, no top margin -->
        <div class="w-full p-0">
            <div id="form-card" class="p-6 sm:p-8 rounded-lg transition-all duration-300 w-full">
                    <form id="talentForm" enctype="multipart/form-data" novalidate>
                        <div id="dashboard-tab-content" class="tab-content relative -top-5 md:-top-5">
                            {% include 'tabs/dashboard_tab.html' %}
                        </div>
                        <div id="resume-tab-content" class="tab-content hidden relative -top-5 md:-top-5">
                            <div class="flex flex-col items-start w-full">
                                <div class="w-full pr-0 self-start">
                                {% include 'tabs/resume_match_tab.html' %}
                                </div>
                                <!-- Analysis Results section removed: now inside resume_match_tab.html -->
                            </div>
                        </div>
                        <!-- Removed audio-tab-content (Technical Proficiency tab) -->
                        {% if session.role == 'admin' %}
                        <div id="question-gen-tab-content" class="tab-content hidden relative -top-5 md:-top-5">
                            {% include 'tabs/interview_question_generator_tab.html' %}
                        </div>
                        {% endif %}
                        <div id="saved-tab-content" class="tab-content hidden relative -top-5 md:-top-5">
                            {% include 'tabs/saved_analyses_tab.html' %}
                        </div>
                        <div id="shortlisted-tab-content" class="tab-content hidden relative -top-5 md:-top-5">
                            {% include 'tabs/shortlisted_resumes_tab.html' %}
                        </div>
                    </form>
                        <div id="analytics-tab-content" class="tab-content hidden relative -top-5 md:-top-5">
                          {% include 'tabs/admin_analytics_tab.html' %}
                        </div>
                        <div id="activity-logs-tab-content" class="tab-content hidden relative -top-5 md:-top-5">
                          {% include 'tabs/admin_activity_logs_tab.html' %}
                        </div>
                        <div id="user-management-tab-content" class="tab-content hidden relative -top-5 md:-top-5">
                          {% include 'tabs/admin_user_management_tab.html' %}
                        </div>
                        <div id="job-requirement-upload-tab-content" class="tab-content hidden relative -top-5 md:-top-5">
                          {% include 'tabs/admin_job_requirement_upload_tab.html' %}
                        </div>
            </div>

            <!-- Add User Modal -->
            <div id="add-user-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden" style="z-index: 1000;">
              <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full text-center">
                  <div class="text-lg font-semibold mb-4">Add New User</div>
                  <form id="add-user-form" class="space-y-4">
                      <div>
                          <input type="text" id="add-user-username" class="w-full p-2 border border-gray-300 rounded" placeholder="Username" required />
                      </div>
                      <div>
                          <input type="password" id="add-user-password" class="w-full p-2 border border-gray-300 rounded" placeholder="Password" required />
                      </div>
                      <div>
                          <select id="add-user-role" class="w-full p-2 border border-gray-300 rounded" required>
                              <option value="">Select Role</option>
                              <option value="admin">Admin</option>
                              <option value="TA_TEAM">TA_TEAM</option>
                          </select>
                      </div>
                      <div id="add-user-error" class="text-red-600 text-sm hidden"></div>
                      <div class="flex justify-center gap-4 mt-6">
                          <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 font-semibold">Add</button>
                          <button type="button" id="add-user-cancel" class="bg-gray-200 text-gray-700 px-6 py-2 rounded hover:bg-gray-300 font-semibold">Cancel</button>
                      </div>
                  </form>
              </div>
          </div>

            <!-- Results Modal -->
            <div id="results-overlay" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
                <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-full overflow-y-auto relative">
                    <button id="back-button" class="absolute top-4 left-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <i data-lucide="arrow-left" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Back
                    </button>
                    <button id="save-analysis-btn" class="absolute top-4 right-36 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 flex items-center hidden">
                        <i data-lucide="save" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Save
                    </button>
                    <button id="shortlist-btn" class="absolute top-4 right-3 bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 flex items-center">
                        <i data-lucide="star" class="inline w-4 h-4 mr-1 align-text-bottom"></i>Shortlist
                    </button>
                    <!-- Loader -->
                    <div id="loader" class="text-center p-12">
                        <div role="status" class="flex flex-col items-center justify-center">
                            <svg aria-hidden="true" class="inline w-10 h-10 text-blue-400 animate-spin drop-shadow-lg" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="50" cy="50" r="45" stroke="#3B82F6" stroke-width="10" fill="none" opacity="0.2"/>
                                <path d="M50 15a35 35 0 1 1-24.75 10.25" stroke="#2563EB" stroke-width="10" stroke-linecap="round" fill="none"/>
                            </svg>
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-4 text-blue-600 font-semibold animate-pulse">Analyzing... Please wait.</p>
                    </div>

                    <!-- Results -->
                    <div id="results" class="p-6 sm:p-8 hidden">
                        <h2 class="text-3xl font-bold mb-6 text-center text-gray-800 header-gradient">Analysis Results</h2>
                        <div id="meta_info" class="mb-6 text-center text-gray-700"></div>
                        <div class="space-y-6">
                            <div id="resume_result_card" class="bg-white p-6 rounded-lg shadow-md">
                                <!-- <h3 class="text-xl font-semibold text-gray-800 mb-4">Resume Analysis</h3> -->
                                <div id="resume_result"></div>
                            </div>
                            <div id="audio_result_card" class="bg-white p-6 rounded-lg shadow-md">
                                <!-- <h3 class="text-xl font-semibold text-gray-800 mb-4">Audio Analysis</h3> -->
                                <div id="audio_result"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 bg-green-600 text-white px-6 py-3 rounded shadow-lg text-center text-sm font-semibold opacity-0 pointer-events-none transition-opacity duration-500 flex items-center gap-2" style="pointer-events: none;"></div>

        <!-- Custom Delete Confirmation Modal -->
        <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden" style="z-index: 1000;">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full text-center">
                <div class="text-lg font-semibold mb-4">Delete this saved analysis?</div>
                <div class="flex justify-center gap-4 mt-6">
                    <button id="delete-modal-confirm" class="bg-red-600 text-white px-6 py-2 rounded hover:bg-red-700 font-semibold">Delete</button>
                    <button id="delete-modal-cancel" class="bg-gray-200 text-gray-700 px-6 py-2 rounded hover:bg-gray-300 font-semibold">Cancel</button>
                </div>
            </div>
        </div>

       

        <!-- Edit User Modal -->
        <div id="edit-user-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden" style="z-index: 1000;">
            <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full text-center">
                <div class="text-lg font-semibold mb-4">Edit User</div>
                <form id="edit-user-form" class="space-y-4">
                    <div>
                        <input type="text" id="edit-user-username" class="w-full p-2 border border-gray-300 rounded" placeholder="Username" required />
                    </div>
                    <div>
                        <select id="edit-user-role" class="w-full p-2 border border-gray-300 rounded" required>
                            <option value="admin">Admin</option>
                            <option value="TA_TEAM">TA_TEAM</option>
                        </select>
                    </div>
                    <div id="edit-user-error" class="text-red-600 text-sm hidden"></div>
                    <div class="flex justify-center gap-4 mt-6">
                        <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 font-semibold">Save</button>
                        <button type="button" id="edit-user-cancel" class="bg-gray-200 text-gray-700 px-6 py-2 rounded hover:bg-gray-300 font-semibold">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.7.0/mammoth.browser.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
            // Prevent browser back button from going to login page
            if (window.history && window.history.pushState) {
                window.addEventListener('popstate', function() {
                    window.history.pushState(null, null, window.location.href);
                });
                window.history.pushState(null, null, window.location.href);
            }
            
            // Session timeout check (every 5 minutes)
            setInterval(function() {
                fetch('/user_dashboard_stats?validate_session=1', {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => {
                        if (response.status === 401 || response.status === 403) {
                            window.location.href = '/login';
                        }
                    })
                    .catch(() => {
                        // If network error, don't redirect immediately
                    });
            }, 300000); // 5 minutes
            
            // Tab navigation button IDs (define once, globally)
            const tabIds = ['tab-dashboard', 'tab-resume', 'tab-audio', 'tab-question-gen', 'tab-saved', 'tab-shortlisted'];

            const tabDashboard = document.getElementById('tab-dashboard');
            const tabResume = document.getElementById('tab-resume');
            const tabAudio = document.getElementById('tab-audio');
            const tabQuestionGen = document.getElementById('tab-question-gen');
            const tabSaved = document.getElementById('tab-saved');
            const tabShortlisted = document.getElementById('tab-shortlisted');
            const dashboardTabContent = document.getElementById('dashboard-tab-content');
            const resumeTabContent = document.getElementById('resume-tab-content');
            const audioTabContent = document.getElementById('audio-tab-content');
            const questionGenTabContent = document.getElementById('question-gen-tab-content');
            const savedTabContent = document.getElementById('saved-tab-content');
            const shortlistedTabContent = document.getElementById('shortlisted-tab-content');
            // Add these lines:
            const tabActivityLogs = document.getElementById('tab-activity-logs');
            const tabUserManagement = document.getElementById('tab-user-management');
            const activityLogsTabContent = document.getElementById('activity-logs-tab-content');
            const userManagementTabContent = document.getElementById('user-management-tab-content');
            // Add these lines for mobile nav:
           

            let activeTab = 'dashboard';

            function setActiveTab(tab) {
                // Remove from user tabs
                tabIds.forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) {
                        btn.classList.remove('active-gradient', 'text-blue-700', 'border-blue-600', 'bg-blue-50', 'font-semibold');
                        btn.classList.add('text-gray-600', 'border-transparent', 'bg-white', 'font-medium');
                    }
                });
                // Remove from admin tabs
                const adminTabIds = ['tab-dashboard', 'tab-analytics', 'tab-activity-logs', 'tab-user-management', 'tab-job-requirement-upload', 'tab-question-gen'];
                adminTabIds.forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn) {
                        btn.classList.remove('active-gradient', 'text-blue-700', 'border-blue-600', 'bg-blue-50', 'font-semibold');
                        btn.classList.add('text-gray-600', 'border-transparent', 'bg-white', 'font-medium');
                    }
                });
                // Now set the active one
                const activeBtn = document.getElementById(`tab-${tab}`);
                if (activeBtn) {
                    activeBtn.classList.remove('text-gray-600', 'border-transparent', 'bg-white', 'font-medium');
                    activeBtn.classList.add('active-gradient');
                }
            }

            function hideAllTabs() {
              document.querySelectorAll('.tab-content').forEach(div => div.classList.add('hidden'));
              tabIds.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.classList.remove('active-gradient');
              });
            }
            function showTab(tabId, contentId) {
              hideAllTabs();
              const btn = document.getElementById(tabId);
              const content = document.getElementById(contentId);
              if (btn) btn.classList.add('active-gradient');
              if (content) content.classList.remove('hidden');
              window.activeTab = tabId.replace('tab-', '');
              lucide.createIcons();
            }

            document.addEventListener('DOMContentLoaded', function() {
              showTab('tab-dashboard', 'dashboard-tab-content');
            });

            if (tabDashboard) {
              tabDashboard.addEventListener('click', () => {
                setActiveTab('dashboard');
                showTab('tab-dashboard', 'dashboard-tab-content');
                activeTab = 'dashboard';
              });
            }
            if (tabResume) {
              tabResume.addEventListener('click', () => {
                setActiveTab('resume');
                showTab('tab-resume', 'resume-tab-content');
                activeTab = 'resume';
              });
            }
            if (tabAudio) {
              tabAudio.addEventListener('click', () => {
                setActiveTab('audio');
                showTab('tab-audio', 'audio-tab-content');
                activeTab = 'audio';
              });
            }
            if (tabQuestionGen) {
              tabQuestionGen.addEventListener('click', () => {
                setActiveTab('question-gen');
                showTab('tab-question-gen', 'question-gen-tab-content');
                activeTab = 'question-gen';
              });
            }
            if (tabSaved) {
              tabSaved.addEventListener('click', () => {
                setActiveTab('saved');
                showTab('tab-saved', 'saved-tab-content');
                activeTab = 'saved';
              });
            }
            if (tabShortlisted) {
              tabShortlisted.addEventListener('click', () => {
                setActiveTab('shortlisted');
                showTab('tab-shortlisted', 'shortlisted-tab-content');
                activeTab = 'shortlisted';
              });
            }

            // Wait for DOMContentLoaded to ensure all elements are available
            document.addEventListener('DOMContentLoaded', function() {
                if (window.lucide && window.lucide.createIcons) {
                    lucide.createIcons();
                }
            });

            const techResumeInput = document.getElementById('tech_resume');
            let latestAnalysisResult = null;
            let latestResumeResult = null;
            let latestTechnicalResult = null;

            if (tabResume) {
                tabResume.addEventListener('click', () => {
                    setActiveTab('resume');
                    if (tabResume) { tabResume.classList.add('text-blue-700', 'border-blue-600'); tabResume.classList.remove('text-gray-500'); }
                    if (tabAudio) { tabAudio.classList.remove('text-blue-700', 'border-blue-600'); tabAudio.classList.add('text-gray-500'); }
                    if (tabQuestionGen) { tabQuestionGen.classList.remove('text-blue-700', 'border-blue-600'); tabQuestionGen.classList.add('text-gray-500'); }
                    if (tabSaved) { tabSaved.classList.remove('text-blue-700', 'border-blue-600'); tabSaved.classList.add('text-gray-500'); }
                    if (tabShortlisted) { tabShortlisted.classList.remove('text-blue-700', 'border-blue-600'); tabShortlisted.classList.add('text-gray-500'); }
                    if (resumeTabContent) resumeTabContent.classList.remove('hidden');
                    if (audioTabContent) audioTabContent.classList.add('hidden');
                    if (questionGenTabContent) questionGenTabContent.classList.add('hidden');
                    if (savedTabContent) savedTabContent.classList.add('hidden');
                    if (shortlistedTabContent) shortlistedTabContent.classList.add('hidden');
                    activeTab = 'resume';
                    const analyzeBtn = document.getElementById('analyze-btn-container');
                    if (analyzeBtn) analyzeBtn.classList.remove('hidden');
                    if (techResumeInput) techResumeInput.required = false;
                    
                    // Preserve analysis state when switching to resume tab
                    // Check for visible results and restore state if needed
                    const resumeResultDiv = document.getElementById('resume_result_resume');
                    const audioResultDiv = document.getElementById('audio_result_audio');
                    
                    // If we have visible results but no state, restore the state
                    if (resumeResultDiv && resumeResultDiv.innerHTML.trim() && 
                        !resumeResultDiv.innerHTML.includes('No analysis yet') && 
                        !window.analysisState.resumeResult) {
                        window.analysisState.resumeResult = latestResumeResult || {};
                    }
                    
                    if (audioResultDiv && audioResultDiv.innerHTML.trim() && 
                        !audioResultDiv.innerHTML.includes('No analysis yet') && 
                        !window.analysisState.technicalResult) {
                        window.analysisState.technicalResult = latestTechnicalResult || {};
                    }
                    
                    // Update buttons to show current state
                    if (typeof updateUnifiedButtons === 'function') {
                        updateUnifiedButtons();
                    }
                });
            }
            if (tabAudio) {
                tabAudio.addEventListener('click', () => {
                    setActiveTab('audio');
                    if (tabAudio) { tabAudio.classList.add('text-blue-700', 'border-blue-600'); tabAudio.classList.remove('text-gray-500'); }
                    if (tabResume) { tabResume.classList.remove('text-blue-700', 'border-blue-600'); tabResume.classList.add('text-gray-500'); }
                    if (tabQuestionGen) { tabQuestionGen.classList.remove('text-blue-700', 'border-blue-600'); tabQuestionGen.classList.add('text-gray-500'); }
                    if (tabSaved) { tabSaved.classList.remove('text-blue-700', 'border-blue-600'); tabSaved.classList.add('text-gray-500'); }
                    if (tabShortlisted) { tabShortlisted.classList.remove('text-blue-700', 'border-blue-600'); tabShortlisted.classList.add('text-gray-500'); }
                    if (audioTabContent) audioTabContent.classList.remove('hidden');
                    if (resumeTabContent) resumeTabContent.classList.add('hidden');
                    if (questionGenTabContent) questionGenTabContent.classList.add('hidden');
                    if (savedTabContent) savedTabContent.classList.add('hidden');
                    if (shortlistedTabContent) shortlistedTabContent.classList.add('hidden');
                    activeTab = 'audio';
                    const analyzeBtn = document.getElementById('analyze-btn-container');
                    if (analyzeBtn) analyzeBtn.classList.remove('hidden');
                    if (techResumeInput) techResumeInput.required = true;
                });
            }
            if (tabQuestionGen) {
                tabQuestionGen.addEventListener('click', () => {
                    setActiveTab('question-gen');
                    if (tabQuestionGen) { tabQuestionGen.classList.add('text-blue-700', 'border-blue-600'); tabQuestionGen.classList.remove('text-gray-500'); }
                    if (tabResume) { tabResume.classList.remove('text-blue-700', 'border-blue-600'); tabResume.classList.add('text-gray-500'); }
                    if (tabAudio) { tabAudio.classList.remove('text-blue-700', 'border-blue-600'); tabAudio.classList.add('text-gray-500'); }
                    if (tabSaved) { tabSaved.classList.remove('text-blue-700', 'border-blue-600'); tabSaved.classList.add('text-gray-500'); }
                    if (tabShortlisted) { tabShortlisted.classList.remove('text-blue-700', 'border-blue-600'); tabShortlisted.classList.add('text-gray-500'); }
                    if (questionGenTabContent) questionGenTabContent.classList.remove('hidden');
                    if (resumeTabContent) resumeTabContent.classList.add('hidden');
                    if (audioTabContent) audioTabContent.classList.add('hidden');
                    if (savedTabContent) savedTabContent.classList.add('hidden');
                    if (shortlistedTabContent) shortlistedTabContent.classList.add('hidden');
                    if (typeof renderSavedAnalyses === 'function') renderSavedAnalyses();
                    activeTab = 'question-gen';
                    const analyzeBtn = document.getElementById('analyze-btn-container');
                    if (analyzeBtn) analyzeBtn.classList.add('hidden');
                    const resultsOverlay = document.getElementById('results-overlay');
                    if (resultsOverlay) {
                        resultsOverlay.classList.add('hidden');
                        resultsOverlay.style.display = 'none';
                        resultsOverlay.style.visibility = 'hidden';
                    }
                    wasResultsOverlayOpen = false;
                    // Also hide the delete modal when switching to Saved Analyses tab
                    const deleteModal = document.getElementById('delete-modal');
                    if (deleteModal) deleteModal.classList.add('hidden');
                    if (techResumeInput) techResumeInput.required = false;
                });
            }
            if (tabSaved) {
                tabSaved.addEventListener('click', () => {
                    setActiveTab('saved');
                    if (tabSaved) { tabSaved.classList.add('text-blue-700', 'border-blue-600'); tabSaved.classList.remove('text-gray-500'); }
                    if (tabResume) { tabResume.classList.remove('text-blue-700', 'border-blue-600'); tabResume.classList.add('text-gray-500'); }
                    if (tabAudio) { tabAudio.classList.remove('text-blue-700', 'border-blue-600'); tabAudio.classList.add('text-gray-500'); }
                    if (tabQuestionGen) { tabQuestionGen.classList.remove('text-blue-700', 'border-blue-600'); tabQuestionGen.classList.add('text-gray-500'); }
                    if (tabShortlisted) { tabShortlisted.classList.remove('text-blue-700', 'border-blue-600'); tabShortlisted.classList.add('text-gray-500'); }
                    if (savedTabContent) savedTabContent.classList.remove('hidden');
                    if (resumeTabContent) resumeTabContent.classList.add('hidden');
                    if (audioTabContent) audioTabContent.classList.add('hidden');
                    if (questionGenTabContent) questionGenTabContent.classList.add('hidden');
                    if (shortlistedTabContent) shortlistedTabContent.classList.add('hidden');
                    if (typeof renderSavedAnalyses === 'function') renderSavedAnalyses();
                    activeTab = 'saved';
                    const analyzeBtn = document.getElementById('analyze-btn-container');
                    if (analyzeBtn) analyzeBtn.classList.add('hidden');
                    const resultsOverlay = document.getElementById('results-overlay');
                    if (resultsOverlay) {
                        resultsOverlay.classList.add('hidden');
                        resultsOverlay.style.display = 'none';
                        resultsOverlay.style.visibility = 'hidden';
                    }
                    wasResultsOverlayOpen = false;
                    // Also hide the delete modal when switching to Saved Analyses tab
                    const deleteModal = document.getElementById('delete-modal');
                    if (deleteModal) deleteModal.classList.add('hidden');
                    if (techResumeInput) techResumeInput.required = false;
                });
            }
            if (tabShortlisted) {
                tabShortlisted.addEventListener('click', () => {
                    setActiveTab('shortlisted');
                    if (tabShortlisted) { tabShortlisted.classList.add('text-blue-700', 'border-blue-600'); tabShortlisted.classList.remove('text-gray-500'); }
                    if (tabResume) { tabResume.classList.remove('text-blue-700', 'border-blue-600'); tabResume.classList.add('text-gray-500'); }
                    if (tabAudio) { tabAudio.classList.remove('text-blue-700', 'border-blue-600'); tabAudio.classList.add('text-gray-500'); }
                    if (tabQuestionGen) { tabQuestionGen.classList.remove('text-blue-700', 'border-blue-600'); tabQuestionGen.classList.add('text-gray-500'); }
                    if (tabSaved) { tabSaved.classList.remove('text-blue-700', 'border-blue-600'); tabSaved.classList.add('text-gray-500'); }
                    if (shortlistedTabContent) shortlistedTabContent.classList.remove('hidden');
                    if (resumeTabContent) resumeTabContent.classList.add('hidden');
                    if (audioTabContent) audioTabContent.classList.add('hidden');
                    if (questionGenTabContent) questionGenTabContent.classList.add('hidden');
                    if (savedTabContent) savedTabContent.classList.add('hidden');
                    if (typeof renderShortlistedResumes === 'function') renderShortlistedResumes();
                    activeTab = 'shortlisted';
                    const analyzeBtn = document.getElementById('analyze-btn-container');
                    if (analyzeBtn) analyzeBtn.classList.add('hidden');
                    const resultsOverlay = document.getElementById('results-overlay');
                    if (resultsOverlay) {
                        resultsOverlay.classList.add('hidden');
                        resultsOverlay.style.display = 'none';
                        resultsOverlay.style.visibility = 'hidden';
                    }
                    wasResultsOverlayOpen = false;
                    // Also hide the delete modal when switching to Saved Analyses tab
                    const deleteModal = document.getElementById('delete-modal');
                    if (deleteModal) deleteModal.classList.add('hidden');
                    if (techResumeInput) techResumeInput.required = false;
                });
            }

            document.getElementById('talentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                let valid = true;

                // Identify which button was clicked
                const submitter = e.submitter || document.activeElement;
                const isTechnicalBtn = submitter && submitter.id === 'analyze-technical-btn';
                const isResumeBtn = submitter && submitter.id === 'analyze-resume-btn';

                // Resume tab
                const jobDesc = document.getElementById('job_description').value.trim();
                const resumeInputs = document.querySelectorAll('.resume-file');
                let resumeFiles = [];
                resumeInputs.forEach(input => {
                    if (input.files && input.files.length > 0) {
                        resumeFiles.push(input.files[0]);
                    }
                });
                // Technical tab fields (even if inside resume tab)
                const audioFile = document.getElementById('audio').files[0];
                const techInput = document.getElementById('technology') || document.getElementById('compact-technology');
                const technology = techInput ? techInput.value : '';
                const techResumeInput = document.getElementById('tech_resume');
                const techResumeFile = techResumeInput && techResumeInput.files && techResumeInput.files[0];

                // NEW: Get selected job requirement file ID
                const jobRequirementDropdown = document.getElementById('job-requirement-dropdown');
                let selectedJobRequirementId = '';
                if (jobRequirementDropdown) {
                    selectedJobRequirementId = jobRequirementDropdown.value;
                }

                // Detect if technical proficiency fields are filled
                let isTechnicalProficiency = audioFile && technology && techResumeFile;

                // Hide/show errors based on which button was clicked
                if (activeTab === 'resume') {
                    if (isTechnicalBtn) {
                        // Only validate technical proficiency fields
                        if (!audioFile) {
                            const el = document.getElementById('audio_error');
                            if (el) el.classList.remove('hidden');
                            valid = false;
                        } else {
                            const el = document.getElementById('audio_error');
                            if (el) el.classList.add('hidden');
                        }
                        if (!technology) {
                            const el = document.getElementById('technology_error');
                            if (el) el.classList.remove('hidden');
                            valid = false;
                        } else {
                            const el = document.getElementById('technology_error');
                            if (el) el.classList.add('hidden');
                        }
                        if (!techResumeFile) {
                            const el = document.getElementById('tech_resume_error');
                            if (el) el.classList.remove('hidden');
                            valid = false;
                        } else {
                            const el = document.getElementById('tech_resume_error');
                            if (el) el.classList.add('hidden');
                        }
                    } else if (isResumeBtn) {
                        // Only validate resume match fields
                        if (typeof validateResumeForm === 'function') {
                            valid = validateResumeForm();
                        } else {
                            if (!jobDesc && !selectedJobRequirementId) {
                                const el = document.getElementById('job_description_error');
                                if (el) el.classList.remove('hidden');
                                valid = false;
                            } else {
                                const el = document.getElementById('job_description_error');
                                if (el) el.classList.add('hidden');
                            }
                            if (resumeFiles.length === 0 && !selectedJobRequirementId) {
                                const el = document.getElementById('resume_error');
                                if (el) el.classList.remove('hidden');
                                valid = false;
                            } else {
                                const el = document.getElementById('resume_error');
                                if (el) el.classList.add('hidden');
                            }
                        }
                    } else {
                        // Fallback: default to previous logic
                        if (isTechnicalProficiency) {
                            // Validate technical proficiency fields
                            if (!audioFile) {
                                const el = document.getElementById('audio_error');
                                if (el) el.classList.remove('hidden');
                                valid = false;
                            } else {
                                const el = document.getElementById('audio_error');
                                if (el) el.classList.add('hidden');
                            }
                            if (!technology) {
                                const el = document.getElementById('technology_error');
                                if (el) el.classList.remove('hidden');
                                valid = false;
                            } else {
                                const el = document.getElementById('technology_error');
                                if (el) el.classList.add('hidden');
                            }
                            if (!techResumeFile) {
                                const el = document.getElementById('tech_resume_error');
                                if (el) el.classList.remove('hidden');
                                valid = false;
                            } else {
                                const el = document.getElementById('tech_resume_error');
                                if (el) el.classList.add('hidden');
                            }
                        } else {
                            if (typeof validateResumeForm === 'function') {
                                valid = validateResumeForm();
                            } else {
                                if (!jobDesc && !selectedJobRequirementId) {
                                    const el = document.getElementById('job_description_error');
                                    if (el) el.classList.remove('hidden');
                                    valid = false;
                                } else {
                                    const el = document.getElementById('job_description_error');
                                    if (el) el.classList.add('hidden');
                                }
                                if (resumeFiles.length === 0 && !selectedJobRequirementId) {
                                    const el = document.getElementById('resume_error');
                                    if (el) el.classList.remove('hidden');
                                    valid = false;
                                } else {
                                    const el = document.getElementById('resume_error');
                                    if (el) el.classList.add('hidden');
                                }
                            }
                        }
                    }
                } else if (activeTab === 'audio') {
                    // (Unchanged: for separate audio tab)
                    if (!audioFile) {
                        const el = document.getElementById('audio_error');
                        if (el) el.classList.remove('hidden');
                        valid = false;
                    } else {
                        const el = document.getElementById('audio_error');
                        if (el) el.classList.add('hidden');
                    }
                    if (!technology) {
                        const el = document.getElementById('technology_error');
                        if (el) el.classList.remove('hidden');
                        valid = false;
                    } else {
                        const el = document.getElementById('technology_error');
                        if (el) el.classList.add('hidden');
                    }
                    if (!techResumeInput.files || techResumeInput.files.length === 0) {
                        const el = document.getElementById('tech_resume_error');
                        if (el) el.classList.remove('hidden');
                        valid = false;
                    } else {
                        const el = document.getElementById('tech_resume_error');
                        if (el) el.classList.add('hidden');
                    }
                }
                if (!valid) return;
                const form = document.getElementById('talentForm');
                const formData = new FormData();
                
                // Optimize payload: Only send relevant fields based on analysis type
                if (isTechnicalBtn || activeTab === 'audio') {
                    // Technical Proficiency Analysis - only send relevant fields
                    const techInput = document.getElementById('technology') || document.getElementById('compact-technology');
                    const techQuestions = document.getElementById('tech_questions');
                    if (techInput && techInput.value) formData.append('technology', techInput.value);
                    if (techQuestions && techQuestions.value) formData.append('tech_questions', techQuestions.value);
                    if (audioFile) formData.append('audio', audioFile);
                    if (techResumeFile) formData.append('tech_resume', techResumeFile);
                } else if (isResumeBtn && activeTab === 'resume') {
                    // Resume Analysis - only send relevant fields
                    const jobDescription = document.getElementById('job_description');
                    if (jobDescription && jobDescription.value) formData.append('job_description', jobDescription.value);
                    if (resumeFiles.length > 0) {
                        for (let i = 0; i < resumeFiles.length; i++) {
                            formData.append('resume', resumeFiles[i]);
                        }
                    }
                    if (selectedJobRequirementId) {
                        formData.append('job_requirement_id', selectedJobRequirementId);
                    }
                }

                // Use unique IDs for each tab or mode
                let loaderId, resultsId, metaInfoId, resultCardId, resultDivId;
                // FIX: Use which button was clicked, not just field values
                if (isTechnicalBtn || activeTab === 'audio') {
                    loaderId = 'loader-audio';
                    resultsId = 'results-audio';
                    metaInfoId = 'meta_info_audio';
                    resultCardId = 'audio_result_card_audio';
                    resultDivId = 'audio_result_audio';
                } else if (isResumeBtn && activeTab === 'resume') {
                    loaderId = 'loader-resume';
                    resultsId = 'results-resume';
                    metaInfoId = 'meta_info_resume';
                    resultCardId = 'resume_result_card_resume';
                    resultDivId = 'resume_result_resume';
                }

                // Disable all tab buttons while loading, except the active tab
                tabIds.forEach(id => {
                    const btn = document.getElementById(id);
                    if (btn && id !== `tab-${activeTab}`) btn.disabled = true;
                });

                // Show loader, hide results and reset analysis state
                if (loaderId && resultsId) {
                    let loaderElem = document.getElementById(loaderId);
                    if (loaderElem) loaderElem.classList.remove('hidden');
                    const resultsElem = document.getElementById(resultsId);
                    if (resultsElem) resultsElem.classList.add('hidden');
                    // Hide placeholder when analyzing
                    if (resultCardId === 'resume_result_card_resume') {
                        const ph = document.getElementById('placeholder-resume');
                        if (ph) ph.classList.add('hidden');
                    } else if (resultCardId === 'audio_result_card_audio') {
                        const ph = document.getElementById('placeholder-audio');
                        if (ph) ph.classList.add('hidden');
                    }
                }

                // Clear analysis state when starting new analysis (only when actually submitting)
                // if (typeof clearAnalysisState === 'function') {
                //     clearAnalysisState();
                // }

                // FIXED: Use button detection instead of field detection for endpoint selection
                const endpoint = (isTechnicalBtn || activeTab === 'audio') ? '/process_audio' : '/process';
                
                // Debug logging to verify endpoint selection
                console.log('Analysis Type Detection:', {
                    isTechnicalBtn,
                    isResumeBtn,
                    activeTab,
                    endpoint,
                    isTechnicalProficiency
                });
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                // Store results separately and update unified state
                if (isTechnicalBtn || activeTab === 'audio') {
                    latestTechnicalResult = result;
                    window.analysisState.technicalResult = result;
                    window.analysisState.technicalSaved = false; // Reset saved flag so Save button re-enables
                } else if (isResumeBtn && activeTab === 'resume') {
                    latestResumeResult = result;
                    window.analysisState.resumeResult = result;
                    window.analysisState.resumeSaved = false; // Reset saved flag so Save button re-enables
                }
                latestAnalysisResult = result; // (optional: keep for backward compatibility)

                // Hide loader, show results and update unified buttons
                if (loaderId && resultsId) {
                    loaderElem = document.getElementById(loaderId);
                    if (loaderElem) loaderElem.classList.add('hidden');
                    const resultsElem = document.getElementById(resultsId);
                    if (resultsElem) resultsElem.classList.remove('hidden');
                }
                
                // Update unified buttons
                if (typeof updateUnifiedButtons === 'function') {
                    updateUnifiedButtons();
                }
                
                // Show compact tech actions when we have resume results
                if (isResumeBtn && activeTab === 'resume' && result && (Array.isArray(result.resumes) && result.resumes.length > 0 || result.job_requirement_analysis)) {
                    const compactTechActions = document.getElementById('compact-tech-actions');
                    if (compactTechActions) {
                        compactTechActions.classList.remove('hidden');
                    }
                }

                // Render results in the correct tab's containers
                const metaInfoDiv = document.getElementById(metaInfoId);
                const resultCardDiv = document.getElementById(resultCardId);
                const resultDiv = document.getElementById(resultDivId);
                // Clear previous results
                if (metaInfoDiv) metaInfoDiv.innerHTML = '';
                if (resultDiv) resultDiv.innerHTML = '';
                if (resultCardDiv) resultCardDiv.classList.add('hidden');
                // If no results, show placeholder again
                if (resultCardId === 'resume_result_card_resume' && (!result || (!result.resumes && !result.job_requirement_analysis && !result.resume_error))) {
                    const ph = document.getElementById('placeholder-resume');
                    if (ph) ph.classList.remove('hidden');
                } else if (resultCardId === 'audio_result_card_audio' && (!result || (!result.transcription && !result.audio_error))) {
                    const ph = document.getElementById('placeholder-audio');
                    if (ph) ph.classList.remove('hidden');
                }
                
                // Show selected technology and audio file name only for technical proficiency
                if (resultCardId === 'audio_result_card_audio') {
                    const selectedTechInput = document.getElementById('technology');
                    const selectedTech = selectedTechInput ? selectedTechInput.value : '';
                    const audioInput = document.getElementById('audio');
                    let audioFileName = '';
                    if (audioInput && audioInput.files && audioInput.files.length > 0) {
                        audioFileName = audioInput.files[0].name;
                    }
                    if (metaInfoDiv) {
                        metaInfoDiv.innerHTML = `<p><strong>Selected Technology:</strong> ${selectedTech || 'N/A'}</p>` +
                            (audioFileName ? `<p><strong>Audio File:</strong> ${audioFileName}</p>` : '');
                    }
                } else {
                    if (metaInfoDiv) metaInfoDiv.innerHTML = '';
                }
                
                if (resultCardId === 'resume_result_card_resume') {
                if ((Array.isArray(result.resumes) && result.resumes.length > 0) || result.job_requirement_analysis) {
                        resultCardDiv.classList.remove('hidden');
                    let allResumesHTML = '';
                    if (Array.isArray(result.resumes) && result.resumes.length > 0) {
                        // Sort resumes by match percentage in descending order
                        result.resumes.sort((a, b) => {
                            const scoreA = a.match_percentage || -1;
                            const scoreB = b.match_percentage || -1;
                            return scoreB - scoreA;
                        });
                        allResumesHTML = result.resumes.map((r, idx) => {
                        if (r.error) {
                            return `<div class='mb-4 p-4 border border-red-300 rounded bg-red-50'><strong>${r.filename}</strong>: <span class='text-red-600'>${r.error}</span></div>`;
                        } else {
                            const skillCoverage = r.total_skills > 0 ? Math.round((r.skills_matched / r.total_skills) * 100) : 0;
                            return `<div class='mb-4 p-4 border border-blue-100 rounded'>
                                <p><strong>${r.filename}</strong></p>
                                <div class="grid grid-cols-2 sm:flex sm:flex-row gap-4 sm:gap-6 my-4 items-center justify-center">
                                    <div class="flex flex-col items-center">
                                        <canvas id="donutMatch${idx}" width="80" height="80"></canvas>
                                        <div class="mt-2 text-center text-xs font-semibold">Match %</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <canvas id="donutSkills${idx}" width="80" height="80"></canvas>
                                        <div class="mt-2 text-center text-xs font-semibold">Skill Coverage</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <canvas id="donutExp${idx}" width="80" height="80"></canvas>
                                        <div class="mt-2 text-center text-xs font-semibold">Exp. Match</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <canvas id="donutEdu${idx}" width="80" height="80"></canvas>
                                        <div class="mt-2 text-center text-xs font-semibold">Education Match</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <canvas id="donutCert${idx}" width="80" height="80"></canvas>
                                        <div class="mt-2 text-center text-xs font-semibold">Certifications</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <canvas id="donutRole${idx}" width="80" height="80"></canvas>
                                        <div class="mt-2 text-center text-xs font-semibold">Role Match</div>
                                    </div>
                                </div>
                                <p><strong>Resume Match:</strong> <span class=\"font-bold text-blue-600\">${r.match_percentage}%</span></p>
                                <p><strong>Explanation:</strong> ${r.explanation}</p>
                            </div>`;
                        }
                    }).join('');
                    }
                    resultDiv.innerHTML = allResumesHTML;
                    // Render job requirement analysis HTML (append)
                    if (result.job_requirement_analysis) {
                        const jra = result.job_requirement_analysis;
                        let jraHTML = '';
                        if (jra.error) {
                            jraHTML = `<div class='mb-4 p-4 border border-red-300 rounded bg-red-50'><strong>Job Requirement Analysis (${jra.filename})</strong>: <span class='text-red-600'>${jra.error}</span></div>`;
                        } else {
                            const skillCoverage = jra.total_skills > 0 ? Math.round((jra.skills_matched / jra.total_skills) * 100) : 0;
                            jraHTML = `<div class='mb-4 p-4 border border-purple-200 rounded bg-purple-50'>
                                <p><strong>Job Requirement Analysis (${jra.filename})</strong></p>
                                <div class="grid grid-cols-2 sm:flex sm:flex-row gap-4 sm:gap-6 my-4 items-center justify-center">
                                    <div class="flex flex-col items-center">
                                        <canvas id="donutJRAMatch" width="80" height="80"></canvas>
                                        <div class="mt-2 text-center text-xs font-semibold">Match %</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <canvas id="donutJRASkills" width="80" height="80"></canvas>
                                        <div class="mt-2 text-center text-xs font-semibold">Skill Coverage</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <canvas id="donutJRAExp" width="80" height="80"></canvas>
                                        <div class="mt-2 text-center text-xs font-semibold">Exp. Match</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <canvas id="donutJRAEdu" width="80" height="80"></canvas>
                                        <div class="mt-2 text-center text-xs font-semibold">Education Match</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <canvas id="donutJRACert" width="80" height="80"></canvas>
                                        <div class="mt-2 text-center text-xs font-semibold">Certifications</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <canvas id="donutJRARole" width="80" height="80"></canvas>
                                        <div class="mt-2 text-center text-xs font-semibold">Role Match</div>
                                    </div>
                                </div>
                                <p><strong>Match %:</strong> <span class=\"font-bold text-purple-600\">${jra.match_percentage}%</span></p>
                                <p><strong>Explanation:</strong> ${jra.explanation}</p>
                            </div>`;
                        }
                        resultDiv.innerHTML += jraHTML;
                    }
                    // Render donuts for resumes
                    if (Array.isArray(result.resumes) && result.resumes.length > 0) {
                        renderAllDonutsWhenReady(result.resumes);
                    }
                    // Render donuts for job requirement analysis
                    if (result.job_requirement_analysis && !result.job_requirement_analysis.error) {
                        const jra = result.job_requirement_analysis;
                        const skillCoverage = jra.total_skills > 0 ? Math.round((jra.skills_matched / jra.total_skills) * 100) : 0;
                        setTimeout(() => {
                            try { renderDonut('donutJRAMatch', jra.match_percentage || 0, '#a855f7'); } catch (e) { console.error('Error rendering donutJRAMatch', e); }
                            try { renderDonut('donutJRASkills', skillCoverage, '#22d3ee'); } catch (e) { console.error('Error rendering donutJRASkills', e); }
                            try { renderDonut('donutJRAExp', jra.experience_match || 0, '#f59e42'); } catch (e) { console.error('Error rendering donutJRAExp', e); }
                            try { renderDonut('donutJRAEdu', jra.education_match || 0, '#a855f7'); } catch (e) { console.error('Error rendering donutJRAEdu', e); }
                            try { renderDonut('donutJRACert', jra.certifications_match || 0, '#0ea5e9'); } catch (e) { console.error('Error rendering donutJRACert', e); }
                            try { renderDonut('donutJRARole', jra.role_match || 0, '#f43f5e'); } catch (e) { console.error('Error rendering donutJRARole', e); }
                        }, 200);
                    }
                } else if (result.resume_error) {
                        resultCardDiv.classList.remove('hidden');
                        resultDiv.innerHTML = `<p class="text-red-500"><strong>Error:</strong> ${result.resume_error}</p>`;
                }
                } else if (resultCardId === 'audio_result_card_audio') {
                if (result.transcription || result.audio_error) {
                        resultCardDiv.classList.remove('hidden');
                    if (result.transcription) {
                            resultDiv.innerHTML = `
                            <div class="space-y-4">
                                <!-- Top row: Technical Score and Explanation -->
                            <div class="flex flex-col sm:flex-row gap-6">
                                <div class="flex-1">
                                    <p class="text-2xl font-bold text-blue-700 mb-2">Technical Score: ${result.technical_score}/10</p>
                                    <p class="mb-4 text-gray-700"><strong>Technical Explanation:</strong> ${result.technical_explanation}</p>
                                        <div class="grid grid-cols-2 sm:grid-cols-6 md:grid-cols-6 gap-4 my-8" id="scoreDonuts">
                                            <div class="flex flex-col items-center">
                                                <canvas id="donutRelevance" width="120" height="120"></canvas>
                                                <div class="mt-2 text-center text-sm font-semibold">Relevance of Tech</div>
                                            </div>
                                            <div class="flex flex-col items-center">
                                                <canvas id="donutConfidence" width="120" height="120"></canvas>
                                                <div class="mt-2 text-center text-sm font-semibold">Confidence</div>
                                            </div>
                                            <div class="flex flex-col items-center">
                                                <canvas id="donutCommunication" width="120" height="120"></canvas>
                                                <div class="mt-2 text-center text-sm font-semibold">Communication</div>
                                            </div>
                                            <div class="flex flex-col items-center">
                                                <canvas id="donutClarity" width="120" height="120"></canvas>
                                                <div class="mt-2 text-center text-sm font-semibold">Clarity</div>
                                            </div>
                                            <div class="flex flex-col items-center">
                                                <canvas id="donutProblemSolving" width="120" height="120"></canvas>
                                                <div class="mt-2 text-center text-sm font-semibold">Problem-Solving</div>
                                            </div>
                                            <div class="flex flex-col items-center">
                                                <canvas id="donutTechnicalKnowledge" width="120" height="120"></canvas>
                                                <div class="mt-2 text-center text-sm font-semibold">Technical Knowledge</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Per-question grading -->
                            ${Array.isArray(result.question_grades) && result.question_grades.length > 0 ? `
                            <details class="mt-4">
                                <summary class="cursor-pointer text-lg font-semibold mb-2">Show Per-Question Grading</summary>
                                <div class="overflow-x-auto mt-2">
                                    <table class="min-w-full text-sm border border-gray-200 rounded">
                                        <thead>
                                            <tr class="bg-gray-100">
                                                <th class="px-3 py-2 border-b text-left">Question</th>
                                                <th class="px-3 py-2 border-b text-left">Candidate Answer</th>
                                                <th class="px-3 py-2 border-b text-left">Score</th>
                                                <th class="px-3 py-2 border-b text-left">Explanation</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${result.question_grades.map(q => `
                                            <tr>
                                                <td class="px-3 py-2 border-b align-top">${q.question}</td>
                                                <td class="px-3 py-2 border-b align-top">${q.answer}</td>
                                                <td class="px-3 py-2 border-b align-top font-bold text-blue-600">${q.score}/10</td>
                                                <td class="px-3 py-2 border-b align-top">${q.explanation}</td>
                                            </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </details>
                            ` : ''}
                            <!-- Conversation History -->
                                <details class="mt-2">
                                    <summary class="cursor-pointer text-sm text-gray-600">Show Conversation History</summary>
                                    <pre class="mt-2 text-sm text-gray-700 bg-gray-100 rounded p-2 overflow-x-auto" style="white-space: pre-wrap;">${result.separated_dialog ? result.separated_dialog : 'Not available.'}</pre>
                                </details>
                        </div>
                    `;
                    // Render the donut charts
                    setTimeout(() => {
                        function renderDonut(canvasId, value, color) {
                            window.donutCharts = window.donutCharts || {};
                            const canvas = document.getElementById(canvasId);
                            if (!canvas) return;
                            // Destroy previous chart if exists
                            if (window.donutCharts[canvasId]) {
                                window.donutCharts[canvasId].destroy();
                            }
                            window.donutCharts[canvasId] = new Chart(canvas.getContext('2d'), {
                                type: 'doughnut',
                                data: {
                                    datasets: [{
                                        data: [value, 100 - value],
                                        backgroundColor: [color, '#e5e7eb'],
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    cutout: '60%',
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: { enabled: false }
                                    }
                                },
                                plugins: [{
                                    id: 'centerText',
                                    afterDraw: chart => {
                                        const {ctx, chartArea: {width, height}} = chart;
                                        ctx.save();
                                        ctx.font = 'bold 1rem Inter, sans-serif';
                                        ctx.textAlign = 'center';
                                        ctx.textBaseline = 'middle';
                                        ctx.fillStyle = color;
                                        ctx.fillText(`${value}%`, width / 2, height / 2);
                                        ctx.restore();
                                    }
                                }]
                            });
                        }
                        renderDonut('donutRelevance', (result.relevance_score || 0) * 10, '#ef4444');
                        renderDonut('donutConfidence', (result.confidence_score || 0) * 10, '#f97316');
                        renderDonut('donutCommunication', (result.communication_score || 0) * 10, '#eab308');
                        renderDonut('donutClarity', (result.clarity_score || 0) * 10, '#22c55e');
                        renderDonut('donutProblemSolving', (result.problem_solving_score || 0) * 10, '#06b6d4');
                        renderDonut('donutTechnicalKnowledge', (result.depth_score || 0) * 10, '#8b5cf6');
                    }, 100);
                } else if (result.audio_error) {
                        resultDiv.innerHTML = `<p class="text-red-500"><strong>Error:</strong> ${result.audio_error}</p>`;
                }
            }
            }

            // Unified save/shortlist buttons are handled in resume_match_tab.html

                            // After results are rendered (after fetch and DOM update):
                // Hide loader, show results
                if (loaderId && resultsId) {
                    loaderElem = document.getElementById(loaderId);
                    if (loaderElem) loaderElem.classList.add('hidden');
                    const resultsElem = document.getElementById(resultsId);
                    if (resultsElem) resultsElem.classList.remove('hidden');
                }

            // Re-enable all tab buttons after loading
            tabIds.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) btn.disabled = false;
            });
        });

        // Hide error when user starts typing or selects a file
        // Resume tab
        const jobDescInput = document.getElementById('job_description');
        jobDescInput.addEventListener('input', () => {
            if (jobDescInput.value.trim()) {
                const el = document.getElementById('job_description_error');
                if (el) el.classList.add('hidden');
            }
        });
        // Hide error when any resume input changes
        document.getElementById('resume-inputs').addEventListener('change', (e) => {
            if (e.target.classList.contains('resume-file')) {
                let hasFile = false;
                document.querySelectorAll('.resume-file').forEach(input => {
                    if (input.files && input.files.length > 0) hasFile = true;
                });
                if (hasFile) {
                    const el = document.getElementById('resume_error');
                    if (el) el.classList.add('hidden');
                }
            }
        });
        // Technical tab
        const audioInput = document.getElementById('audio');
        const techInput = document.getElementById('technology') || document.getElementById('compact-technology');
        if (audioInput) {
            audioInput.addEventListener('change', () => {
                if (audioInput.files && audioInput.files.length > 0) {
                    const el = document.getElementById('audio_error');
                    if (el) el.classList.add('hidden');
                }
            });
        }
        if (techInput) {
            techInput.addEventListener('change', () => {
                if (techInput.value) {
                    const el = document.getElementById('technology_error');
                    if (el) el.classList.add('hidden');
                }
            });
        }
        if (techResumeInput) {
            techResumeInput.addEventListener('change', () => {
                if (techResumeInput.files && techResumeInput.files.length > 0) {
                    const el = document.getElementById('tech_resume_error');
                    if (el) el.classList.add('hidden');
                }
            });
        }

        // Job Description Save/Load Logic
        function updateSavedDescriptionsDropdown() {
            const dropdown = document.getElementById('savedDescriptions');
            const saved = JSON.parse(localStorage.getItem('jobDescriptions') || '[]');
            dropdown.innerHTML = '';
            if (saved.length > 0) {
                dropdown.classList.remove('hidden');
                dropdown.innerHTML = '<option value="">Select a saved job description...</option>' +
                    saved.map((desc, i) => `<option value="${i}">${desc.substring(0, 40).replace(/\n/g, ' ')}${desc.length > 40 ? '...' : ''}</option>`).join('');
            } else {
                dropdown.classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            updateSavedDescriptionsDropdown();
            document.getElementById('savedDescriptions').addEventListener('change', function() {
                const idx = this.value;
                if (idx !== '') {
                    const saved = JSON.parse(localStorage.getItem('jobDescriptions') || '[]');
                    document.getElementById('job_description').value = saved[idx];
                    const el = document.getElementById('job_description_error');
                    if (el) el.classList.add('hidden');
                }
            });
        });

        document.getElementById('jobDocxUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.name.endsWith('.docx')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    mammoth.extractRawText({arrayBuffer: event.target.result})
                        .then(function(result) {
                            const jdText = result.value;
                            document.getElementById('job_description').value = jdText;
                            const el = document.getElementById('job_description_error');
                            if (el) el.classList.add('hidden');
                        })
                        .catch(function(err) {
                            alert('Could not read the Word file.');
                        });
                };
                reader.readAsArrayBuffer(file);
            } else if (file) {
                alert('Only .docx files are supported.');
                e.target.value = '';
            }
        });

        const techQuestionsUpload = document.getElementById('techQuestionsUpload');
        if (techQuestionsUpload) {
            techQuestionsUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file && file.name.endsWith('.docx')) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        mammoth.extractRawText({arrayBuffer: event.target.result})
                            .then(function(result) {
                                document.getElementById('tech_questions').value = result.value;
                            })
                            .catch(function(err) {
                                alert('Could not read the Word file.');
                            });
                    };
                    reader.readAsArrayBuffer(file);
                } else if (file && file.name.endsWith('.txt')) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('tech_questions').value = event.target.result;
                    };
                    reader.readAsText(file);
                } else if (file) {
                    alert('Only .docx or .txt files are supported.');
                    e.target.value = '';
                }
            });
        }

        // Resume dynamic add/remove logic
        document.getElementById('add-resume-btn').addEventListener('click', function() {
            const container = document.getElementById('resume-inputs');
            const row = document.createElement('div');
            row.className = 'flex items-center mb-2 resume-input-row gap-2';
            const idx = container.querySelectorAll('.resume-input-row').length;
            row.innerHTML = `
              <label class="custom-file-upload">
                <i data-lucide="file-text"></i>
                <span>Choose File</span>
                <input type="file" name="resume" accept=".pdf,.docx" class="resume-file" onchange="document.getElementById('resumeFileName${idx}').textContent = this.files[0]?.name || 'No file chosen'">
              </label>
              <span class="file-name" id="resumeFileName${idx}">No file chosen</span>
              <button type="button" class="ml-2 remove-resume-btn" tabindex="-1"><i data-lucide="trash-2" class="w-5 h-5 text-red-500"></i></button>
            `;
            container.appendChild(row);
            lucide.createIcons();
            updateRemoveButtons();
        });

        function updateRemoveButtons() {
            const rows = document.querySelectorAll('.resume-input-row');
            rows.forEach((row, idx) => {
                const btn = row.querySelector('.remove-resume-btn');
                if (btn) {
                    btn.classList.toggle('hidden', rows.length === 1);
                    btn.onclick = function() {
                        if (rows.length > 1) {
                            row.remove();
                            updateRemoveButtons();
                        }
                    };
                }
            });
        }
        updateRemoveButtons();

        console.log('Calling lucide.createIcons()');
        lucide.createIcons();

        // Render Saved Analyses
        async function renderSavedAnalyses() {
            // Always hide the results modal when viewing saved analyses
            const resultsOverlay = document.getElementById('results-overlay');
            resultsOverlay.classList.add('hidden');
            resultsOverlay.style.display = 'none';
            resultsOverlay.style.visibility = 'hidden';
            const list = document.getElementById('saved_analyses_list');
            list.innerHTML = '<div class="text-gray-400 text-center">Loading...</div>';
            let files = [];
            try {
                const resp = await fetch('/list_saved_analyses');
                files = await resp.json();
            } catch (e) {
                list.innerHTML = '<div class="text-red-500 text-center">Failed to load saved analyses.</div>';
                return;
            }
            if (!files.length) {
                list.innerHTML = '<div class="text-gray-500 text-center">No saved analyses yet.</div>';
                return;
            }
            list.innerHTML = '';
            for (const file of files) {
                // Fetch file content
                let data = null;
                try {
                    const resp = await fetch(`/get_saved_analysis/${file.id}`);
                    data = await resp.json();
                } catch (e) {
                    data = { metaInfo: '', resumeHTML: '<div class="text-red-500">Failed to load file.</div>', audioHTML: '' };
                }
                const div = document.createElement('div');
                div.className = 'bg-white p-4 sm:p-6 rounded-lg shadow-md mb-4 flex flex-col gap-4';
                div.setAttribute('data-card-id', file.id);
                // Resume summary extraction for saved analyses
                let resumeSummary = (data.resumeHTML || (file.data && file.data.resumeHTML)) || '';
                let audioSummary = (data.audioHTML || (file.data && file.data.audioHTML)) || '';
                // Make donut chart canvas IDs unique by including file.id
                resumeSummary = resumeSummary.replace(/id="donutMatch(\d+)"/g, `id="donutMatch_${file.id}_$1"`)
                                           .replace(/id="donutSkills(\d+)"/g, `id="donutSkills_${file.id}_$1"`)
                                           .replace(/id="donutExp(\d+)"/g, `id="donutExp_${file.id}_$1"`)
                                           .replace(/id="donutEdu(\d+)"/g, `id="donutEdu_${file.id}_$1"`)
                                           .replace(/id="donutCert(\d+)"/g, `id="donutCert_${file.id}_$1"`)
                                           .replace(/id="donutRole(\d+)"/g, `id="donutRole_${file.id}_$1"`)
                                           // JRA donut IDs
                                           .replace(/id="donutJRAMatch"/g, `id="donutJRAMatch_${file.id}"`)
                                           .replace(/id="donutJRASkills"/g, `id="donutJRASkills_${file.id}"`)
                                           .replace(/id="donutJRAExp"/g, `id="donutJRAExp_${file.id}"`)
                                           .replace(/id="donutJRAEdu"/g, `id="donutJRAEdu_${file.id}"`)
                                           .replace(/id="donutJRACert"/g, `id="donutJRACert_${file.id}"`)
                                           .replace(/id="donutJRARole"/g, `id="donutJRARole_${file.id}"`);
                // Also for technical tab
                resumeSummary = resumeSummary.replace(/id="donutRelevance"/g, `id="donutRelevance_${file.id}"`)
                                           .replace(/id="donutConfidence"/g, `id="donutConfidence_${file.id}"`)
                                           .replace(/id="donutCommunication"/g, `id="donutCommunication_${file.id}"`)
                                           .replace(/id="donutClarity"/g, `id="donutClarity_${file.id}"`)
                                           .replace(/id="donutProblemSolving"/g, `id="donutProblemSolving_${file.id}"`)
                                           .replace(/id="donutTechnicalKnowledge"/g, `id="donutTechnicalKnowledge_${file.id}"`);
                audioSummary = audioSummary.replace(/id="donutRelevance"/g, `id="donutRelevance_${file.id}"`)
                                         .replace(/id="donutConfidence"/g, `id="donutConfidence_${file.id}"`)
                                         .replace(/id="donutCommunication"/g, `id="donutCommunication_${file.id}"`)
                                         .replace(/id="donutClarity"/g, `id="donutClarity_${file.id}"`)
                                         .replace(/id="donutProblemSolving"/g, `id="donutProblemSolving_${file.id}"`)
                                         .replace(/id="donutTechnicalKnowledge"/g, `id="donutTechnicalKnowledge_${file.id}"`);
                // Add technology and audio filename if present
                let metaInfoBlock = '';
                const meta = file.data || {};
                if ((meta.technology && meta.technology !== '') || (meta.audioFileName && meta.audioFileName !== '')) {
                    metaInfoBlock += '<div class="mb-4 text-sm text-gray-700">';
                    if (meta.technology && meta.technology !== '') {
                        metaInfoBlock += `<span class="block"><strong>Selected Technology:</strong> ${meta.technology}</span>`;
                    }
                    if (meta.audioFileName && meta.audioFileName !== '') {
                        metaInfoBlock += `<span class="block"><strong>Audio File:</strong> ${meta.audioFileName}</span>`;
                    }
                    metaInfoBlock += '</div>';
                }
                div.innerHTML = `
  <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-2 gap-2 sm:gap-0">
    <div class="text-xs text-gray-400">Saved: ${file.timestamp}</div>
    <button type="button" class="text-red-500 text-xs font-semibold" onclick="event.stopPropagation(); deleteSavedAnalysis('${file.id}')">Delete</button>
  </div>
  ${metaInfoBlock}
  <div class="flex flex-col gap-4">
    ${resumeSummary}
    ${audioSummary}
  </div>
`;
                list.appendChild(div);
                if (meta.rawData) {
                    reRenderDonuts(div, meta.rawData, file.id);
                }
            }
        }

        let pendingDeleteFilename = null;
        let wasResultsOverlayOpen = false;
        window.deleteSavedAnalysis = function(filename) {
            pendingDeleteFilename = filename;
            // Set modal title based on active tab
            const deleteModalTitle = document.querySelector('#delete-modal .text-lg');
            if (activeTab === 'shortlisted') {
                deleteModalTitle.textContent = 'Delete this shortlisted analysis?';
            } else {
                deleteModalTitle.textContent = 'Delete this saved analysis?';
            }
            const deleteModal = document.getElementById('delete-modal');
            if (deleteModal) {
              deleteModal.classList.remove('hidden');
            }
            const analyzeBtnContainer = document.getElementById('analyze-btn-container');
            if (analyzeBtnContainer) {
              analyzeBtnContainer.classList.add('hidden');
            }

            const resultsOverlay = document.getElementById('results-overlay');

            if (activeTab === 'saved') {
                wasResultsOverlayOpen = false;
                if (resultsOverlay) {
                  resultsOverlay.classList.add('hidden');
                  resultsOverlay.style.display = 'none';
                  resultsOverlay.style.visibility = 'hidden';
                }
                // Extra defensive: force hide overlay parent as well
                setTimeout(() => {
                  if (resultsOverlay) {
                    resultsOverlay.classList.add('hidden');
                    resultsOverlay.style.display = 'none';
                    resultsOverlay.style.visibility = 'hidden';
                  }
                }, 10);
                return;
            }

            wasResultsOverlayOpen = !resultsOverlay.classList.contains('hidden');
            if (resultsOverlay) {
              resultsOverlay.classList.add('hidden');
              resultsOverlay.style.display = 'none';
              resultsOverlay.style.visibility = 'hidden';
            }
        }

        document.getElementById('delete-modal-cancel').onclick = function() {
            document.getElementById('delete-modal').classList.add('hidden');
            pendingDeleteFilename = null;
            // Always hide results modal when closing delete modal
            const resultsOverlay = document.getElementById('results-overlay');
            resultsOverlay.classList.add('hidden');
            resultsOverlay.style.display = 'none';
            resultsOverlay.style.visibility = 'hidden';
            if (activeTab === 'resume' || activeTab === 'audio') {
                document.getElementById('analyze-btn-container').classList.remove('hidden');
            }
            // Restore results modal if it was open and not on saved tab
            if (activeTab === 'saved') {
                resultsOverlay.classList.add('hidden');
                resultsOverlay.style.display = 'none';
                resultsOverlay.style.visibility = 'hidden';
                wasResultsOverlayOpen = false;
                // Extra defensive: force hide overlay parent as well
                setTimeout(() => {
                    resultsOverlay.classList.add('hidden');
                    resultsOverlay.style.display = 'none';
                    resultsOverlay.style.visibility = 'hidden';
                }, 10);
            } else if (wasResultsOverlayOpen) {
                resultsOverlay.classList.remove('hidden');
                resultsOverlay.style.display = '';
                resultsOverlay.style.visibility = 'visible';
            }
            wasResultsOverlayOpen = false;
        };
        document.getElementById('delete-modal-confirm').onclick = async function() {
            if (!pendingDeleteFilename) return;
            document.getElementById('delete-modal').classList.add('hidden');
            // Always hide results modal when closing delete modal
            const resultsOverlay = document.getElementById('results-overlay');
            resultsOverlay.classList.add('hidden');
            resultsOverlay.style.display = 'none';
            resultsOverlay.style.visibility = 'hidden';
            if (activeTab === 'resume' || activeTab === 'audio') {
                document.getElementById('analyze-btn-container').classList.remove('hidden');
            }
            // Restore results modal if it was open and not on saved tab
            if (activeTab === 'saved') {
                resultsOverlay.classList.add('hidden');
                resultsOverlay.style.display = 'none';
                resultsOverlay.style.visibility = 'hidden';
                wasResultsOverlayOpen = false;
                // Extra defensive: force hide overlay parent as well
                setTimeout(() => {
                    resultsOverlay.classList.add('hidden');
                    resultsOverlay.style.display = 'none';
                    resultsOverlay.style.visibility = 'hidden';
                }, 10);
            } else if (wasResultsOverlayOpen) {
                resultsOverlay.classList.remove('hidden');
                resultsOverlay.style.display = '';
                resultsOverlay.style.visibility = 'visible';
            }
            wasResultsOverlayOpen = false;
            try {
                let deleteUrl = '';
                if (activeTab === 'shortlisted') {
                    deleteUrl = `/delete_shortlisted/${pendingDeleteFilename}`;
                } else {
                    deleteUrl = `/delete_saved_analysis/${pendingDeleteFilename}`;
                }
                await fetch(deleteUrl, { method: 'DELETE' });
                showToast('Deleted successfully.', 'success');
                // Remove the deleted item from the DOM instead of re-rendering everything
                const card = document.querySelector(`[data-card-id="${pendingDeleteFilename}"]`);
                if (card) card.remove();
                const list = (activeTab === 'shortlisted') ? document.getElementById('shortlisted-list') : document.getElementById('saved_analyses_list');
                if (list.children.length === 0) {
                    list.innerHTML = `<div class="text-gray-500 text-center">No ${activeTab === 'shortlisted' ? 'shortlisted resumes' : 'saved analyses'} yet.</div>`;
                }
                // Refresh all relevant UI sections
                if (typeof renderUserRecentActivity === 'function') renderUserRecentActivity();
                if (typeof refreshUserDashboardStats === 'function') refreshUserDashboardStats();
                if (typeof renderSavedAnalyses === 'function') renderSavedAnalyses();
                if (typeof renderShortlistedResumes === 'function') renderShortlistedResumes();
            } catch (e) {
                showToast('Error deleting analysis.', 'error');
            }
            pendingDeleteFilename = null;
        };

        // --- Re-render donuts for saved analyses ---
        function reRenderDonuts(containerElement, rawData, fileId) {
            // Render Technical Proficiency donuts
            const tech = rawData.technical || rawData; // fallback for old saves
            if (tech && tech.technical_score) {
                const techCanvasIds = ['donutRelevance', 'donutConfidence', 'donutCommunication', 'donutClarity', 'donutProblemSolving', 'donutTechnicalKnowledge'];
                const techScores = [
                    (tech.relevance_score || 0) * 10,
                    (tech.confidence_score || 0) * 10,
                    (tech.communication_score || 0) * 10,
                    (tech.clarity_score || 0) * 10,
                    (tech.problem_solving_score || 0) * 10,
                    (tech.depth_score || 0) * 10
                ];
                const techColors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#8b5cf6'];
                techCanvasIds.forEach((id, i) => {
                    const canvas = containerElement.querySelector(`#${id}_${fileId}`);
                    if (canvas) renderDonut(`${id}_${fileId}`, techScores[i], techColors[i]);
                });
            }

            // Render Resume Match donuts
            const resume = rawData.resume || rawData; // fallback for old saves
            if (resume && Array.isArray(resume.resumes)) {
                resume.resumes.forEach((r, idx) => {
                    if (r.error) return;
                    const resumeCanvasIds = [
                        `donutMatch_${fileId}_${idx}`, `donutSkills_${fileId}_${idx}`, `donutExp_${fileId}_${idx}`,
                        `donutEdu_${fileId}_${idx}`, `donutCert_${fileId}_${idx}`, `donutRole_${fileId}_${idx}`
                    ];
                    const skillCoverage = r.total_skills > 0 ? Math.round((r.skills_matched / r.total_skills) * 100) : 0;
                    const resumeScores = [
                        r.match_percentage || 0,
                        skillCoverage,
                        r.experience_match || 0,
                        r.education_match || 0,
                        r.certifications_match || 0,
                        r.role_match || 0
                    ];
                    const resumeColors = ['#2563eb', '#22c55e', '#f59e42', '#a855f7', '#0ea5e9', '#f43f5e'];
                    resumeCanvasIds.forEach((id, i) => {
                        const canvas = containerElement.querySelector(`#${id}`);
                        if (canvas) renderDonut(id, resumeScores[i], resumeColors[i]);
                    });
                });
            }

            // Render Job Requirement Analysis donuts
            if (resume && resume.job_requirement_analysis && !resume.job_requirement_analysis.error) {
                const jra = resume.job_requirement_analysis;
                const skillCoverage = jra.total_skills > 0 ? Math.round((jra.skills_matched / jra.total_skills) * 100) : 0;
                const jraCanvasIds = [
                    `donutJRAMatch_${fileId}`, `donutJRASkills_${fileId}`, `donutJRAExp_${fileId}`,
                    `donutJRAEdu_${fileId}`, `donutJRACert_${fileId}`, `donutJRARole_${fileId}`
                ];
                const jraScores = [
                    jra.match_percentage || 0,
                    skillCoverage,
                    jra.experience_match || 0,
                    jra.education_match || 0,
                    jra.certifications_match || 0,
                    jra.role_match || 0
                ];
                const jraColors = ['#a855f7', '#22d3ee', '#f59e42', '#a855f7', '#0ea5e9', '#f43f5e'];
                jraCanvasIds.forEach((id, i) => {
                    const canvas = containerElement.querySelector(`#${id}`);
                    if (canvas) renderDonut(canvas.id, jraScores[i], jraColors[i]);
                });
            }
        }

        // Toast notification logic
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            let icon = '';
            toast.className = 'fixed top-6 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded shadow-lg text-center text-sm font-semibold opacity-0 pointer-events-none transition-opacity duration-500 flex items-center gap-2'
            if (type === 'success') {
                toast.classList.add('bg-green-600', 'text-white');
                icon = '<i data-lucide="check-circle" class="w-5 h-5 mr-1"></i>';
            } else if (type === 'error') {
                toast.classList.add('bg-red-600', 'text-white');
                if (message.toLowerCase().includes('deleted')) {
                    icon = '<i data-lucide="trash-2" class="w-5 h-5 mr-1"></i>';
                } else {
                    icon = '<i data-lucide="x-circle" class="w-5 h-5 mr-1"></i>';
                }
            } else if (type === 'shortlist' || type === 'warning') {
                toast.classList.add('bg-yellow-500', 'text-white');
                icon = '<i data-lucide="star" class="w-5 h-5 mr-1"></i>';
            } else {
                toast.classList.add('bg-gray-700', 'text-white');
                icon = '<i data-lucide="info" class="w-5 h-5 mr-1"></i>';
            }
            toast.innerHTML = icon + '<span>' + message + '</span>';
            setTimeout(() => { toast.style.opacity = '1'; lucide.createIcons(); }, 10);
            toast.style.opacity = '1';
            setTimeout(() => {
                toast.style.opacity = '0';
            }, 2000);
        }
        
        // Make showToast available globally
        window.showToast = showToast;

        // --- Interview Question Generator Tab Logic ---
        function setTabNavigationEnabled(enabled) {
            const loader = document.getElementById('question-gen-loader');
            const loaderVisible = loader ? !loader.classList.contains('hidden') : false;
            console.log('setTabNavigationEnabled called with:', enabled, '| Loader visible:', loaderVisible);
            // Only allow disabling if loader is visible, otherwise always enable
            if (!enabled && !loaderVisible) {
                // Don't disable tabs if loader is not visible
                enabled = true;
            }
            const tabIds = ['tab-resume', 'tab-audio', 'tab-question-gen', 'tab-saved', 'tab-shortlisted'];
            tabIds.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    // Only disable if not the active tab
                    if (id !== `tab-${activeTab}`) {
                        btn.disabled = !enabled;
                        if (!enabled) {
                            btn.classList.add('opacity-50', 'pointer-events-none');
                        } else {
                            btn.classList.remove('opacity-50', 'pointer-events-none');
                        }
                    } else {
                        // Always keep the active tab enabled and styled
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'pointer-events-none');
                    }
                }
            });
        }
        const generateQuestionsBtn = document.getElementById('generate-questions-btn');
        if (generateQuestionsBtn) {
            generateQuestionsBtn.addEventListener('click', async function() {
                // Validation for Interview Question Generator
                let valid = true;
                const jd = document.getElementById('question_gen_jd').value.trim();
                const numQuestions = parseInt(document.getElementById('num_questions').value, 10) || 5;
                const jdError = document.getElementById('question_gen_jd_error');
                const numQuestionsError = document.getElementById('num_questions_error');
                const level = document.querySelector('input[name="question_level"]:checked').value;
                if (!jd) {
                    jdError.classList.remove('hidden');
                    valid = false;
                } else {
                    jdError.classList.add('hidden');
                }
                if (numQuestions < 1 || numQuestions > 20) {
                    numQuestionsError.classList.remove('hidden');
                    valid = false;
                    numQuestionsError.classList.add('hidden');
                }
                if (!valid) return;
                const loader = document.getElementById('question-gen-loader');
                const resultDiv = document.getElementById('question-gen-result');
                const listPre = document.getElementById('question-gen-list');
                const loaderElem = document.getElementById('question-gen-loader');
                if (loaderElem) loaderElem.classList.remove('hidden');
                resultDiv.classList.add('hidden');
                listPre.textContent = '';
                setTabNavigationEnabled(false); // Disable tabs while loading
                try {
                    const resp = await fetch('/generate_questions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ technology: '', job_description: jd, num_questions: numQuestions, level: level })
                    });
                    const data = await resp.json();
                    const loaderElem = document.getElementById('question-gen-loader');
                    if (loaderElem) loaderElem.classList.add('hidden');
                    setTabNavigationEnabled(true); // Enable tabs after loading
                    if (data.questions && Array.isArray(data.questions)) {
                        listPre.textContent = data.questions.map((q, i) => `${i+1}. ${q}`).join('\n');
                        resultDiv.classList.remove('hidden');
                    } else {
                        showToast(data.error || 'Failed to generate questions.', 'error');
                    }
                } catch (e) {
                    const loaderElem = document.getElementById('question-gen-loader');
                    if (loaderElem) loaderElem.classList.add('hidden');
                    setTabNavigationEnabled(true); // Enable tabs after loading
                    showToast('Error generating questions.', 'error');
                }
            });
        }
        const copyQuestionsBtn = document.getElementById('copy-questions-btn');
        if (copyQuestionsBtn) {
            copyQuestionsBtn.addEventListener('click', function() {
                const listPre = document.getElementById('question-gen-list');
                navigator.clipboard.writeText(listPre.textContent).then(() => {
                    showToast('Questions copied!', 'success');
                });
            });
        }
        const downloadQuestionsBtn = document.getElementById('download-questions-btn');
        if (downloadQuestionsBtn) {
            downloadQuestionsBtn.addEventListener('click', function() {
                const listPre = document.getElementById('question-gen-list');
                const blob = new Blob([listPre.textContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'interview_questions.txt';
                document.body.appendChild(a);
                a.click();
                setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
            });
        }

        // Interview Question Generator JD .docx upload logic
        const questionGenJdUpload = document.getElementById('question_gen_jd_upload');
        if (questionGenJdUpload) {
            questionGenJdUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file && file.name.endsWith('.docx')) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        mammoth.extractRawText({arrayBuffer: event.target.result})
                            .then(function(result) {
                                document.getElementById('question_gen_jd').value = result.value;
                                const el = document.getElementById('question_gen_jd_error');
                                if (el) el.classList.add('hidden');
                            })
                            .catch(function(err) {
                                alert('Could not read the Word file.');
                            });
                    };
                    reader.readAsArrayBuffer(file);
                } else if (file) {
                    alert('Only .docx files are supported.');
                    e.target.value = '';
                }
            });
        }

        // Hide error when user starts typing or selects a file in Interview Question Generator
        /* document.getElementById('question_gen_technology').addEventListener('change', () => {
            if (document.getElementById('question_gen_technology').value) {
                document.getElementById('question_gen_technology_error').classList.add('hidden');
            }
        }); */
        const questionGenJd = document.getElementById('question_gen_jd');
        if (questionGenJd) {
            questionGenJd.addEventListener('input', () => {
                if (questionGenJd.value.trim()) {
                    const el = document.getElementById('question_gen_jd_error');
                    if (el) el.classList.add('hidden');
                }
            });
        }

        // Prevent Enter in num_questions from submitting the form
        const numQuestions = document.getElementById('num_questions');
        if (numQuestions) {
            numQuestions.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                }
            });
        }

        // Live validation for number of questions input
        const numQuestionsInput = document.getElementById('num_questions');
        const numQuestionsError = document.getElementById('num_questions_error');
        if (numQuestionsInput) {
            numQuestionsInput.addEventListener('input', function() {
                const value = parseInt(numQuestionsInput.value, 10);
                if (value < 1 || value > 20) {
                    if (numQuestionsError) numQuestionsError.classList.remove('hidden');
                } else {
                    if (numQuestionsError) numQuestionsError.classList.add('hidden');
                }
            });
        }

        // Donut chart renderer for resume match
        function renderDonut(canvasId, value, color) {
            window.donutCharts = window.donutCharts || {};
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            // Destroy previous chart if exists
            if (window.donutCharts[canvasId]) {
                window.donutCharts[canvasId].destroy();
            }
            window.donutCharts[canvasId] = new Chart(canvas.getContext('2d'), {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [value, 100 - value],
                        backgroundColor: [color, '#e5e7eb'],
                        borderWidth: 0
                    }]
                },
                options: {
                    cutout: '60%',
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    }
                },
                plugins: [{
                    id: 'centerText',
                    afterDraw: chart => {
                        const {ctx, chartArea: {width, height}} = chart;
                        ctx.save();
                        ctx.font = 'bold 1rem Inter, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillStyle = color;
                        ctx.fillText(`${value}%`, width / 2, height / 2);
                        ctx.restore();
                    }
                }]
            });
        }

        // Fetch and display shortlisted resumes in the new tab
        async function renderShortlistedResumes() {
            const list = document.getElementById('shortlisted-list');
            list.innerHTML = '<div class="text-gray-400 text-center">Loading...</div>';
            let files = [];
            try {
                const resp = await fetch('/list_shortlisted');
                files = await resp.json();
            } catch (e) {
                list.innerHTML = '<div class="text-red-500 text-center">Failed to load shortlisted resumes.</div>';
                return;
            }
            if (!files.length) {
                list.innerHTML = '<div class="text-gray-500 text-center">No shortlisted resumes yet.</div>';
                return;
            }
            list.innerHTML = '';
            for (const file of files) {
                let data = null;
                try {
                    const resp = await fetch(`/get_shortlisted/${file.id}`);
                    data = await resp.json();
                } catch (e) {
                    data = { metaInfo: '', resumeHTML: '<div class="text-red-500">Failed to load file.</div>', audioHTML: '' };
                }
                // --- CARD LAYOUT ---
                // Fallbacks for missing data
                const initials = data.initials || (data.original_filename ? data.original_filename.split(' ').map(w => w[0]).join('').substring(0,2).toUpperCase() : 'NA');
                const name = data.name || data.original_filename || 'Candidate Name';
                const title = data.title || 'Job Title';
                const email = data.email || 'candidate@email.com';
                const phone = data.phone || '+1 (555) 123-4567';
                const location = data.location || 'San Francisco, CA';
                const skills = Array.isArray(data.skills) ? data.skills : ['JavaScript', 'SQL'];
                const matchPercent = data.match_percentage || 0;
                const resumeUrl = `/shortlist/${file.id}`;
                const card = document.createElement('div');
                card.className = "bg-white rounded-xl shadow p-4 sm:p-6 mb-4 flex flex-col gap-4";
                card.setAttribute('data-card-id', file.id);
                card.innerHTML = `
  <div class="flex flex-col sm:flex-row items-center sm:items-start gap-4">
    <div class="w-14 h-14 rounded-full flex items-center justify-center text-white font-bold text-xl mx-auto sm:mx-0" style="background: linear-gradient(135deg, #7f5af0 0%, #00c6fb 100%);">
      ${initials}
    </div>
    <div class="flex-1 flex flex-col items-center sm:items-start text-center sm:text-left">
      <div class="font-bold text-lg text-gray-900">${name}</div>
      <div class="text-gray-500 text-sm mb-2">${title}</div>
      <div class="flex flex-col gap-1 text-gray-500 text-sm">
        <span><i data-lucide=\"mail\" class=\"inline w-4 h-4 mr-1\"></i> ${email}</span>
        <span><i data-lucide=\"phone\" class=\"inline w-4 h-4 mr-1\"></i> ${phone}</span>
        <span><i data-lucide=\"map-pin\" class=\"inline w-4 h-4 mr-1\"></i> ${location}</span>
      </div>
    </div>
  </div>
  <div class="flex flex-col gap-2">
    <div class="text-xs text-gray-500 font-semibold">Key Skills</div>
    <div class="flex gap-2 flex-wrap justify-center sm:justify-start">
      ${skills.map(skill => `<span class=\"bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-semibold\">${skill}</span>`).join('')}
    </div>
  </div>
  <div class="flex flex-col gap-2 items-center sm:items-end">
    <div class="flex items-center gap-2 mb-2">
      <span class="flex items-center bg-yellow-50 text-yellow-600 px-3 py-1 rounded-full font-bold text-sm">
        <i data-lucide=\"star\" class=\"inline w-4 h-4 mr-1\"></i> ${matchPercent}%
      </span>
      <button class="delete-shortlist-btn ml-2" data-id="${file.id}" title="Delete">
        <i data-lucide=\"trash-2\" class=\"inline w-5 h-5 text-red-500\"></i>
      </button>
    </div>
    <div class="flex flex-col sm:flex-row gap-2 w-full">
      <button class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded font-semibold w-full sm:w-auto">Schedule Interview</button>
      <a href="${resumeUrl}" target="_blank" class="bg-white border border-gray-300 text-gray-800 px-4 py-2 rounded font-semibold w-full sm:w-auto text-center">View Full Resume</a>
    </div>
  </div>
`;
                list.appendChild(card);
            }
            // Add delete icon event listeners
            list.querySelectorAll('.delete-shortlist-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const id = btn.getAttribute('data-id');
                    pendingDeleteFilename = id;
                    document.getElementById('delete-modal').classList.remove('hidden');
                });
            });
            // Re-render Lucide icons
            if (window.lucide && window.lucide.createIcons) {
                lucide.createIcons();
            }
        }

        // Clear localStorage on logout
        const logoutBtn = document.querySelector('a[href="/logout"], button#logout');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function() {
                localStorage.clear();
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
          const profileBtn = document.getElementById('profile-btn');
          const profileDropdown = document.getElementById('profile-dropdown');
          if (profileBtn && profileDropdown) {
            profileBtn.addEventListener('click', function(e) {
              e.stopPropagation();
              profileDropdown.classList.toggle('hidden');
            });
            document.addEventListener('click', function(e) {
              if (!profileDropdown.classList.contains('hidden')) {
                profileDropdown.classList.add('hidden');
              }
            });
            profileDropdown.addEventListener('click', function(e) {
              e.stopPropagation();
            });
          }
        });

        // Hamburger menu toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileNav = document.getElementById('mobile-nav');
        if (mobileMenuBtn && mobileNav) {
          mobileMenuBtn.addEventListener('click', function() {
            mobileNav.classList.toggle('hidden');
          });
          // Hide menu when clicking outside
          document.addEventListener('click', function(e) {
            if (!mobileNav.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
              mobileNav.classList.add('hidden');
            }
          });
        }
        // Mobile tab switching
        const tabMap = [
          ['tab-dashboard-m', 'tab-dashboard', 'dashboard-tab-content'],
          ['tab-job-upload-m', 'tab-job-upload', 'dashboard-tab-content'],
          ['tab-resume-m', 'tab-resume', 'resume-tab-content'],
          ['tab-audio-m', 'tab-audio', 'audio-tab-content'],
          ['tab-question-gen-m', 'tab-question-gen', 'question-gen-tab-content'],
          ['tab-saved-m', 'tab-saved', 'saved-tab-content'],
          ['tab-shortlisted-m', 'tab-shortlisted', 'shortlisted-tab-content'],
        ];
        tabMap.forEach(([mid, did, cid]) => {
          const mBtn = document.getElementById(mid);
          const dBtn = document.getElementById(did);
          if (mBtn && dBtn) {
            mBtn.addEventListener('click', function() {
              dBtn.click();
              mobileNav.classList.add('hidden');
            });
          }
        });

        // --- Analytics Tab Logic ---
        let analyticsData = null;
        let userData = null;
        let shortlistedBarChart = null;
        let analysesBarChart = null;
        let userPieChart = null;
        let shortlistTrendChart = null;

        function updateSummaryAndCharts(filteredData) {
          // Update summary
          const totalUsers = filteredData.reduce((sum, row) => sum + row.users, 0);
          const totalShortlisted = filteredData.reduce((sum, row) => sum + row.shortlisted, 0);
          const totalAnalyses = filteredData.reduce((sum, row) => sum + row.analyses, 0);
          document.getElementById('summaryTotalUsers').textContent = totalUsers;
          document.getElementById('summaryTotalShortlisted').textContent = totalShortlisted;
          document.getElementById('summaryTotalAnalyses').textContent = totalAnalyses;
          // --- Success Rate ---
          let successRate = 0;
          if (totalAnalyses > 0) {
            successRate = Math.round((totalShortlisted / totalAnalyses) * 100);
          }
          document.getElementById('summarySuccessRate').textContent = successRate + '%';
          document.getElementById('successRateNote').textContent = successRate >= 75 ? 'Above average' : (successRate >= 50 ? 'Average' : 'Below average');

          // Fetch per-user data for TA_TEAM
          fetch('/admin_analytics_users')
            .then(response => response.json())
            .then(users => {
              const taUsers = users.filter(u => u.role === 'TA_TEAM');
              const usernames = taUsers.map(u => u.username);
              const shortlistedCounts = taUsers.map(u => u.shortlisted);
              const analysesCounts = taUsers.map(u => u.analyses);
              // Vertical Bar Chart: Shortlisted by User
              if (shortlistedBarChart) shortlistedBarChart.destroy();
              shortlistedBarChart = new Chart(document.getElementById('shortlistedBarChart').getContext('2d'), {
                type: 'bar',
                data: {
                  labels: usernames,
                  datasets: [{
                    label: 'Resumes Shortlisted',
                    data: shortlistedCounts,
                    backgroundColor: '#6366f1',
                    borderRadius: 8,
                  }]
                },
                options: {
                  plugins: { legend: { display: false } },
                  scales: { y: { beginAtZero: true } }
                }
              });
              // Vertical Bar Chart: Analyses by User
              if (analysesBarChart) analysesBarChart.destroy();
              analysesBarChart = new Chart(document.getElementById('analysesBarChart').getContext('2d'), {
                type: 'bar',
                data: {
                  labels: usernames,
                  datasets: [{
                    label: 'Analyses Saved',
                    data: analysesCounts,
                    backgroundColor: '#10b981',
                    borderRadius: 8,
                  }]
                },
                options: {
                  plugins: { legend: { display: false } },
                  scales: { y: { beginAtZero: true } }
                }
              });
              // Pie Chart: User Distribution (by total activity per user)
              const activityCounts = taUsers.map(u => u.shortlisted + u.analyses);
              if (userPieChart) userPieChart.destroy();
              userPieChart = new Chart(document.getElementById('userPieChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                  labels: usernames,
                  datasets: [{
                    data: activityCounts,
                    backgroundColor: [
                      '#6366f1', '#10b981', '#f59e42', '#f43f5e', '#a855f7', '#0ea5e9', '#f472b6', '#facc15', '#38bdf8', '#34d399', '#f87171', '#a3e635'
                    ],
                    borderWidth: 0
                  }]
                },
                options: {
                  cutout: '60%',
                  plugins: { legend: { position: 'bottom' } }
                }
              });
              // Trend Chart: (simulate with static data for now)
              if (shortlistTrendChart) shortlistTrendChart.destroy();
              shortlistTrendChart = new Chart(document.getElementById('shortlistTrendChart').getContext('2d'), {
                type: 'line',
                data: {
                  labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                  datasets: [{
                    label: 'Shortlisted',
                    data: shortlistedCounts, // Could be improved for real trend
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99,102,241,0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 2
                  }]
                },
                options: {
                  plugins: { legend: { display: false } },
                  scales: { y: { beginAtZero: true } }
                }
              });
            });
        }

        function renderAnalyticsCharts() {
          fetch('/admin_analytics')
            .then(response => response.json())
            .then(data => {
              analyticsData = data.filter(row => row.role === 'TA_TEAM');
              updateSummaryAndCharts(analyticsData);
              renderUserListByRole();
              renderTopUsers();
              renderRecentActivity && renderRecentActivity();
            })
            .catch(() => {
              document.getElementById('userListContainer').innerHTML = '<div class="text-red-500">Failed to load analytics data.</div>';
            });
        }

        function renderTopUsers() {
          fetch('/admin_analytics_users')
            .then(response => response.json())
            .then(users => {
              let filtered = users.filter(u => u.role === 'TA_TEAM');
              filtered.sort((a, b) => (b.shortlisted + b.analyses) - (a.shortlisted + a.analyses));
              const top = filtered.slice(0, 5);
              let html = '';
              if (!top.length) {
                html = '<div class="text-gray-500">No users found for this role.</div>';
              } else {
                top.forEach((u, i) => {
                  html += `<div class="flex items-center justify-between bg-gray-50 rounded-xl px-6 py-4 mb-2">
                    <div class="flex items-center gap-4">
                      <div class="w-10 h-10 flex items-center justify-center rounded-full bg-gradient-to-tr from-blue-400 to-purple-400 text-white font-bold text-lg">${i+1}</div>
                      <div>
                        <div class="font-semibold text-gray-800 text-base">${u.username}</div>
                        <div class="text-gray-400 text-sm">TA_TEAM</div>
                      </div>
                    </div>
                    <div class="text-right">
                      <div class="text-xs text-gray-500">Shortlisted: <span class="text-green-600 font-semibold">${u.shortlisted}</span></div>
                      <div class="text-xs text-gray-500">Analyses: <span class="text-blue-600 font-semibold">${u.analyses}</span></div>
                    </div>
                  </div>`;
                });
              }
              document.getElementById('topUsersContainer').innerHTML = html;
            });
        }

        function renderUserListByRole() {
          fetch('/admin_analytics_users')
            .then(response => response.json())
            .then(users => {
              let filtered = users.filter(u => u.role === 'TA_TEAM');
              if (!filtered.length) {
                document.getElementById('userListContainer').innerHTML = '<div class="text-gray-500">No users found for this role.</div>';
                return;
              }
              let html = `<div class="overflow-x-auto"><table class="min-w-full text-sm border-separate border-spacing-y-1">
                <thead>
                  <tr class="bg-white text-gray-700">
                    <th class="px-6 py-3 text-left font-semibold">Username</th>
                    <th class="px-6 py-3 text-left font-semibold">Role</th>
                    <th class="px-6 py-3 text-left font-semibold">Resumes Shortlisted</th>
                    <th class="px-6 py-3 text-left font-semibold">Analyses Saved</th>
                    <th class="px-6 py-3 text-left font-semibold">Engagement</th>
                  </tr>
                </thead>
                <tbody>`;
              filtered.forEach((u, idx) => {
                const initial = u.username.charAt(0).toUpperCase();
                const rolePill = '<span class="bg-green-100 text-green-600 px-3 py-1 rounded-full text-xs font-semibold">TA_TEAM</span>';
                const perf = (u.shortlisted + u.analyses) > 0 ? Math.round((u.shortlisted / (u.shortlisted + u.analyses)) * 100) : 0;
                const barColor = perf > 70 ? 'bg-green-400' : perf > 40 ? 'bg-blue-400' : 'bg-gray-300';
                html += `<tr class="${idx % 2 === 1 ? 'bg-gray-50' : 'bg-white'} hover:bg-blue-50 transition">
                  <td class="px-6 py-3 flex items-center gap-3 font-semibold text-gray-800">
                    <span class="w-9 h-9 flex items-center justify-center rounded-full bg-gradient-to-tr from-blue-400 to-purple-400 text-white font-bold text-base">${initial}</span>
                    <span>${u.username}</span>
                  </td>
                  <td class="px-6 py-3 align-top">${rolePill}</td>
                  <td class="px-6 py-3 align-top">${u.shortlisted}</td>
                  <td class="px-6 py-3 align-top">${u.analyses}</td>
                  <td class="px-6 py-3 align-top min-w-[160px]">
                    <div class="flex items-center gap-2">
                      <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="h-2 rounded-full ${barColor}" style="width: ${perf}%"></div>
                      </div>
                      <span class="text-xs text-gray-500 font-semibold ml-2">${perf}%</span>
                    </div>
                  </td>
                </tr>`;
              });
              html += '</tbody></table></div>';
              document.getElementById('userListContainer').innerHTML = html;
            })
            .catch(() => {
              document.getElementById('userListContainer').innerHTML = '<div class="text-red-500">Failed to load analytics data.</div>';
            });
        }

        // When analytics tab is clicked, always show TA_TEAM analytics
        const tabAnalytics = document.getElementById('tab-analytics');
        const tabAnalyticsM = document.getElementById('tab-analytics-m');
        const analyticsTabContent = document.getElementById('analytics-tab-content');
        if (tabAnalytics) {
          tabAnalytics.addEventListener('click', () => {
            renderAnalyticsCharts();
            document.querySelectorAll('.tab-content').forEach(div => div.classList.add('hidden'));
            analyticsTabContent.classList.remove('hidden');
            setActiveTab('analytics');
          });
        }
        if (tabAnalyticsM) {
          tabAnalyticsM.addEventListener('click', () => {
            renderAnalyticsCharts();
            document.querySelectorAll('.tab-content').forEach(div => div.classList.add('hidden'));
            analyticsTabContent.classList.remove('hidden');
            setActiveTab('analytics');
          });
        }
        document.getElementById('roleFilter').addEventListener('change', function() {
          const selectedRole = this.value;
          let filtered = analyticsData;
          if (selectedRole !== 'all') filtered = analyticsData.filter(row => row.role === selectedRole);
          updateSummaryAndCharts(filtered);
          renderUserListByRole(selectedRole);
          renderTopUsers(selectedRole);
        });

        const adminTabIds = ['tab-dashboard', 'tab-analytics', 'tab-activity-logs', 'tab-user-management', 'tab-job-requirement-upload'];
        function setAdminActiveTab(tab) {
          // Remove from admin tabs
          const adminTabIds = ['tab-dashboard', 'tab-analytics', 'tab-activity-logs', 'tab-user-management', 'tab-job-requirement-upload', 'tab-question-gen'];
          adminTabIds.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) btn.classList.remove('active-gradient', 'text-blue-700', 'border-blue-600', 'bg-blue-50', 'font-semibold');
          });
          // Remove from user tabs
          tabIds.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) btn.classList.remove('active-gradient', 'text-blue-700', 'border-blue-600', 'bg-blue-50', 'font-semibold');
          });
          // Now set the active one
          const activeBtn = document.getElementById(`tab-${tab}`);
          if (activeBtn) activeBtn.classList.add('active-gradient');
        }

        if (tabDashboard) {
          tabDashboard.addEventListener('click', () => {
            setAdminActiveTab('dashboard');
            // Show dashboard content
            document.querySelectorAll('.tab-content').forEach(div => div.classList.add('hidden'));
            document.getElementById('dashboard-tab-content').classList.remove('hidden');
            setActiveTab('dashboard');
          });
        }
        if (tabAnalytics) {
          tabAnalytics.addEventListener('click', () => {
            setAdminActiveTab('analytics');
            renderAnalyticsCharts();
            document.querySelectorAll('.tab-content').forEach(div => div.classList.add('hidden'));
            analyticsTabContent.classList.remove('hidden');
            setActiveTab('analytics');
          });
        }
        if (tabActivityLogs) {
          tabActivityLogs.addEventListener('click', () => {
            setAdminActiveTab('activity-logs');
            document.querySelectorAll('.tab-content').forEach(div => div.classList.add('hidden'));
            activityLogsTabContent.classList.remove('hidden');
            renderActivityLogs();
          });
        }
        if (tabUserManagement) {
          tabUserManagement.addEventListener('click', () => {
            setAdminActiveTab('user-management');
            document.querySelectorAll('.tab-content').forEach(div => div.classList.add('hidden'));
            userManagementTabContent.classList.remove('hidden');
            renderUserManagement();
          });
        }
        
        // Job Requirement Upload tab
        const tabJobRequirementUpload = document.getElementById('tab-job-requirement-upload');
        if (tabJobRequirementUpload) {
          tabJobRequirementUpload.addEventListener('click', () => {
            setAdminActiveTab('job-requirement-upload');
            document.querySelectorAll('.tab-content').forEach(div => div.classList.add('hidden'));
            document.getElementById('job-requirement-upload-tab-content').classList.remove('hidden');
          });
        }

        // Activity Logs logic
        async function renderActivityLogs() {
          const userSel = document.getElementById('logUserFilter');
          const roleSel = document.getElementById('logRoleFilter');
          const actionSel = document.getElementById('logActionFilter');
          const container = document.getElementById('activityLogsContainer');
          container.innerHTML = '<div class="text-gray-400 text-center py-12">Loading...</div>';
          let url = '/activity_logs?limit=1000';
          let logs = [];
          try {
            const resp = await fetch(url);
            logs = await resp.json();
          } catch (e) {
            container.innerHTML = '<div class="text-red-500 text-center">Failed to load logs.</div>';
            return;
          }
          if (!Array.isArray(logs)) {
            // Handle error response (e.g., 403 Unauthorized)
            container.innerHTML = `<div class='text-red-500 text-center py-12'>${logs.error || 'Unauthorized or failed to load logs.'}</div>`;
            return;
          }
          // Filter client-side
          let filtered = logs;
          if (userSel && userSel.value !== 'all') filtered = filtered.filter(l => l.user_id == userSel.value);
          if (roleSel && roleSel.value !== 'all') filtered = filtered.filter(l => l.role === roleSel.value);
          if (actionSel && actionSel.value !== 'all') filtered = filtered.filter(l => l.action_type === actionSel.value);
          if (!filtered.length) {
            container.innerHTML = '<div class="text-gray-500 text-center py-12">No activity logs found.</div>';
            return;
          }
          // Modern table with zebra striping, sticky header, icons
          let html = `<div class="overflow-x-auto"><table class="min-w-full text-xs md:text-sm border-separate border-spacing-y-1"><thead class="sticky top-0 z-10 bg-white shadow"><tr class="bg-gray-100 text-gray-700">
    <th class="px-3 py-2 text-left font-bold">Time</th>
    <th class="px-3 py-2 text-left font-bold">User</th>
    <th class="px-3 py-2 text-left font-bold">Role</th>
    <th class="px-3 py-2 text-left font-bold">Action</th>
    <th class="px-3 py-2 text-left font-bold">Details</th>
  </tr></thead><tbody>`;
          filtered.forEach((log, i) => {
            const actionIcon = {
              'login': '<i data-lucide="log-in" class="inline w-4 h-4 text-blue-500"></i>',
              'logout': '<i data-lucide="log-out" class="inline w-4 h-4 text-gray-400"></i>',
              'save_analysis': '<i data-lucide="save" class="inline w-4 h-4 text-green-600"></i>',
              'delete_saved_analysis': '<i data-lucide="trash-2" class="inline w-4 h-4 text-red-500"></i>',
              'shortlist_resume': '<i data-lucide="star" class="inline w-4 h-4 text-yellow-500"></i>',
              'delete_shortlisted': '<i data-lucide="trash-2" class="inline w-4 h-4 text-red-400"></i>',
              'register': '<i data-lucide="user-plus" class="inline w-4 h-4 text-purple-500"></i>',
              'admin_add_user': '<i data-lucide="user-plus" class="inline w-4 h-4 text-blue-400"></i>',
              'admin_edit_user': '<i data-lucide="edit" class="inline w-4 h-4 text-blue-400"></i>',
              'admin_delete_user': '<i data-lucide="user-x" class="inline w-4 h-4 text-red-400"></i>',
              'admin_reset_password': '<i data-lucide="key" class="inline w-4 h-4 text-yellow-400"></i>',
              'admin_import_user': '<i data-lucide="upload" class="inline w-4 h-4 text-green-400"></i>',
            }[log.action_type] || '<i data-lucide="activity" class="inline w-4 h-4 text-gray-400"></i>';
            html += `<tr class="${i%2===0?'bg-white':'bg-gray-50'} hover:bg-blue-50 transition">
      <td class="px-3 py-2 align-top whitespace-nowrap">${new Date(log.timestamp).toLocaleString()}</td>
      <td class="px-3 py-2 align-top">${log.username || ''}</td>
      <td class="px-3 py-2 align-top">${log.role || ''}</td>
      <td class="px-3 py-2 align-top">${actionIcon} <span class="ml-1">${log.action_type.replace(/_/g,' ')}</span></td>
      <td class="px-3 py-2 align-top font-mono text-xs text-gray-600">${log.details ? JSON.stringify(log.details) : ''}</td>
    </tr>`;
          });
          html += '</tbody></table></div>';
          container.innerHTML = html;
          if (window.lucide && window.lucide.createIcons) lucide.createIcons();
        }
        // Filters: reload logs on change
        ['logUserFilter','logRoleFilter','logActionFilter'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.addEventListener('change', renderActivityLogs);
        });

        // User Management logic
        async function renderUserManagement() {
          const container = document.getElementById('userManagementContainer');
          container.innerHTML = '<div class="text-gray-400 text-center">Loading...</div>';
          let users = [];
          try {
            const resp = await fetch('/admin_users');
            users = await resp.json();
          } catch (e) {
            container.innerHTML = '<div class="text-red-500 text-center">Failed to load users.</div>';
            updateUserSummaryCards(0, 0, 0, 0);
            return;
          }
          if (!Array.isArray(users) || !users.length) {
            container.innerHTML = '<div class="text-gray-500 text-center">No users found.</div>';
            updateUserSummaryCards(0, 0, 0, 0);
            return;
          }
          // Store users globally for search
          window._allUsers = users;
          // Calculate summary counts
          const total = users.length;
          // If you have an 'active' field, use it. For now, all are active.
          const active = users.filter(u => u.active !== false && u.active !== 0).length;
          const inactive = users.filter(u => u.active === false || u.active === 0).length;
          // If you have a 'pending' field, use it. For now, set to 0.
          const pending = users.filter(u => u.status === 'pending').length || 0;
          updateUserSummaryCards(total, active, inactive, pending);
          function renderTable(filteredUsers) {
            let html = `<table class="min-w-full text-xs border border-gray-200 rounded bg-white"><thead><tr class="bg-gray-100">
              <th class="px-2 py-1 border-b text-left">Username</th>
              <th class="px-2 py-1 border-b text-left">Role</th>
              <th class="px-2 py-1 border-b text-left">Created</th>
              <th class="px-2 py-1 border-b text-left">Actions</th>
            </tr></thead><tbody>`;
            filteredUsers.forEach(u => {
              const initial = u.username.charAt(0).toUpperCase();
              const usernameCell = `<div class=\"flex items-center gap-3\"><span class=\"w-9 h-9 flex items-center justify-center rounded-full bg-gradient-to-tr from-blue-400 to-purple-400 text-white font-bold text-base\">${initial}</span><span>${u.username}</span></div>`;
              html += `<tr>
                <td class=\"px-2 py-1 border-b align-top\">${usernameCell}</td>
                <td class=\"px-2 py-1 border-b align-top\">${u.role}</td>
                <td class=\"px-2 py-1 border-b align-top\">${new Date(u.created_at).toLocaleDateString()}</td>
                <td class=\"px-2 py-1 border-b align-top\">
                  <button class=\"edit-user-btn text-blue-600 mr-2\" data-id=\"${u.id}\" title=\"Edit\">
                    <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"w-5 h-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15.232 5.232l3.536 3.536M9 13l6-6m2 2l-6 6m-2 2h6\" /></svg>
                  </button>
                  <button class=\"delete-user-btn text-red-600\" data-id=\"${u.id}\" title=\"Delete\">
                    <svg xmlns=\"http://www.w3.org/2000/svg\" class=\"w-5 h-5\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\" /></svg>
                  </button>
                </td>
              </tr>`;
            });
            html += '</tbody></table>';
            container.innerHTML = html;
            // Add event listeners for delete
            container.querySelectorAll('.delete-user-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                const userId = btn.getAttribute('data-id');
                const user = filteredUsers.find(u => u.id == userId);
                if (!user) return;
                // ... (rest of your delete logic here)
              });
            });
            // Add event listeners for edit (existing logic)
            container.querySelectorAll('.edit-user-btn').forEach(btn => {
              btn.addEventListener('click', function() {
                const userId = btn.getAttribute('data-id');
                const user = filteredUsers.find(u => u.id == userId);
                if (!user) return;
                document.getElementById('edit-user-username').value = user.username;
                document.getElementById('edit-user-role').value = user.role;
                document.getElementById('edit-user-error').classList.add('hidden');
                document.getElementById('edit-user-modal').classList.remove('hidden');
                document.getElementById('edit-user-form').onsubmit = async function(e) {
                  e.preventDefault();
                  const newUsername = document.getElementById('edit-user-username').value.trim();
                  const newRole = document.getElementById('edit-user-role').value;
                  if (!newUsername || !newRole) {
                    document.getElementById('edit-user-error').textContent = 'All fields are required.';
                    document.getElementById('edit-user-error').classList.remove('hidden');
                    return;
                  }
                  try {
                    const resp = await fetch(`/admin_users/${userId}`, {
                      method: 'PUT',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ username: newUsername, role: newRole })
                    });
                    const data = await resp.json();
                    if (resp.ok && data.status === 'success') {
                      document.getElementById('edit-user-modal').classList.add('hidden');
                      showToast('User updated!', 'success');
                      renderUserManagement();
                    } else {
                      document.getElementById('edit-user-error').textContent = data.error || 'Failed to update user.';
                      document.getElementById('edit-user-error').classList.remove('hidden');
                    }
                  } catch (err) {
                    document.getElementById('edit-user-error').textContent = 'Error updating user.';
                    document.getElementById('edit-user-error').classList.remove('hidden');
                  }
                };
                document.getElementById('edit-user-cancel').onclick = function() {
                  document.getElementById('edit-user-modal').classList.add('hidden');
                };
              });
            });
          }
          // Filtering logic
          function filterFn(u) {
            const q = (document.getElementById('user-search').value || '').toLowerCase();
            return (
              u.username.toLowerCase().includes(q) ||
              u.role.toLowerCase().includes(q)
            );
          }
          renderTable(users.filter(filterFn));
          // Search event
          const searchInput = document.getElementById('user-search');
          if (searchInput) {
            searchInput.oninput = function() {
              renderTable(window._allUsers.filter(filterFn));
            };
          }
        }
        // Add this function for summary cards
        function updateUserSummaryCards(total, active, inactive, pending) {
          document.getElementById('total-users-count').textContent = total;
          document.getElementById('active-users-count').textContent = active;
          document.getElementById('inactive-users-count').textContent = inactive;
          document.getElementById('pending-users-count').textContent = pending;
        }
        // Add User, Import, Export buttons
        const addUserBtn = document.getElementById('addUserBtn');
        const addUserModal = document.getElementById('add-user-modal');
        const addUserForm = document.getElementById('add-user-form');
        const addUserCancel = document.getElementById('add-user-cancel');
        const addUserError = document.getElementById('add-user-error');
        if (addUserBtn) addUserBtn.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          addUserError.classList.add('hidden');
          addUserForm.reset();
          addUserModal.classList.remove('hidden');
        };
        if (addUserCancel) addUserCancel.onclick = () => {
          addUserModal.classList.add('hidden');
        };
        if (addUserForm) addUserForm.onsubmit = async (e) => {
          e.preventDefault();
          e.stopPropagation(); // Prevent bubbling to main form
          addUserError.classList.add('hidden');
          const username = document.getElementById('add-user-username').value.trim();
          const password = document.getElementById('add-user-password').value;
          const role = document.getElementById('add-user-role').value;
          if (!username || !password || !role) {
            addUserError.textContent = 'All fields are required.';
            addUserError.classList.remove('hidden');
            return;
          }
          try {
            // Only call /admin_users, not /process
            const resp = await fetch('/admin_users', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username, password, role })
            });
            const data = await resp.json();
            if (resp.ok && data.status === 'success') {
              addUserModal.classList.add('hidden');
              showToast('User added!', 'success');
              renderUserManagement();
              if (window.refreshAdminDashboardSummary) window.refreshAdminDashboardSummary();
              if (window.refreshAdminRecentActivity) window.refreshAdminRecentActivity();
            } else {
              addUserError.textContent = data.error || 'Failed to add user.';
              addUserError.classList.remove('hidden');
            }
          } catch (err) {
            addUserError.textContent = 'Error adding user.';
            addUserError.classList.remove('hidden');
          }
        };

        // For mobile nav as well
        const adminTabIdsM = ['tab-dashboard-m', 'tab-analytics-m', 'tab-activity-logs-m', 'tab-user-management-m', 'tab-job-requirement-upload-m'];
        function setAdminActiveTabMobile(tab) {
          adminTabIdsM.forEach(id => {
            const btn = document.getElementById(id);
            if (btn) btn.classList.remove('active-gradient');
          });
          const activeBtn = document.getElementById(`tab-${tab}-m`);
          if (activeBtn) activeBtn.classList.add('active-gradient');
        }
        // For mobile nav
        const tabActivityLogsM = document.getElementById('tab-activity-logs-m');
        const tabUserManagementM = document.getElementById('tab-user-management-m');
        const tabDashboardM = document.getElementById('tab-dashboard-m');
        if (tabDashboardM) {
          tabDashboardM.addEventListener('click', () => {
            setAdminActiveTabMobile('dashboard');
            // Show dashboard content
            document.querySelectorAll('.tab-content').forEach(div => div.classList.add('hidden'));
            document.getElementById('dashboard-tab-content').classList.remove('hidden');
            setActiveTab('dashboard');
          });
        }
        if (tabAnalyticsM) {
          tabAnalyticsM.addEventListener('click', () => {
            setAdminActiveTabMobile('analytics');
            // Show analytics content
            document.querySelectorAll('.tab-content').forEach(div => div.classList.add('hidden'));
            analyticsTabContent.classList.remove('hidden');
            setActiveTab('analytics');
          });
        }
        if (tabActivityLogsM) {
          tabActivityLogsM.addEventListener('click', () => {
            setAdminActiveTabMobile('activity-logs');
            // Show activity logs content
            document.querySelectorAll('.tab-content').forEach(div => div.classList.add('hidden'));
            activityLogsTabContent.classList.remove('hidden');
            renderActivityLogs();
          });
        }
        if (tabUserManagementM) {
          tabUserManagementM.addEventListener('click', () => {
            setAdminActiveTabMobile('user-management');
            // Show user management content
            document.querySelectorAll('.tab-content').forEach(div => div.classList.add('hidden'));
            userManagementTabContent.classList.remove('hidden');
            renderUserManagement();
          });
        }
        
        // Job Requirement Upload tab (mobile)
        const tabJobRequirementUploadM = document.getElementById('tab-job-requirement-upload-m');
        if (tabJobRequirementUploadM) {
          tabJobRequirementUploadM.addEventListener('click', () => {
            setAdminActiveTabMobile('job-requirement-upload');
            // Show job requirement upload content
            document.querySelectorAll('.tab-content').forEach(div => div.classList.add('hidden'));
            document.getElementById('job-requirement-upload-tab-content').classList.remove('hidden');
          });
        }

        // --- Activity Logs Filter Population and Modern Table Rendering ---
        async function fetchLogFilterOptions() {
          // Fetch users
          let users = [];
          try {
            const resp = await fetch('/admin_users');
            users = await resp.json();
          } catch {}
          // Fetch all logs (for unique roles/actions)
          let logs = [];
          try {
            const resp = await fetch('/activity_logs?limit=1000');
            logs = await resp.json();
          } catch {}
          // Unique roles and actions
          const roles = Array.from(new Set(logs.map(l => l.role).filter(Boolean)));
          const actions = Array.from(new Set(logs.map(l => l.action_type).filter(Boolean)));
          return { users, roles, actions };
        }

        async function populateLogFilters() {
          const { users, roles, actions: _actions } = await fetchLogFilterOptions();
          const userSel = document.getElementById('logUserFilter');
          const roleSel = document.getElementById('logRoleFilter');
          const actionSel = document.getElementById('logActionFilter');
          if (userSel) {
            userSel.innerHTML = '<option value="all">All Users</option>' + users.map(u => `<option value="${u.id}">${u.username}</option>`).join('');
          }
          if (roleSel) {
            roleSel.innerHTML = '<option value="all">All Roles</option>' + roles.map(r => `<option value="${r}">${r}</option>`).join('');
          }
          if (actionSel) {
            // Hardcoded list of all possible actions
            const allActions = [
              'login',
              'logout',
              'save_analysis',
              'delete_saved_analysis',
              'shortlist_resume',
              'delete_shortlisted',
              'register',
              'admin_add_user',
              'admin_edit_user',
              'admin_delete_user',
              'admin_reset_password',
              'admin_import_user'
            ];
            actionSel.innerHTML = '<option value="all">All Actions</option>' + allActions.map(a => `<option value="${a}">${a.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</option>`).join('');
          }
        }

        async function renderActivityLogs() {
          const userSel = document.getElementById('logUserFilter');
          const roleSel = document.getElementById('logRoleFilter');
          const actionSel = document.getElementById('logActionFilter');
          const container = document.getElementById('activityLogsContainer');
          container.innerHTML = '<div class="text-gray-400 text-center py-12">Loading...</div>';
          let url = '/activity_logs?limit=1000';
          let logs = [];
          try {
            const resp = await fetch(url);
            logs = await resp.json();
          } catch (e) {
            container.innerHTML = '<div class="text-red-500 text-center">Failed to load logs.</div>';
            return;
          }
          if (!Array.isArray(logs)) {
            // Handle error response (e.g., 403 Unauthorized)
            container.innerHTML = `<div class='text-red-500 text-center py-12'>${logs.error || 'Unauthorized or failed to load logs.'}</div>`;
            return;
          }
          // Filter client-side
          let filtered = logs;
          if (userSel && userSel.value !== 'all') filtered = filtered.filter(l => l.user_id == userSel.value);
          if (roleSel && roleSel.value !== 'all') filtered = filtered.filter(l => l.role === roleSel.value);
          if (actionSel && actionSel.value !== 'all') filtered = filtered.filter(l => l.action_type === actionSel.value);
          if (!filtered.length) {
            container.innerHTML = '<div class="text-gray-500 text-center py-12">No activity logs found.</div>';
            return;
          }
          // Modern table with zebra striping, sticky header, icons
          let html = `<div class="overflow-x-auto"><table class="min-w-full text-xs md:text-sm border-separate border-spacing-y-1"><thead class="sticky top-0 z-10 bg-white shadow"><tr class="bg-gray-100 text-gray-700">
    <th class="px-3 py-2 text-left font-bold">Time</th>
    <th class="px-3 py-2 text-left font-bold">User</th>
    <th class="px-3 py-2 text-left font-bold">Role</th>
    <th class="px-3 py-2 text-left font-bold">Action</th>
    <th class="px-3 py-2 text-left font-bold">Details</th>
  </tr></thead><tbody>`;
          filtered.forEach((log, i) => {
            const actionIcon = {
              'login': '<i data-lucide="log-in" class="inline w-4 h-4 text-blue-500"></i>',
              'logout': '<i data-lucide="log-out" class="inline w-4 h-4 text-gray-400"></i>',
              'save_analysis': '<i data-lucide="save" class="inline w-4 h-4 text-green-600"></i>',
              'delete_saved_analysis': '<i data-lucide="trash-2" class="inline w-4 h-4 text-red-500"></i>',
              'shortlist_resume': '<i data-lucide="star" class="inline w-4 h-4 text-yellow-500"></i>',
              'delete_shortlisted': '<i data-lucide="trash-2" class="inline w-4 h-4 text-red-400"></i>',
              'register': '<i data-lucide="user-plus" class="inline w-4 h-4 text-purple-500"></i>',
              'admin_add_user': '<i data-lucide="user-plus" class="inline w-4 h-4 text-blue-400"></i>',
              'admin_edit_user': '<i data-lucide="edit" class="inline w-4 h-4 text-blue-400"></i>',
              'admin_delete_user': '<i data-lucide="user-x" class="inline w-4 h-4 text-red-400"></i>',
              'admin_reset_password': '<i data-lucide="key" class="inline w-4 h-4 text-yellow-400"></i>',
              'admin_import_user': '<i data-lucide="upload" class="inline w-4 h-4 text-green-400"></i>',
            }[log.action_type] || '<i data-lucide="activity" class="inline w-4 h-4 text-gray-400"></i>';
            html += `<tr class="${i%2===0?'bg-white':'bg-gray-50'} hover:bg-blue-50 transition">
      <td class="px-3 py-2 align-top whitespace-nowrap">${new Date(log.timestamp).toLocaleString()}</td>
      <td class="px-3 py-2 align-top">${log.username || ''}</td>
      <td class="px-3 py-2 align-top">${log.role || ''}</td>
      <td class="px-3 py-2 align-top">${actionIcon} <span class="ml-1">${log.action_type.replace(/_/g,' ')}</span></td>
      <td class="px-3 py-2 align-top font-mono text-xs text-gray-600">${log.details ? JSON.stringify(log.details) : ''}</td>
    </tr>`;
          });
          html += '</tbody></table></div>';
          container.innerHTML = html;
          if (window.lucide && window.lucide.createIcons) lucide.createIcons();
        }

        // On tab show, populate filters and render logs
        if (tabActivityLogs) {
          tabActivityLogs.addEventListener('click', async () => {
            setAdminActiveTab('activity-logs');
            document.querySelectorAll('.tab-content').forEach(div => div.classList.add('hidden'));
            activityLogsTabContent.classList.remove('hidden');
            await populateLogFilters();
            renderActivityLogs();
          });
        }
        ['logUserFilter','logRoleFilter','logActionFilter'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.addEventListener('change', renderActivityLogs);
        });

        // --- More Actions Dropdown Logic ---
        document.addEventListener('DOMContentLoaded', function() {
          const logActionFilter = document.getElementById('logActionFilter');
          const moreDropdown = document.getElementById('moreActionsDropdown');
          let lastValue = 'all';
          if (logActionFilter && moreDropdown) {
            logActionFilter.addEventListener('change', function(e) {
              if (this.value === 'more') {
                moreDropdown.classList.remove('hidden');
                this.value = lastValue; // Prevent select from staying on 'more'
              } else {
                moreDropdown.classList.add('hidden');
                lastValue = this.value;
                renderActivityLogs();
              }
            });
            moreDropdown.querySelectorAll('button').forEach(btn => {
              btn.addEventListener('click', function() {
                lastValue = this.getAttribute('data-value');
                logActionFilter.value = 'more';
                moreDropdown.classList.add('hidden');
                window.selectedActionFilter = lastValue;
                renderActivityLogs();
              });
            });
            // Hide dropdown on outside click
            document.addEventListener('click', function(e) {
              if (!moreDropdown.contains(e.target) && e.target !== logActionFilter) {
                moreDropdown.classList.add('hidden');
              }
            });
            // Patch renderActivityLogs to use custom filter
            const origRenderActivityLogs = renderActivityLogs;
            renderActivityLogs = function() {
              const userSel = document.getElementById('logUserFilter');
              const roleSel = document.getElementById('logRoleFilter');
              const container = document.getElementById('activityLogsContainer');
              container.innerHTML = '<div class="text-gray-400 text-center py-12">Loading...</div>';
              let url = '/activity_logs?limit=1000';
              fetch(url).then(resp => resp.json()).then(logs => {
                let filtered = logs;
                if (userSel && userSel.value !== 'all') filtered = filtered.filter(l => l.user_id == userSel.value);
                if (roleSel && roleSel.value !== 'all') filtered = filtered.filter(l => l.role === roleSel.value);
                let actionValue = logActionFilter.value === 'more' ? window.selectedActionFilter : logActionFilter.value;
                if (actionValue && actionValue !== 'all') filtered = filtered.filter(l => l.action_type === actionValue);
                if (!filtered.length) {
                  container.innerHTML = '<div class="text-gray-500 text-center py-12">No activity logs found.</div>';
                  return;
                }
                let html = `<div class="overflow-x-auto"><table class="min-w-full text-xs md:text-sm border-separate border-spacing-y-1"><thead class="sticky top-0 z-10 bg-white shadow"><tr class="bg-gray-100 text-gray-700">
          <th class="px-3 py-2 text-left font-bold">Time</th>
          <th class="px-3 py-2 text-left font-bold">User</th>
          <th class="px-3 py-2 text-left font-bold">Role</th>
          <th class="px-3 py-2 text-left font-bold">Action</th>
          <th class="px-3 py-2 text-left font-bold">Details</th>
        </tr></thead><tbody>`;
                filtered.forEach((log, i) => {
                  const actionIcon = {
                    'login': '<i data-lucide="log-in" class="inline w-4 h-4 text-blue-500"></i>',
                    'logout': '<i data-lucide="log-out" class="inline w-4 h-4 text-gray-400"></i>',
                    'save_analysis': '<i data-lucide="save" class="inline w-4 h-4 text-green-600"></i>',
                    'delete_saved_analysis': '<i data-lucide="trash-2" class="inline w-4 h-4 text-red-500"></i>',
                    'shortlist_resume': '<i data-lucide="star" class="inline w-4 h-4 text-yellow-500"></i>',
                    'delete_shortlisted': '<i data-lucide="trash-2" class="inline w-4 h-4 text-red-400"></i>',
                    'register': '<i data-lucide="user-plus" class="inline w-4 h-4 text-purple-500"></i>',
                    'admin_add_user': '<i data-lucide="user-plus" class="inline w-4 h-4 text-blue-400"></i>',
                    'admin_edit_user': '<i data-lucide="edit" class="inline w-4 h-4 text-blue-400"></i>',
                    'admin_delete_user': '<i data-lucide="user-x" class="inline w-4 h-4 text-red-400"></i>',
                    'admin_reset_password': '<i data-lucide="key" class="inline w-4 h-4 text-yellow-400"></i>',
                    'admin_import_user': '<i data-lucide="upload" class="inline w-4 h-4 text-green-400"></i>',
                  }[log.action_type] || '<i data-lucide="activity" class="inline w-4 h-4 text-gray-400"></i>';
                  html += `<tr class="${i%2===0?'bg-white':'bg-gray-50'} hover:bg-blue-50 transition">
                    <td class="px-3 py-2 align-top whitespace-nowrap">${new Date(log.timestamp).toLocaleString()}</td>
                    <td class="px-3 py-2 align-top">${log.username || ''}</td>
                    <td class="px-3 py-2 align-top">${log.role || ''}</td>
                    <td class="px-3 py-2 align-top">${actionIcon} <span class="ml-1">${log.action_type.replace(/_/g,' ')}</span></td>
                    <td class="px-3 py-2 align-top font-mono text-xs text-gray-600">${log.details ? JSON.stringify(log.details) : ''}</td>
                  </tr>`;
                });
                html += '</tbody></table></div>';
                container.innerHTML = html;
                if (window.lucide && window.lucide.createIcons) lucide.createIcons();
              });
            };
          }
        });

        // --- Recent Activity for Analytics Tab ---
        function renderRecentActivity() {
          fetch('/activity_logs?limit=10')
            .then(response => response.json())
            .then(logs => {
              // Only show TA_TEAM role activity, exclude login/logout
              logs = logs.filter(log => log.role === 'TA_TEAM' && log.action_type !== 'login' && log.action_type !== 'logout');
              let html = '';
              if (!logs.length) {
                html = '<div class="text-gray-500">No recent activity.</div>';
              } else {
                logs.forEach(log => {
                  let icon = '<i class="w-5 h-5 text-blue-400" data-lucide="activity"></i>';
                  let color = 'bg-blue-50';
                  let label = '';
                  if (log.action_type === 'register' || log.action_type === 'admin_add_user') {
                    icon = '<i class="w-5 h-5 text-blue-400" data-lucide="user-plus"></i>';
                    color = 'bg-blue-50';
                    label = 'New user registered';
                  } else if (log.action_type === 'shortlist_resume') {
                    icon = '<i class="w-5 h-5 text-green-400" data-lucide="users"></i>';
                    color = 'bg-green-50';
                    label = 'Resume shortlisted';
                  } else if (log.action_type === 'save_analysis') {
                    icon = '<i class="w-5 h-5 text-purple-400" data-lucide="activity"></i>';
                    color = 'bg-purple-50';
                    label = 'Analysis completed';
                  } else {
                    label = log.action_type.replace(/_/g, ' ');
                  }
                  // Time ago
                  const timeAgo = timeAgoString(log.timestamp);
                  html += `<div class="${color} rounded-lg p-3 flex items-center gap-3">
                    ${icon}
                    <span class="text-gray-700 text-sm">${label}</span>
                    <span class="ml-2 text-xs text-gray-500">(${log.username || ''})</span>
                    <span class="ml-auto text-xs text-gray-400">${timeAgo}</span>
                  </div>`;
                });
              }
              document.getElementById('recentActivityContainer').innerHTML = html;
              if (window.lucide && window.lucide.createIcons) lucide.createIcons();
            });
        }
        // Helper: time ago string
        function timeAgoString(isoDate) {
          const now = new Date();
          const then = new Date(isoDate);
          const diff = Math.floor((now - then) / 1000);
          if (diff < 60) return diff + ' seconds ago';
          if (diff < 3600) return Math.floor(diff / 60) + ' minutes ago';
          if (diff < 86400) return Math.floor(diff / 3600) + ' hours ago';
          return Math.floor(diff / 86400) + ' days ago';
        }

        // Add this function to refresh admin dashboard summary
        function refreshAdminDashboardSummary() {
          fetch('/admin_analytics').then(resp => resp.json()).then(data => {
            let totalUsers = 0, totalShortlisted = 0, totalAnalyses = 0;
            data.forEach(row => {
              totalUsers += row.users;
              totalShortlisted += row.shortlisted;
              totalAnalyses += row.analyses;
            });
            document.getElementById('admin-summary-users').textContent = totalUsers;
            document.getElementById('admin-summary-shortlisted').textContent = totalShortlisted;
            document.getElementById('admin-summary-analyses').textContent = totalAnalyses;
          });
        }

        // --- User Dashboard Stats Refresh Function ---
        function refreshUserDashboardStats() {
          fetch('/user_dashboard_stats').then(resp => resp.json()).then(stats => {
            document.getElementById('dashboard-resumes-analyzed').textContent = stats.resumes_analyzed ?? '0';
            document.getElementById('dashboard-resumes-analyzed-delta').textContent = stats.resumes_analyzed_delta || '+10% from last month';
            document.getElementById('dashboard-skills-assessed').textContent = stats.skills_assessed ?? '0';
            document.getElementById('dashboard-skills-assessed-delta').textContent = stats.skills_assessed_delta || '+7% from last month';
            document.getElementById('dashboard-questions-generated').textContent = stats.questions_generated ?? '0';
            document.getElementById('dashboard-questions-generated-delta').textContent = stats.questions_generated_delta || '+5% from last month';
            document.getElementById('dashboard-shortlisted-candidates').textContent = stats.shortlisted_candidates ?? '0';
            document.getElementById('dashboard-shortlisted-candidates-delta').textContent = stats.shortlisted_candidates_delta || '+6% from last month';
          }).catch(() => {
            [
              'dashboard-resumes-analyzed',
              'dashboard-skills-assessed',
              'dashboard-questions-generated',
              'dashboard-shortlisted-candidates',
            ].forEach(id => {
              const el = document.getElementById(id);
              if (el) el.textContent = '-';
            });
            [
              'dashboard-resumes-analyzed-delta',
              'dashboard-skills-assessed-delta',
              'dashboard-questions-generated-delta',
              'dashboard-shortlisted-candidates-delta',
            ].forEach((id, idx) => {
              const el = document.getElementById(id);
              const staticVals = ['+10% from last month', '+7% from last month', '+5% from last month', '+6% from last month'];
              if (el) el.textContent = staticVals[idx];
            });
          });
        }
        document.addEventListener('DOMContentLoaded', function() {
          refreshUserDashboardStats();
        });
        </script>
        <script>
        // Patch: Refresh user dashboard stats every time dashboard tab is shown
        if (typeof refreshUserDashboardStats === 'function') {
          const tabDashboard = document.getElementById('tab-dashboard');
          if (tabDashboard) {
            tabDashboard.addEventListener('click', function() {
              refreshUserDashboardStats();
            });
          }
          const tabDashboardM = document.getElementById('tab-dashboard-m');
          if (tabDashboardM) {
            tabDashboardM.addEventListener('click', function() {
              refreshUserDashboardStats();
            });
          }
        }
        </script>
    </script>
    <script>
      // Dynamically adjust main content margin-top to match header height
      function adjustMainContentMargin() {
        const header = document.getElementById('fixed-header');
        const main = document.getElementById('main-content');
        if (header && main) {
          main.style.marginTop = header.offsetHeight + 'px';
        }
      }
      window.addEventListener('DOMContentLoaded', adjustMainContentMargin);
      window.addEventListener('resize', adjustMainContentMargin);
    </script>
    <script>
      // Pie Chart: User Activity by Time of Day
      if (window.userRole === 'admin') {
        fetch('/activity_logs?limit=1000')
          .then(response => response.json())
          .then(logs => {
            if (!Array.isArray(logs)) return; // Suppress error if not array
            // Only TA_TEAM users, only shortlist/analysis actions
            const taLogs = logs.filter(l => l.role === 'TA_TEAM' && (l.action_type === 'shortlist_resume' || l.action_type === 'save_analysis'));
            // Group by user and time of day
            const timeBuckets = ['Morning', 'Afternoon', 'Evening', 'Night'];
            function getTimeBucket(dateStr) {
              const hour = new Date(dateStr).getHours();
              if (hour >= 5 && hour < 12) return 'Morning';
              if (hour >= 12 && hour < 17) return 'Afternoon';
              if (hour >= 17 && hour < 21) return 'Evening';
              return 'Night';
            }
            const userMap = {};
            taLogs.forEach(log => {
              if (!userMap[log.username]) userMap[log.username] = { Morning: 0, Afternoon: 0, Evening: 0, Night: 0 };
              const bucket = getTimeBucket(log.timestamp);
              userMap[log.username][bucket]++;
            });
            const usernames = Object.keys(userMap);
            const dataByBucket = timeBuckets.map(bucket => usernames.map(u => userMap[u][bucket]));
            if (userPieChart) userPieChart.destroy();
            userPieChart = new Chart(document.getElementById('userPieChart').getContext('2d'), {
              type: 'bar',
              data: {
                labels: usernames,
                datasets: timeBuckets.map((bucket, i) => ({
                  label: bucket,
                  data: dataByBucket[i],
                  backgroundColor: ['#6366f1', '#10b981', '#f59e42', '#f43f5e'][i],
                  stack: 'activity',
                }))
              },
              options: {
                plugins: { legend: { position: 'bottom' } },
                responsive: true,
                scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }
              }
            });
          });
      }
    </script>
    <script>
      window.userRole = '{{ session.role|default("") }}';
    </script>
    <script>
      // Place this at the top level, before any usage
      function renderAllDonutsWhenReady(resumes) {
          let tries = 0;
          function tryRender() {
              let allReady = resumes.every((r, idx) => document.getElementById(`donutMatch${idx}`));
              if (allReady || tries > 20) {
                  resumes.forEach((r, idx) => {
                      if (!r.error) {
                          const skillCoverage = r.total_skills > 0 ? Math.round((r.skills_matched / r.total_skills) * 100) : 0;
                          renderDonut(`donutMatch${idx}`, r.match_percentage || 0, '#2563eb');
                          renderDonut(`donutSkills${idx}`, skillCoverage, '#22c55e');
                          renderDonut(`donutExp${idx}`, r.experience_match || 0, '#f59e42');
                          renderDonut(`donutEdu${idx}`, r.education_match || 0, '#a855f7');
                          renderDonut(`donutCert${idx}`, r.certifications_match || 0, '#0ea5e9');
                          renderDonut(`donutRole${idx}`, r.role_match || 0, '#f43f5e');
                      }
                  });
              } else {
                  tries++;
                  setTimeout(tryRender, 100);
              }
          }
          tryRender();
      }
    </script>
</body>
</html>